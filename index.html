<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="theme-color" content="#1e5ba8" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="Hakuba Karate" />
        <meta
            name="description"
            content="Hakuba Wado Ryu Karate Learning System - Learn Japanese karate terminology, techniques, and prepare for gradings."
        />
        <title>Hakuba Wado Ryu - Complete Learning System</title>
        <link
            rel="manifest"
            href="data:application/json;base64,ewogICJuYW1lIjogIkhha3ViYSBXYWRvIFJ5dSBLYXJhdGUiLAogICJzaG9ydF9uYW1lIjogIkhha3ViYSBLYXJhdGUiLAogICJkZXNjcmlwdGlvbiI6ICJMZWFybiBKYXBhbmVzZSBrYXJhdGUgdGVybWlub2xvZ3kgYW5kIHRlY2huaXF1ZXMiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y1ZjdmYSIsCiAgInRoZW1lX2NvbG9yIjogIiMxZTViYTgiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBeE9USWdNVGt5SWlCM2FXUjBhRDBpTVRreUlpQm9aV2xuYUhROUlqRTVNaUkrUEhKbFkzUWdkMmxrZEdnOUlqRTVNaUlnYUdWcFoyaDBQU0l4T1RJaUlISjRQU0l4TmlJZ1ptbHNiRDBpSXpGbE5XSmhPQ0l2UGp4MFpYaDBJSGc5SWprMklpQjVQU0k1TmlJZ1ptOXVkQzFtWVcxcGJIazlJa0Z5YVdGc0xITmhibk10YzJWeWFXWWlJR1p2Ym5RdGMybDZaVDBpTkRnaUlHWnBiR3c5SW5kb2FYUmxJaUIwWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsSWo1U2ZEd3ZkR1Y0ZEQ0OEwzTjJaejQ9IiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIgogICAgfQogIF0KfQ=="
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyA7mmQyC0TGumjHVuhfKkh0OP0cQIDOkKU",
                authDomain: "hakuba-karate.firebaseapp.com",
                projectId: "hakuba-karate",
                storageBucket: "hakuba-karate.firebasestorage.app",
                messagingSenderId: "583167798537",
                appId: "1:583167798537:web:f122c343cac3b81f41b7d8",
                measurementId: "G-WHNPCEVHFF",
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            // Enable offline persistence
            db.enablePersistence().catch((err) => {
                console.log("Firestore persistence error:", err.code);
            });
        </script>
        <style>
            :root {
                --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
                --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
                --border-color: #e5e7eb;
                --border-radius: 0.75rem;
                --card-bg: white;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            html,
            body {
                min-height: 100vh;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: #f5f7fa;
                color: #1f2937;
                line-height: 1.8;
                font-size: 18px;
                display: flex;
                flex-direction: column;
            }

            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                font-family:
                    "Outfit",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
            }

            .container {
                max-width: 90%;
                margin: 0 auto;
                padding: 0 2rem;
            }

            header {
                background: #1e5ba8;
                color: white;
                padding: 2.5rem 0;
            }

            /* Next Class Widget */
            .next-class-widget {
                background: linear-gradient(135deg, #059669, #10b981);
                padding: 0.6rem 1rem;
            }

            .next-class-container {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 1.5rem;
                flex-wrap: wrap;
            }

            .next-class-dojo {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .next-class-label {
                color: rgba(255, 255, 255, 0.9);
                font-size: 1rem;
            }

            .next-class-select {
                padding: 0.4rem 0.85rem;
                border-radius: 1rem;
                border: none;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                background: rgba(255, 255, 255, 0.95);
            }

            .next-class-info {
                color: white;
                font-size: 1.1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .next-class-title {
                font-weight: 600;
            }

            .next-class-value {
                opacity: 0.95;
            }

            /* Support Banner */
            .support-banner {
                background: linear-gradient(135deg, #ff5e5b, #ff8584);
                padding: 0.5rem 1rem;
                text-align: center;
            }

            .support-link {
                color: white;
                text-decoration: none;
                font-size: 0.9rem;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .support-text-short {
                display: none;
            }

            .header-content {
                display: flex;
                align-items: center;
                gap: 1.5rem;
            }

            .logo-container {
                flex-shrink: 0;
            }

            .logo-container img {
                height: 120px;
                width: 120px;
                border-radius: 50%;
                border: 3px solid rgba(255, 255, 255, 0.3);
            }

            .header-text {
                flex: 1;
            }

            header h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
                font-weight: 700;
            }

            header p {
                color: #e0e7ff;
                font-size: 1.125rem;
                margin-top: 0.25rem;
            }

            nav {
                background: white;
                border-bottom: 1px solid #e5e7eb;
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .nav-container {
                display: flex;
                flex-wrap: wrap;
                gap: 0.25rem;
            }

            .nav-button {
                padding: 1rem 1.25rem;
                background: none;
                border: none;
                cursor: pointer;
                font-weight: 600;
                font-size: 1rem;
                color: #6b7280;
                border-bottom: 4px solid transparent;
                white-space: nowrap;
                transition: all 0.2s;
            }

            .nav-button:hover {
                color: #1e5ba8;
            }
            .nav-button.active {
                color: #1e5ba8;
                border-bottom-color: #1e5ba8;
            }

            main {
                padding: 3rem 0;
                flex: 1;
            }

            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }

            .card {
                background: transparent;
                padding: 0;
                margin-bottom: 3rem;
            }

            .belt-indicator {
                display: inline-block;
                padding: 0.75rem 2rem;
                border-radius: 0.5rem;
                font-weight: 700;
                font-size: 1.125rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            }

            .card h2 {
                font-size: 2.25rem;
                margin-bottom: 1.5rem;
                font-weight: 700;
                color: #111827;
                text-align: left;
            }

            .card h3 {
                font-size: 1.75rem;
                margin-bottom: 1.25rem;
                margin-top: 2.5rem;
                color: #1e5ba8;
                font-weight: 600;
            }

            .card h4 {
                font-size: 1.375rem;
                margin-bottom: 1rem;
                margin-top: 2rem;
                color: #374151;
                font-weight: 600;
            }

            /* Collapsible sections */
            .collapsible-section {
                margin-bottom: 1.5rem;
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius);
                overflow: hidden;
                background: var(--card-bg);
            }

            .collapsible-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 1rem 1.25rem;
                background: #f9fafb;
                cursor: pointer;
                user-select: none;
                transition: background 0.2s;
            }

            .collapsible-header:hover {
                background: #f1f5f9;
            }

            .collapsible-header h3 {
                margin: 0;
                font-size: 1.5rem;
                color: #1e5ba8;
            }

            .collapsible-toggle {
                font-size: 1.25rem;
                color: #6b7280;
                transition: transform 0.3s ease;
            }

            .collapsible-section.collapsed .collapsible-toggle {
                transform: rotate(-90deg);
            }

            .collapsible-content {
                padding: 1.25rem;
                transition:
                    max-height 0.3s ease,
                    padding 0.3s ease,
                    opacity 0.3s ease;
                max-height: 5000px;
                opacity: 1;
            }

            .collapsible-section.collapsed .collapsible-content {
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                opacity: 0;
                overflow: hidden;
            }

            .card p {
                margin-bottom: 1.25rem;
                color: #4b5563;
                line-height: 1.8;
                text-align: left;
            }

            .sparring-section {
                background: #f9fafb;
                padding: 1.5rem;
                border-radius: 0.75rem;
                margin: 1rem 0;
                border-left: 5px solid #1e5ba8;
            }

            .sparring-section ul {
                list-style: none;
                margin-top: 0.75rem;
            }

            .sparring-section li {
                padding: 0.5rem 0;
                color: #374151;
            }

            .sparring-section .technique-name {
                color: #1e5ba8;
                font-weight: 600;
            }

            .belt-selector {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2.5rem;
            }

            .belt-button {
                padding: 1.25rem 1.5rem;
                border-radius: var(--border-radius);
                border: none;
                cursor: pointer;
                font-weight: 600;
                font-size: 1.125rem;
                transition: all 0.2s;
                text-align: center;
                min-height: 100px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                box-shadow: var(--shadow-md);
                position: relative;
                overflow: hidden;
            }

            .belt-button:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .belt-button.active {
                outline: 3px solid #1e5ba8;
                outline-offset: 2px;
            }

            .belt-button .belt-name {
                font-size: 1.2rem;
                margin-bottom: 0.25rem;
                font-weight: 700;
            }

            .belt-button .belt-color {
                font-size: 0.875rem;
                opacity: 0.9;
            }

            .belt-red {
                background: #dc2626;
                color: white;
            }
            .belt-yellow {
                background: #fbbf24;
                color: #111;
            }
            .belt-orange {
                background: #f97316;
                color: white;
            }
            .belt-green {
                background: #059669;
                color: white;
            }
            .belt-blue {
                background: #2563eb;
                color: white;
            }
            .belt-purple {
                background: #7c3aed;
                color: white;
            }
            .belt-brown {
                background: #92400e;
                color: white;
            }
            .belt-brown-white {
                background: #92400e;
                color: white;
                position: relative;
                padding-bottom: 1.75rem;
            }
            .belt-brown-white::after {
                content: "";
                position: absolute;
                bottom: 10px;
                left: 15%;
                right: 15%;
                height: 5px;
                background: white;
                border-radius: 2px;
            }
            .belt-brown-black {
                background: #92400e;
                color: white;
                position: relative;
                padding-bottom: 1.75rem;
            }
            .belt-brown-black::after {
                content: "";
                position: absolute;
                bottom: 10px;
                left: 15%;
                right: 15%;
                height: 5px;
                background: #000;
                border-radius: 2px;
            }
            .belt-black {
                background: #000;
                color: white;
            }
            .belt-black-1dan {
                background: #000;
                color: white;
                position: relative;
                padding-bottom: 1.75rem;
            }
            .belt-black-1dan::after {
                content: "";
                position: absolute;
                bottom: 10px;
                left: 15%;
                right: 15%;
                height: 5px;
                background: #fbbf24;
                border-radius: 2px;
            }
            .belt-black-2dan {
                background: #000;
                color: white;
                position: relative;
                padding-bottom: 2.5rem;
            }
            .belt-black-2dan::before {
                content: "";
                position: absolute;
                bottom: 10px;
                left: 15%;
                right: 15%;
                height: 5px;
                background: #fbbf24;
                border-radius: 2px;
            }
            .belt-black-2dan::after {
                content: "";
                position: absolute;
                bottom: 23px;
                left: 15%;
                right: 15%;
                height: 5px;
                background: #fbbf24;
                border-radius: 2px;
            }
            .belt-black-3dan {
                background: #000;
                color: white;
                position: relative;
                padding-bottom: 3.25rem;
            }
            .belt-black-3dan::before {
                content: "";
                position: absolute;
                bottom: 10px;
                left: 15%;
                right: 15%;
                height: 5px;
                background: #fbbf24;
                border-radius: 2px;
            }
            .belt-black-3dan::after {
                content: "";
                position: absolute;
                bottom: 23px;
                left: 15%;
                right: 15%;
                height: 5px;
                background: #fbbf24;
                border-radius: 2px;
            }
            .belt-black-3dan .belt-color::before {
                content: "";
                position: absolute;
                bottom: 36px;
                left: 15%;
                right: 15%;
                height: 5px;
                background: #fbbf24;
                border-radius: 2px;
            }

            .technique-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
                gap: 1.5rem;
                margin: 1.5rem 0 2rem 0;
            }

            .technique-card {
                background: var(--card-bg);
                padding: 1.5rem 1.75rem;
                border-radius: var(--border-radius);
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-sm);
                transition: all 0.2s;
                margin-bottom: 0.75rem;
            }

            .technique-card:hover {
                background: #f9fafb;
                box-shadow: var(--shadow-md);
            }

            .technique-card h5 {
                font-size: 1.375rem;
                margin-bottom: 0.75rem;
                color: #111827;
                font-weight: 600;
            }

            .technique-card .japanese {
                color: #1e5ba8;
                font-weight: 600;
                margin-bottom: 0.625rem;
                font-size: 1.25rem;
            }

            .technique-card .english {
                color: #4b5563;
                font-size: 1.125rem;
                line-height: 1.7;
            }

            .technique-card .stance-info {
                font-size: 1rem;
                color: #6b7280;
                margin-top: 1rem;
                font-style: italic;
            }

            .technique-card .stance-info a {
                color: #1e5ba8;
                text-decoration: none;
                font-weight: 500;
            }

            .technique-card .stance-info a:hover {
                text-decoration: underline;
            }

            /* Belt header section with requirements */
            .belt-header-section {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 1.5rem;
            }

            .requirements-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
            }

            .req-label {
                font-size: 0.8rem;
                color: #6b7280;
                font-weight: 500;
            }

            .req-chip {
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                padding: 0.4rem 0.75rem;
                border-radius: 2rem;
                font-size: 0.85rem;
                font-weight: 500;
                background: #f3f4f6;
                color: #374151;
                border: 1px solid #e5e7eb;
                text-decoration: none;
                cursor: pointer;
                transition:
                    transform 0.15s,
                    box-shadow 0.15s;
            }

            .req-chip:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .req-icon {
                font-size: 1rem;
            }

            .req-note {
                background: linear-gradient(135deg, #fef3c7, #fef9c3);
                border-color: #fcd34d;
                color: #92400e;
            }

            .req-dojo {
                background: linear-gradient(135deg, #dbeafe, #eff6ff);
                border-color: #93c5fd;
                color: #1e40af;
            }

            .req-belt {
                background: linear-gradient(135deg, #dcfce7, #f0fdf4);
                border-color: #86efac;
                color: #166534;
            }

            @media (min-width: 768px) {
                .belt-header-section {
                    flex-direction: row;
                    justify-content: space-between;
                    align-items: center;
                }

                .requirements-container {
                    justify-content: flex-end;
                }
            }

            .dojo-kun {
                margin: 2rem 0;
            }

            .dojo-kun-item {
                background: white;
                padding: 1.5rem;
                border-radius: 0.5rem;
                border: 1px solid #e5e7eb;
                margin-bottom: 1rem;
            }

            .dojo-kun-item:last-child {
                margin-bottom: 0;
            }

            .dojo-kun-japanese {
                font-weight: 700;
                color: #1e5ba8;
                margin-bottom: 0.5rem;
                font-size: 1.25rem;
            }

            .dojo-kun-phonetic {
                color: #6b7280;
                font-style: italic;
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            .dojo-kun-english {
                color: #374151;
                font-size: 1.125rem;
                line-height: 1.7;
            }

            .counting-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 1px;
                margin: 2rem 0;
                background: #e5e7eb;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                overflow: hidden;
            }

            .count-card {
                background: white;
                padding: 2rem 1rem;
                text-align: center;
            }

            .count-card:hover {
                background: #f9fafb;
            }

            .count-number {
                font-size: 1.25rem;
                font-weight: 600;
                color: #6b7280;
                margin-bottom: 0.25rem;
            }

            .count-kanji {
                font-size: 3rem;
                color: #1e5ba8;
                margin-bottom: 0.5rem;
                font-weight: 300;
            }

            .count-japanese {
                font-size: 1.25rem;
                font-weight: 600;
                color: #111827;
            }

            .belt-tying-steps {
                margin: 2rem 0;
            }

            .belt-step {
                background: white;
                padding: 1.5rem;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                display: flex;
                gap: 1.25rem;
                align-items: flex-start;
            }

            .belt-step:last-child {
                margin-bottom: 0;
            }

            .belt-step-number {
                font-size: 1.5rem;
                font-weight: 700;
                color: #1e5ba8;
                min-width: 2.5rem;
            }

            .belt-step-text {
                color: #374151;
                font-size: 1.125rem;
                line-height: 1.8;
            }

            .stance-card {
                background: white;
                padding: 1.5rem;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
            }

            .stance-card h5 {
                font-size: 1.5rem;
                font-weight: 600;
                color: #111827;
                margin-bottom: 0.5rem;
            }

            .stance-card .stance-japanese {
                color: #1e5ba8;
                font-weight: 600;
                margin-bottom: 1rem;
                font-size: 1.125rem;
            }

            .stance-card .stance-description {
                color: #374151;
                line-height: 1.8;
                margin-bottom: 0.75rem;
                font-size: 1.125rem;
            }

            .stance-card .stance-usage {
                color: #6b7280;
                font-size: 1rem;
                font-style: italic;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #e5e7eb;
            }

            .btn-primary {
                background: #1e5ba8;
                color: white;
                padding: 1rem 2rem;
                border-radius: 0.625rem;
                text-decoration: none;
                display: inline-block;
                font-weight: 600;
                margin-top: 1.5rem;
                transition: all 0.2s;
                font-size: 1rem;
                border: none;
                cursor: pointer;
            }

            .btn-primary:hover {
                background: #134a8c;
            }

            /* Progress Tracking Styles */
            .belt-progress {
                display: none;
            }

            .belt-progress-fill {
                display: none;
            }

            .technique-card.learned {
                background: #f0fdf4;
                border-color: #86efac;
            }

            .learn-btn {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                border: 1px solid #e5e7eb;
                background: white;
                border-radius: 0.375rem;
                cursor: pointer;
                font-size: 0.875rem;
                color: #6b7280;
                margin-top: 1rem;
                transition: all 0.2s;
            }

            .learn-btn:hover {
                border-color: #1e5ba8;
                color: #1e5ba8;
            }

            .learn-btn.learned {
                background: #059669;
                border-color: #059669;
                color: white;
            }

            /* Progress Dashboard - Mobile First */
            .progress-dashboard {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .dashboard-card {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius);
                padding: 1.25rem;
                box-shadow: var(--shadow-sm);
            }

            .dashboard-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .dashboard-icon {
                font-size: 1.75rem;
                flex-shrink: 0;
            }

            .dashboard-title {
                font-weight: 700;
                font-size: 1.1rem;
                color: #1f2937;
            }

            .dashboard-progress-bar {
                position: relative;
                margin-bottom: 0.75rem;
            }

            .rainbow-bar {
                height: 14px;
                border-radius: 7px;
                overflow: hidden;
                display: flex;
            }

            .progress-marker-new {
                position: absolute;
                top: -4px;
                width: 6px;
                height: 22px;
                background: white;
                border: 2px solid #374151;
                border-radius: 3px;
                transform: translateX(-50%);
                left: 0%;
                transition: left 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .dashboard-stats {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 1rem;
                color: #4b5563;
            }

            .dashboard-belt {
                font-weight: 600;
                color: #1e5ba8;
            }

            /* Grading Dashboard Card */
            .grading-dashboard {
                background: linear-gradient(135deg, #1e5ba8 0%, #7c3aed 100%);
                border: none;
                color: white;
                position: relative;
                overflow: hidden;
            }

            .grading-dashboard::before {
                content: "";
                position: absolute;
                top: -50%;
                right: -20%;
                width: 200px;
                height: 200px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 50%;
            }

            .grading-dashboard .dashboard-header {
                margin-bottom: 0.75rem;
            }

            .grading-dashboard .dashboard-title {
                color: rgba(255, 255, 255, 0.9);
                font-size: 0.9rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .grading-content {
                display: flex;
                align-items: center;
                gap: 1.25rem;
                position: relative;
                z-index: 1;
            }

            .grading-ring {
                position: relative;
                width: 90px;
                height: 90px;
                flex-shrink: 0;
            }

            .grading-ring svg {
                transform: rotate(-90deg);
                width: 90px;
                height: 90px;
            }

            .grading-ring .ring-bg {
                fill: none;
                stroke: rgba(255, 255, 255, 0.2);
                stroke-width: 8;
            }

            .grading-ring .ring-progress {
                fill: none;
                stroke: #fbbf24;
                stroke-width: 8;
                stroke-linecap: round;
                transition: stroke-dashoffset 0.5s ease;
            }

            .grading-ring-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
            }

            .grading-ring-days {
                font-size: 1.75rem;
                font-weight: 800;
                line-height: 1;
                color: white;
            }

            .grading-ring-label {
                font-size: 0.65rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                opacity: 0.9;
            }

            .grading-info {
                flex: 1;
                text-align: left;
            }

            .grading-date-text {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                text-align: left;
            }

            .grading-motivation {
                font-size: 0.95rem;
                opacity: 0.9;
                padding: 0.5rem 0.75rem;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 0.5rem;
                display: inline-block;
            }

            /* Mobile: Stack grading content vertically */
            @media (max-width: 500px) {
                .grading-content {
                    flex-direction: column;
                    text-align: center;
                }

                .grading-info {
                    width: 100%;
                    text-align: center;
                }

                .grading-date-text {
                    text-align: center;
                }

                .grading-motivation {
                    width: 100%;
                    box-sizing: border-box;
                }
            }

            .grading-x-btn {
                position: absolute;
                top: 0.75rem;
                right: 0.75rem;
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1rem;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2;
            }

            .grading-x-btn:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            /* Set Grading Card */
            .grading-set-card {
                background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                border: 2px dashed #cbd5e1;
                text-align: center;
                padding: 1.5rem;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .grading-set-card .dashboard-header {
                justify-content: center;
                width: 100%;
            }

            .grading-prompt {
                font-size: 1rem;
                color: #64748b;
                margin-bottom: 0.75rem;
                text-align: center;
            }

            .grading-input-new {
                width: 100%;
                max-width: 250px;
                padding: 0.75rem 1rem;
                border: 2px solid #cbd5e1;
                border-radius: 0.75rem;
                font-size: 1rem;
                background: white;
                cursor: pointer;
                transition: border-color 0.2s;
                margin: 0 auto;
            }

            .grading-input-new:hover {
                border-color: #94a3b8;
            }

            .grading-input-new:focus {
                outline: none;
                border-color: #1e5ba8;
            }

            /* Desktop: Side by side */
            @media (min-width: 768px) {
                .progress-dashboard {
                    flex-direction: row;
                    align-items: stretch;
                }

                .dashboard-card {
                    flex: 1;
                }
            }

            .progress-summary {
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1.5rem;
                margin-bottom: 2rem;
                display: flex;
                align-items: center;
                gap: 2rem;
            }

            .progress-bar-large {
                flex: 1;
                height: 8px;
                background: #e5e7eb;
                border-radius: 4px;
                overflow: hidden;
            }

            .progress-bar-large-fill {
                height: 100%;
                background: #1e5ba8;
                border-radius: 4px;
                transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .progress-text {
                font-size: 1.125rem;
                font-weight: 600;
                color: #374151;
                min-width: 120px;
            }

            .quiz-container {
                max-width: 800px;
                margin: 0 auto;
            }

            .quiz-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                padding: 1.5rem;
                background: #f9fafb;
                border-radius: 0.75rem;
            }

            .quiz-score {
                font-size: 1.25rem;
                font-weight: 600;
                color: #1e5ba8;
            }

            .quiz-progress {
                font-size: 1rem;
                color: #6b7280;
            }

            .quiz-question-card {
                background: white;
                padding: 3rem;
                border-radius: 0.5rem;
                border: 1px solid #e5e7eb;
                margin-bottom: 2.5rem;
                text-align: center;
            }

            .quiz-question {
                font-size: 3rem;
                font-weight: 700;
                color: #1e5ba8;
                margin-bottom: 1rem;
            }

            .quiz-type {
                font-size: 1rem;
                color: #6b7280;
                margin-bottom: 2rem;
            }

            .quiz-options {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
                margin-top: 2.5rem;
            }

            .quiz-option {
                background: var(--card-bg);
                padding: 1.5rem 1.25rem;
                border-radius: var(--border-radius);
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-sm);
                cursor: pointer;
                transition: all 0.2s;
                font-size: 1.25rem;
                font-weight: 500;
                color: #374151;
            }

            .quiz-option:hover {
                border-color: #1e5ba8;
                background: #f9fafb;
                box-shadow: var(--shadow-md);
                transform: translateY(-2px);
            }

            .quiz-option.correct {
                background: #dcfce7;
                border-color: #16a34a;
                color: #166534;
                animation: pulse-correct 0.4s ease-out;
            }

            .quiz-option.incorrect {
                background: #fee2e2;
                border-color: #dc2626;
                color: #991b1b;
                animation: shake 0.4s ease-out;
            }

            .quiz-option.disabled {
                cursor: not-allowed;
                opacity: 0.6;
            }

            @keyframes pulse-correct {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                    box-shadow: 0 0 20px rgba(22, 163, 74, 0.4);
                }
                100% {
                    transform: scale(1);
                }
            }

            @keyframes shake {
                0%,
                100% {
                    transform: translateX(0);
                }
                20% {
                    transform: translateX(-8px);
                }
                40% {
                    transform: translateX(8px);
                }
                60% {
                    transform: translateX(-6px);
                }
                80% {
                    transform: translateX(6px);
                }
            }

            .quiz-feedback {
                margin-top: 1.5rem;
                padding: 1.25rem;
                border-radius: var(--border-radius);
                font-size: 1.125rem;
                font-weight: 600;
            }

            .quiz-feedback.correct {
                background: #dcfce7;
                color: #166534;
            }

            .quiz-feedback.incorrect {
                background: #fee2e2;
                color: #991b1b;
            }

            .quiz-next-btn {
                margin-top: 1.5rem;
            }

            .quiz-complete {
                text-align: center;
                padding: 3rem;
                font-size: 1.125rem;
            }

            .quiz-complete h3 {
                font-size: 2.5rem;
                margin-bottom: 1.5rem;
                color: #1e5ba8;
            }

            .quiz-complete p {
                font-size: 1.25rem;
                color: #4b5563;
                margin-bottom: 2rem;
                line-height: 1.7;
            }

            .quiz-complete label {
                font-size: 1.25rem;
                font-weight: 600;
                color: #374151;
            }

            .quiz-complete .final-score {
                font-size: 3.5rem;
                font-weight: 700;
                color: #059669;
                margin: 2rem 0;
            }

            .quiz-stats {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
                margin: 2rem 0;
            }

            .quiz-stat {
                background: #f9fafb;
                padding: 1.5rem;
                border-radius: 0.75rem;
                border-left: 5px solid #1e5ba8;
            }

            .quiz-stat-value {
                font-size: 2rem;
                font-weight: 700;
                color: #1e5ba8;
                margin-bottom: 0.5rem;
            }

            .quiz-stat-label {
                font-size: 0.9375rem;
                color: #6b7280;
            }

            footer {
                background: #1f2937;
                color: white;
                padding: 2rem 0;
                text-align: center;
                margin-top: 4rem;
            }

            footer p {
                margin-bottom: 0.75rem;
                line-height: 1.6;
            }

            footer a {
                color: #93c5fd;
                text-decoration: none;
            }

            footer a:hover {
                color: #bfdbfe;
                text-decoration: underline;
            }

            /* Hamburger Menu Styles */
            .hamburger {
                display: none;
                flex-direction: column;
                justify-content: space-around;
                width: 32px;
                height: 26px;
                background: transparent;
                border: none;
                cursor: pointer;
                padding: 0;
                z-index: 200;
                -webkit-tap-highlight-color: transparent;
            }

            .hamburger span {
                display: block;
                width: 32px;
                height: 4px;
                background: #1e5ba8;
                border-radius: 3px;
                transition: all 0.3s ease;
                pointer-events: none;
            }

            .hamburger.active span:nth-child(1) {
                transform: rotate(45deg) translate(6px, 7px);
            }

            .hamburger.active span:nth-child(2) {
                opacity: 0;
            }

            .hamburger.active span:nth-child(3) {
                transform: rotate(-45deg) translate(6px, -7px);
            }

            .nav-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
            }

            .nav-overlay.active {
                display: block;
            }

            .nav-label {
                display: none;
            }

            .nav-close {
                display: none;
            }

            /* MOBILE/TABLET STYLES - Switch to hamburger menu */
            @media screen and (max-width: 1400px) {
                /* Header adjustments */
                header {
                    padding: 1.5rem 0;
                }

                header h1 {
                    font-size: 1.5rem;
                    line-height: 1.3;
                }

                header p {
                    font-size: 0.9375rem;
                }

                .header-content {
                    flex-direction: column;
                    text-align: center;
                    gap: 1rem;
                }

                .logo-container img {
                    height: 80px;
                    width: 80px;
                }

                .container {
                    padding: 0 1rem;
                    max-width: 100%;
                }

                /* Hamburger Navigation */
                .hamburger {
                    display: flex !important;
                }

                nav {
                    position: sticky;
                    top: 0;
                    z-index: 100;
                }

                nav .container {
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                    padding: 0.75rem 1rem !important;
                }

                .nav-container {
                    display: flex !important;
                    position: fixed !important;
                    top: 0 !important;
                    right: -300px !important;
                    width: 280px !important;
                    height: 100vh !important;
                    height: 100dvh !important;
                    background: white !important;
                    flex-direction: column !important;
                    overflow-y: auto !important;
                    overflow-x: hidden !important;
                    z-index: 150 !important;
                    transition: right 0.3s ease !important;
                    padding: 4rem 0 2rem 0 !important;
                    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1) !important;
                    -webkit-overflow-scrolling: touch;
                }

                .nav-container.active {
                    right: 0 !important;
                }

                .nav-button {
                    display: block !important;
                    padding: 1rem 1.5rem !important;
                    text-align: left !important;
                    border-bottom: 1px solid #e5e7eb !important;
                    width: 100% !important;
                    font-size: 1rem !important;
                    white-space: nowrap !important;
                }

                .nav-button.active {
                    background: #eff6ff !important;
                    border-bottom-color: #e5e7eb !important;
                }

                .nav-label {
                    display: block !important;
                    font-weight: 600 !important;
                    color: #1e5ba8 !important;
                    font-size: 1rem !important;
                }

                .nav-close {
                    display: none !important;
                }

                /* Main content */
                main {
                    padding: 1.5rem 0;
                }

                .card {
                    padding: 0;
                }

                .card h2 {
                    font-size: 1.5rem;
                    margin-bottom: 1rem;
                }

                .card h3 {
                    font-size: 1.25rem;
                    margin-top: 1.5rem;
                    margin-bottom: 1rem;
                }

                .card h4 {
                    font-size: 1.125rem;
                }

                .card p {
                    font-size: 1rem;
                    line-height: 1.7;
                }

                /* Belt Selector - stack on mobile */
                .belt-selector {
                    grid-template-columns: 1fr !important;
                    gap: 0.75rem !important;
                }

                .belt-button {
                    min-height: 80px !important;
                    padding: 1rem !important;
                }

                .belt-button .belt-name {
                    font-size: 1rem !important;
                }

                .belt-button .belt-color {
                    font-size: 0.875rem !important;
                }

                /* Fix striped belts on mobile */
                .belt-brown-white,
                .belt-brown-black,
                .belt-black-1dan {
                    padding-bottom: 2rem !important;
                    min-height: 90px !important;
                }
                .belt-black-2dan {
                    padding-bottom: 2.75rem !important;
                    min-height: 100px !important;
                }
                .belt-black-3dan {
                    padding-bottom: 3.5rem !important;
                    min-height: 110px !important;
                }
                .belt-brown-white::after,
                .belt-brown-black::after,
                .belt-black-1dan::after {
                    bottom: 8px !important;
                    height: 4px !important;
                }
                .belt-black-2dan::before {
                    bottom: 8px !important;
                    height: 4px !important;
                }
                .belt-black-2dan::after {
                    bottom: 18px !important;
                    height: 4px !important;
                }
                .belt-black-3dan::before {
                    bottom: 8px !important;
                    height: 4px !important;
                }
                .belt-black-3dan::after {
                    bottom: 18px !important;
                    height: 4px !important;
                }
                .belt-black-3dan .belt-color::before {
                    bottom: 28px !important;
                    height: 4px !important;
                }

                /* Technique Grid - single column on mobile */
                .technique-grid {
                    grid-template-columns: 1fr !important;
                    gap: 1rem !important;
                }

                .technique-card {
                    padding: 1.25rem;
                }

                .technique-card h5 {
                    font-size: 1.125rem;
                }

                .technique-card .japanese {
                    font-size: 1.125rem;
                }

                .technique-card .english {
                    font-size: 1rem;
                }

                /* Counting Grid - 2 columns on mobile */
                .counting-grid {
                    grid-template-columns: repeat(2, 1fr) !important;
                }

                .count-card {
                    padding: 1.25rem 0.75rem;
                }

                .count-kanji {
                    font-size: 2rem;
                }

                .count-japanese {
                    font-size: 1rem;
                }

                .count-number {
                    font-size: 0.875rem;
                }

                /* Quiz styles */
                .quiz-container {
                    padding: 0;
                }

                .quiz-header {
                    flex-direction: column;
                    gap: 1rem;
                    padding: 1rem;
                }

                .quiz-header > div {
                    text-align: center !important;
                }

                .quiz-question-card {
                    padding: 1.5rem 1rem;
                }

                .quiz-question {
                    font-size: 1.75rem;
                    word-break: break-word;
                }

                .quiz-options {
                    grid-template-columns: 1fr !important;
                    gap: 0.75rem !important;
                }

                .quiz-option {
                    padding: 1rem;
                    font-size: 1rem;
                }

                .quiz-stats {
                    grid-template-columns: repeat(2, 1fr) !important;
                    gap: 0.75rem !important;
                }

                .quiz-stat {
                    padding: 1rem;
                }

                .quiz-stat-value {
                    font-size: 1.5rem;
                }

                .quiz-complete h3 {
                    font-size: 1.75rem;
                }

                .quiz-complete .final-score {
                    font-size: 2.5rem;
                }

                #quiz-skip-btn {
                    padding: 0.65rem 1rem;
                    font-size: 0.875rem;
                }

                /* Belt slider in quiz */
                #belt-slider {
                    height: 10px !important;
                }

                #belt-badge {
                    padding: 1rem 1.5rem !important;
                    font-size: 1.25rem !important;
                }

                /* Stances */
                .stance-card {
                    padding: 1.25rem;
                }

                .stance-card h5 {
                    font-size: 1.25rem;
                }

                .stance-card .stance-japanese {
                    font-size: 1rem;
                }

                .stance-card .stance-description {
                    font-size: 1rem;
                }

                /* Dojo Kun */
                .dojo-kun-item {
                    padding: 1.25rem;
                }

                .dojo-kun-japanese {
                    font-size: 1.125rem;
                }

                .dojo-kun-english {
                    font-size: 1rem;
                }

                /* Belt tying steps */
                .belt-step {
                    flex-direction: column;
                    gap: 0.75rem;
                    padding: 1.25rem;
                }

                .belt-step-number {
                    font-size: 1.25rem;
                }

                .belt-step-text {
                    font-size: 1rem;
                }

                /* Info boxes */
                .note-box,
                .info-box {
                    padding: 1.25rem;
                    font-size: 1rem;
                }

                /* Belt indicator */
                .belt-indicator {
                    padding: 0.625rem 1.5rem;
                    font-size: 1rem;
                }

                /* Progress summary */
                .progress-summary {
                    flex-direction: column;
                    gap: 0.75rem;
                    padding: 1.25rem;
                }

                .progress-text {
                    min-width: auto;
                }

                /* Sparring sections */
                .sparring-section {
                    padding: 1.25rem;
                }

                .sparring-section li {
                    font-size: 1rem;
                }

                /* Buttons */
                .btn-primary {
                    width: 100%;
                    text-align: center;
                    padding: 1rem 1.5rem;
                }

                /* Study mode */
                .study-mode-selector {
                    grid-template-columns: 1fr !important;
                }

                .study-mode-card {
                    padding: 1.5rem !important;
                }

                #flashcard {
                    padding: 2rem 1rem !important;
                    min-height: 200px !important;
                }

                #flashcard-term,
                #flashcard-answer {
                    font-size: 1.75rem !important;
                }

                /* Focus mode */
                #focus-terms {
                    grid-template-columns: 1fr !important;
                }

                #focus-categories {
                    grid-template-columns: 1fr !important;
                }

                /* Grading checklist */
                .training-level-box {
                    padding: 1.25rem;
                }

                .training-level-select {
                    grid-template-columns: 1fr !important;
                }

                .level-btn {
                    padding: 0.875rem;
                }

                /* Footer */
                footer {
                    padding: 1.5rem 0;
                    margin-top: 2rem;
                }

                footer p {
                    font-size: 0.9375rem;
                }

                /* Kata videos */
                .kata-videos > div {
                    grid-template-columns: 1fr !important;
                }

                /* Keyboard shortcuts box - hide on mobile */
                .quiz-start div[style*="Keyboard Shortcuts"] {
                    display: none;
                }
            }

            /* Small mobile devices */
            @media (max-width: 480px) {
                header h1 {
                    font-size: 1.25rem;
                }

                .card h2 {
                    font-size: 1.375rem;
                }

                .counting-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .count-kanji {
                    font-size: 1.75rem;
                }

                .quiz-question {
                    font-size: 1.5rem;
                }

                .quiz-complete .final-score {
                    font-size: 2rem;
                }

                .quiz-stats {
                    grid-template-columns: 1fr;
                }

                /* Hide intro card description on mobile */
                .intro-card {
                    margin-bottom: 1.5rem !important;
                }

                .intro-card h2 {
                    margin-bottom: 0 !important;
                    font-size: 1.25rem !important;
                }

                .intro-description {
                    display: none;
                }

                /* Next class widget mobile */
                .next-class-widget {
                    padding: 0.5rem 0.75rem;
                }

                .next-class-container {
                    gap: 0.5rem;
                }

                .next-class-label {
                    font-size: 0.75rem;
                }

                .next-class-select {
                    padding: 0.25rem 0.5rem;
                    font-size: 0.75rem;
                }

                .next-class-info {
                    font-size: 0.8rem;
                    gap: 0.35rem;
                }

                /* Support banner mobile */
                .support-banner {
                    padding: 0.4rem 0.75rem;
                }

                .support-link {
                    font-size: 0.8rem;
                    gap: 0.35rem;
                }

                .support-text {
                    display: none;
                }

                .support-text-short {
                    display: inline;
                }
            }

            /* Tablet adjustments */
            @media (min-width: 769px) and (max-width: 1400px) {
                .belt-selector {
                    grid-template-columns: repeat(2, 1fr) !important;
                }

                .technique-grid {
                    grid-template-columns: repeat(2, 1fr) !important;
                }

                .counting-grid {
                    grid-template-columns: repeat(5, 1fr) !important;
                }

                .quiz-options {
                    grid-template-columns: 1fr 1fr !important;
                }

                .quiz-stats {
                    grid-template-columns: repeat(4, 1fr) !important;
                }

                /* Keep hamburger menu on tablets */
                .hamburger {
                    display: flex !important;
                }

                .nav-container {
                    position: fixed !important;
                    top: 0 !important;
                    right: -300px !important;
                    width: 280px !important;
                    height: 100vh !important;
                    height: 100dvh !important;
                    background: white !important;
                    flex-direction: column !important;
                    overflow-y: auto !important;
                    z-index: 150 !important;
                    transition: right 0.3s ease !important;
                    padding: 4rem 0 2rem 0 !important;
                    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1) !important;
                }

                .nav-container.active {
                    right: 0 !important;
                }

                .nav-button {
                    display: block !important;
                    padding: 1rem 1.5rem !important;
                    text-align: left !important;
                    border-bottom: 1px solid #e5e7eb !important;
                    width: 100% !important;
                }

                .nav-label {
                    display: block !important;
                }

                .nav-close {
                    display: none !important;
                }

                nav .container {
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                }

                /* Header layout for tablet */
                .header-content {
                    flex-direction: row !important;
                    text-align: left !important;
                }

                .logo-container img {
                    height: 100px !important;
                    width: 100px !important;
                }
            }

            .training-level-box {
                background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                border: 2px solid #3b82f6;
                border-radius: 0.75rem;
                padding: 1.5rem;
                margin: 2rem 0;
                text-align: center;
            }

            .training-level-box h3 {
                color: #1e5ba8;
                margin-bottom: 1rem;
                font-size: 1.5rem;
            }

            .training-level-select {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 0.75rem;
                margin-top: 1rem;
            }

            .level-btn {
                padding: 1rem;
                border: 2px solid #bfdbfe;
                border-radius: 0.5rem;
                background: white;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s;
            }

            .level-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .level-btn.active {
                border-color: #1e5ba8;
                box-shadow: 0 4px 12px rgba(30, 91, 168, 0.3);
                transform: scale(1.05);
            }

            .training-info {
                margin-top: 1rem;
                padding: 1rem;
                background: white;
                border-radius: 0.5rem;
                color: #1e5ba8;
                font-weight: 600;
            }

            /* Toast animations */
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }

            /* Auth Modal Styles */
            .auth-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .auth-modal-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            .auth-modal {
                background: white;
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                transform: translateY(20px);
                transition: transform 0.3s ease;
            }

            .auth-modal-overlay.active .auth-modal {
                transform: translateY(0);
            }

            .auth-modal h2 {
                text-align: center;
                margin-bottom: 0.5rem;
                color: #1e5ba8;
            }

            .auth-modal-subtitle {
                text-align: center;
                color: #6b7280;
                font-size: 0.9rem;
                margin-bottom: 1.5rem;
            }

            .auth-input-group {
                margin-bottom: 1rem;
            }

            .auth-input-group label {
                display: block;
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: #374151;
                font-size: 0.9rem;
            }

            .auth-input-group input {
                width: 100%;
                padding: 0.75rem 1rem;
                border: 2px solid #e5e7eb;
                border-radius: 0.5rem;
                font-size: 1rem;
                transition: border-color 0.2s;
            }

            .auth-input-group input:focus {
                outline: none;
                border-color: #1e5ba8;
            }

            .auth-btn {
                width: 100%;
                padding: 0.875rem;
                border: none;
                border-radius: 0.5rem;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                margin-top: 0.5rem;
            }

            .auth-btn-primary {
                background: #1e5ba8;
                color: white;
            }

            .auth-btn-primary:hover {
                background: #164a8a;
            }

            .auth-btn-primary:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }

            .auth-btn-secondary {
                background: #f3f4f6;
                color: #374151;
                margin-top: 0.75rem;
            }

            .auth-btn-secondary:hover {
                background: #e5e7eb;
            }

            .auth-toggle {
                text-align: center;
                margin-top: 1.25rem;
                font-size: 0.9rem;
                color: #6b7280;
            }

            .auth-toggle a {
                color: #1e5ba8;
                text-decoration: none;
                font-weight: 600;
                cursor: pointer;
            }

            .auth-toggle a:hover {
                text-decoration: underline;
            }

            .auth-error {
                background: #fef2f2;
                color: #dc2626;
                padding: 0.75rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                margin-bottom: 1rem;
                display: none;
            }

            .auth-error.show {
                display: block;
            }

            .auth-divider {
                display: flex;
                align-items: center;
                margin: 1.25rem 0;
                color: #9ca3af;
                font-size: 0.875rem;
            }

            .auth-divider::before,
            .auth-divider::after {
                content: "";
                flex: 1;
                height: 1px;
                background: #e5e7eb;
            }

            .auth-divider::before {
                margin-right: 1rem;
            }

            .auth-divider::after {
                margin-left: 1rem;
            }

            /* User Menu Styles */
            .user-menu {
                position: relative;
                margin-left: auto;
            }

            .user-menu-btn {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                background: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s;
            }

            .user-menu-btn:hover {
                background: rgba(255, 255, 255, 0.25);
            }

            .user-menu-btn svg {
                width: 20px;
                height: 20px;
            }

            /* Mobile user menu - position below header text */
            @media screen and (max-width: 1400px) {
                .user-menu {
                    margin-left: 0;
                    margin-top: 0.75rem;
                }

                .user-menu-btn {
                    padding: 0.5rem 1.25rem;
                    font-size: 0.875rem;
                }

                .user-menu-dropdown {
                    left: 50%;
                    right: auto;
                    transform: translateX(-50%) translateY(-10px);
                }

                .user-menu-dropdown.show {
                    transform: translateX(-50%) translateY(0);
                }
            }

            .user-menu-dropdown {
                position: absolute;
                top: 100%;
                right: 0;
                margin-top: 0.5rem;
                background: white;
                border-radius: 0.5rem;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                min-width: 200px;
                opacity: 0;
                visibility: hidden;
                transform: translateY(-10px);
                transition: all 0.2s;
                z-index: 1000;
            }

            .user-menu-dropdown.show {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }

            .user-menu-dropdown-item {
                display: block;
                width: 100%;
                padding: 0.75rem 1rem;
                border: none;
                background: none;
                text-align: left;
                cursor: pointer;
                color: #374151;
                font-size: 0.9rem;
                transition: background 0.2s;
            }

            .user-menu-dropdown-item:first-child {
                border-radius: 0.5rem 0.5rem 0 0;
            }

            .user-menu-dropdown-item:last-child {
                border-radius: 0 0 0.5rem 0.5rem;
            }

            .user-menu-dropdown-item:hover {
                background: #f3f4f6;
            }

            .user-menu-dropdown-item.danger {
                color: #dc2626;
            }

            .user-email {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid #e5e7eb;
                font-size: 0.85rem;
                color: #6b7280;
                word-break: break-all;
            }

            .sync-indicator {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.8);
                margin-left: 0.5rem;
            }

            .sync-indicator.syncing {
                color: #fbbf24;
            }

            .sync-indicator.synced {
                color: #34d399;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .sync-indicator.syncing svg {
                animation: spin 1s linear infinite;
            }

            @keyframes xpSlideIn {
                from {
                    transform: translateX(100px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes levelUpPop {
                from {
                    transform: scale(0.5);
                    opacity: 0;
                }
                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            /* XP Bar Styles */
            .xp-container {
                background: linear-gradient(135deg, #ede9fe, #e0e7ff);
                border-radius: 1rem;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .xp-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
            }

            .xp-level {
                font-size: 1.5rem;
                font-weight: 700;
                color: #8b5cf6;
            }

            .xp-text {
                font-size: 0.9rem;
                color: #6b7280;
            }

            .xp-bar {
                height: 12px;
                background: rgba(255, 255, 255, 0.5);
                border-radius: 6px;
                overflow: hidden;
            }

            .xp-bar-fill {
                height: 100%;
                background: linear-gradient(90deg, #8b5cf6, #6366f1);
                border-radius: 6px;
                transition: width 0.5s ease;
                position: relative;
                overflow: hidden;
            }

            .xp-bar-fill::after {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.3),
                    transparent
                );
                animation: shimmer 2s infinite;
            }

            @keyframes shimmer {
                0% {
                    left: -100%;
                }
                100% {
                    left: 100%;
                }
            }

            body.dark-mode .xp-container {
                background: linear-gradient(135deg, #4c1d95, #312e81);
            }

            body.dark-mode .xp-bar {
                background: rgba(0, 0, 0, 0.3);
            }

            body.dark-mode .xp-text {
                color: #c4b5fd;
            }

            body.dark-mode .xp-level {
                color: #c4b5fd;
            }

            /* Dark mode auth styles */
            body.dark-mode .auth-modal {
                background: #1f2937;
            }

            body.dark-mode .auth-modal h2 {
                color: #60a5fa;
            }

            body.dark-mode .auth-modal-subtitle {
                color: #9ca3af;
            }

            body.dark-mode .auth-input-group label {
                color: #d1d5db;
            }

            body.dark-mode .auth-input-group input {
                background: #374151;
                border-color: #4b5563;
                color: white;
            }

            body.dark-mode .auth-input-group input:focus {
                border-color: #60a5fa;
            }

            body.dark-mode .auth-btn-secondary {
                background: #374151;
                color: #d1d5db;
            }

            body.dark-mode .auth-btn-secondary:hover {
                background: #4b5563;
            }

            body.dark-mode .auth-error {
                background: #7f1d1d;
                color: #fecaca;
            }

            body.dark-mode .user-menu-dropdown {
                background: #1f2937;
            }

            body.dark-mode .user-menu-dropdown-item {
                color: #d1d5db;
            }

            body.dark-mode .user-menu-dropdown-item:hover {
                background: #374151;
            }

            body.dark-mode .user-email {
                color: #9ca3af;
                border-color: #374151;
            }
        </style>
    </head>
    <body>
        <!-- Auth Modal -->
        <div class="auth-modal-overlay" id="auth-modal">
            <div class="auth-modal">
                <h2 id="auth-modal-title">Sign In</h2>
                <p class="auth-modal-subtitle">Sync your progress across all devices</p>

                <div class="auth-error" id="auth-error"></div>

                <form id="auth-form" onsubmit="handleAuthSubmit(event)">
                    <div class="auth-input-group">
                        <label for="auth-email">Email</label>
                        <input type="email" id="auth-email" required placeholder="your@email.com" />
                    </div>

                    <div class="auth-input-group">
                        <label for="auth-password">Password</label>
                        <input
                            type="password"
                            id="auth-password"
                            required
                            placeholder="At least 6 characters"
                            minlength="6"
                        />
                    </div>

                    <div class="auth-input-group" id="auth-confirm-group" style="display: none">
                        <label for="auth-confirm">Confirm Password</label>
                        <input
                            type="password"
                            id="auth-confirm"
                            placeholder="Confirm your password"
                            minlength="6"
                        />
                    </div>

                    <button type="submit" class="auth-btn auth-btn-primary" id="auth-submit-btn">
                        Sign In
                    </button>
                </form>

                <div class="auth-divider">or</div>

                <button class="auth-btn auth-btn-secondary" onclick="continueAsGuest()">
                    Continue as Guest
                </button>

                <div class="auth-toggle" id="auth-toggle">
                    Don't have an account? <a onclick="toggleAuthMode()">Sign up</a>
                </div>
            </div>
        </div>

        <!-- Support Banner - At very top -->
        <div class="support-banner">
            <a href="https://ko-fi.com/torncheesecake" target="_blank" class="support-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604 0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407 0 0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311z"
                    />
                </svg>
                <span class="support-text">Enjoying the app? Support its development!</span>
                <span class="support-text-short">Support the app!</span>
            </a>
        </div>

        <!-- Next Class Widget -->
        <div id="next-class-widget" class="next-class-widget">
            <div class="container next-class-container">
                <div class="next-class-dojo">
                    <span class="next-class-label">My dojo:</span>
                    <select
                        id="home-dojo-select"
                        onchange="setHomeDojo(this.value)"
                        class="next-class-select"
                    >
                        <option value="swindon">Swindon</option>
                        <option value="mevagissey">Mevagissey</option>
                    </select>
                </div>
                <div class="next-class-info">
                    <span class="next-class-title">Next class:</span>
                    <span id="next-class-display" class="next-class-value">Loading...</span>
                </div>
            </div>
        </div>

        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo-container">
                        <a
                            href="#"
                            onclick="
                                goHome();
                                return false;
                            "
                            title="Go to Belt Syllabus"
                        >
                            <img
                                src="https://hakuba-karate.co.uk/wp-content/uploads/2018/09/logo-trans-300x295.png"
                                alt="Hakuba Karate Logo"
                            />
                        </a>
                    </div>
                    <div class="header-text">
                        <h1>Hakuba Wado Ryu</h1>
                        <p style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem">
                            The Path to Progress
                        </p>
                        <p>Traditional Wadoryu Atemi Jujutsu Karate - Swindon & Mevagissey</p>
                        <p
                            style="
                                font-size: 0.875rem;
                                opacity: 0.9;
                                margin-top: 0.5rem;
                                background: rgba(255, 255, 255, 0.2);
                                display: inline-block;
                                padding: 0.25rem 0.75rem;
                                border-radius: 4px;
                            "
                        >
                            v1.4.4
                        </p>
                    </div>

                    <!-- User Menu -->
                    <div class="user-menu" id="user-menu">
                        <!-- Logged out state -->
                        <button class="user-menu-btn" id="sign-in-btn" onclick="showAuthModal()">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Sign In
                        </button>

                        <!-- Logged in state (hidden by default) -->
                        <button
                            class="user-menu-btn"
                            id="user-menu-btn"
                            style="display: none"
                            onclick="toggleUserMenu()"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span id="user-display-name">User</span>
                            <span class="sync-indicator" id="sync-indicator" style="display: none">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="12"
                                    height="12"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"
                                    ></path>
                                    <path d="M21 3v5h-5"></path>
                                </svg>
                            </span>
                        </button>

                        <div class="user-menu-dropdown" id="user-menu-dropdown">
                            <div class="user-email" id="user-email-display"></div>
                            <button class="user-menu-dropdown-item danger" onclick="handleLogout()">
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="nav-overlay" id="nav-overlay" onclick="toggleMobileMenu()"></div>
        <nav>
            <div class="container">
                <span class="nav-label">Menu</span>
                <button
                    class="hamburger"
                    id="hamburger"
                    onclick="toggleMobileMenu()"
                    aria-label="Toggle navigation menu"
                >
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="nav-container" id="nav-container">
                    <button class="nav-close" onclick="closeMobileMenu()" aria-label="Close menu">
                        &times;
                    </button>
                    <button class="nav-button active" data-tab="belts">Belt Syllabus</button>
                    <button class="nav-button" data-tab="stances">Stances</button>
                    <button class="nav-button" data-tab="quiz">Practice Quiz</button>
                    <button class="nav-button" data-tab="belt-tying">Belt Tying</button>
                    <button class="nav-button" data-tab="counting">Counting</button>
                    <button class="nav-button" data-tab="dojo-kun">Dojo Kun</button>
                    <button class="nav-button" data-tab="terminology">Terminology</button>
                    <button class="nav-button" data-tab="study">Study Mode</button>
                    <button class="nav-button" data-tab="grading">Grading Checklist</button>
                    <button class="nav-button" data-tab="achievements">Achievements</button>
                    <button class="nav-button" data-tab="calendar">Calendar</button>
                    <button class="nav-button" data-tab="search">Search</button>
                </div>
            </div>
        </nav>

        <main>
            <div class="container">
                <!-- Belt Syllabus Tab -->
                <div id="belts-tab" class="tab-content active">
                    <div class="card intro-card">
                        <h2>Select Your Belt Level</h2>
                        <p class="intro-description">
                            Click on your current belt to see the complete syllabus and techniques
                            you need to learn for your next grading.
                        </p>
                    </div>

                    <!-- Progress Dashboard -->
                    <div class="progress-dashboard">
                        <!-- Journey Progress Card -->
                        <div class="dashboard-card" id="overall-progress">
                            <div class="dashboard-header">
                                <span class="dashboard-icon"></span>
                                <span class="dashboard-title">Your Karate Journey</span>
                            </div>
                            <div class="dashboard-progress-bar">
                                <div id="rainbow-progress-bar" class="rainbow-bar"></div>
                                <div id="progress-marker" class="progress-marker-new"></div>
                            </div>
                            <div class="dashboard-stats">
                                <span id="overall-progress-text">0 / 0 techniques learned</span>
                                <span id="current-belt-label" class="dashboard-belt"></span>
                            </div>
                        </div>

                        <!-- Grading Countdown Card -->
                        <div
                            class="dashboard-card grading-dashboard"
                            id="grading-countdown-container"
                            style="display: none"
                        >
                            <button
                                onclick="clearGradingDate()"
                                class="grading-x-btn"
                                title="Clear"
                            >
                                
                            </button>
                            <div class="dashboard-header">
                                <span class="dashboard-icon"></span>
                                <span class="dashboard-title">Next Grading</span>
                            </div>
                            <div class="grading-content">
                                <div class="grading-ring">
                                    <svg viewBox="0 0 100 100">
                                        <circle class="ring-bg" cx="50" cy="50" r="42"></circle>
                                        <circle
                                            class="ring-progress"
                                            id="grading-ring-progress"
                                            cx="50"
                                            cy="50"
                                            r="42"
                                            stroke-dasharray="264"
                                            stroke-dashoffset="0"
                                        ></circle>
                                    </svg>
                                    <div class="grading-ring-text">
                                        <div class="grading-ring-days" id="grading-days-count">
                                            0
                                        </div>
                                        <div class="grading-ring-label">days</div>
                                    </div>
                                </div>
                                <div class="grading-info">
                                    <div class="grading-date-text" id="grading-date-display"></div>
                                    <div class="grading-motivation" id="grading-message"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Set Grading Date Card -->
                        <div
                            class="dashboard-card grading-set-card"
                            id="grading-set-container"
                            style="display: none"
                        >
                            <div class="dashboard-header">
                                <span class="dashboard-icon"></span>
                                <span class="dashboard-title">Next Grading</span>
                            </div>
                            <div class="grading-prompt">When's your next grading?</div>
                            <input
                                type="date"
                                id="grading-date-input"
                                class="grading-input-new"
                                onchange="setGradingDate(this.value)"
                            />
                        </div>
                    </div>

                    <div class="belt-selector" id="belt-selector"></div>

                    <div id="belt-content"></div>
                </div>

                <!-- Stances Tab -->
                <div id="stances-tab" class="tab-content">
                    <div class="card">
                        <h2>Wado Ryu Stances Explained</h2>
                        <p>
                            Understanding stances is essential for performing techniques correctly.
                            Here are the key stances used in the Hakuba syllabus.
                        </p>

                        <div class="stance-card">
                            <h5>Junzuki-dachi</h5>
                            <div class="stance-japanese"> - Front Punch Stance</div>
                            <div class="stance-description">
                                <strong>Simple English:</strong> Forward fighting stance with the
                                same side forward.<br /><br />
                                <strong>Details:</strong> Front foot points straight forward, back
                                foot at about 22.5 degrees. Front knee bent over ankle, back leg
                                relatively straight. Weight distributed 50/50 between both feet.
                                This is shorter and more natural than the deep Shotokan stances.
                                Used when performing blocks and same-side techniques.
                            </div>
                            <div class="stance-usage">
                                Used for: Blocks (jodan-uke, chudan-soto-uke, chudan-uchi-uke,
                                gedan-barai)
                            </div>
                        </div>

                        <div class="stance-card">
                            <h5>Hanmi-gamae</h5>
                            <div class="stance-japanese"> - Half-Body Fighting Stance</div>
                            <div class="stance-description">
                                <strong>Simple English:</strong> Natural fighting stance, ready
                                position.<br /><br />
                                <strong>Details:</strong> A relaxed, natural fighting stance with
                                your body turned at an angle (hanmi means "half body"). Feet are
                                positioned naturally, knees slightly bent, weight balanced. Hands up
                                in guard position. This is your "ready to go" stance - mobile and
                                prepared to attack or defend.
                            </div>
                            <div class="stance-usage">
                                Used for: Strikes, kicks, and all dynamic techniques (punches, front
                                kicks, roundhouse kicks)
                            </div>
                        </div>

                        <div class="stance-card">
                            <h5>Gyakuzuki-dachi</h5>
                            <div class="stance-japanese"> - Reverse Punch Stance</div>
                            <div class="stance-description">
                                <strong>Simple English:</strong> Forward stance with opposite side
                                forward.<br /><br />
                                <strong>Details:</strong> Similar to Junzuki-dachi but used when
                                performing reverse punch (opposite hand to forward leg). Front foot
                                points slightly inward. This stance helps generate power from hip
                                rotation for the reverse punch.
                            </div>
                            <div class="stance-usage">Used for: Reverse punches (gyakuzuki)</div>
                        </div>

                        <div class="info-box">
                            <strong>Key Difference:</strong> Junzuki-dachi is used when you punch
                            with the same side as your forward leg (left leg forward, left punch).
                            Hanmi-gamae is your natural fighting stance where you're ready to do
                            anything. Think of Junzuki-dachi as your "blocking stance" and
                            Hanmi-gamae as your "ready to attack stance".
                        </div>
                    </div>
                </div>

                <!-- Practice Quiz Tab -->
                <div id="quiz-tab" class="tab-content">
                    <div class="card">
                        <h2>Practice Quiz</h2>
                        <p>
                            Test your knowledge of Japanese karate terminology! Select the correct
                            English translation for each term.
                        </p>

                        <div class="quiz-container">
                            <div id="quiz-start" class="quiz-complete">
                                <h3>Ready to Practice?</h3>
                                <p style="color: #6b7280; margin-bottom: 2rem">
                                    Test your knowledge of Japanese karate terminology! Select your
                                    current belt level to get appropriate questions.
                                </p>

                                <div style="max-width: 700px; margin: 0 auto 2rem auto">
                                    <label
                                        style="
                                            display: block;
                                            font-weight: 600;
                                            margin-bottom: 1rem;
                                            color: #374151;
                                            text-align: center;
                                            font-size: 1.375rem;
                                        "
                                        >Select Your Current Belt Level:</label
                                    >
                                    <p
                                        style="
                                            text-align: center;
                                            color: #4b5563;
                                            font-size: 1.125rem;
                                            margin-bottom: 1.5rem;
                                        "
                                    >
                                        Quiz will test you on everything up to and including this
                                        belt
                                    </p>

                                    <div style="position: relative; margin-bottom: 2rem">
                                        <input
                                            type="range"
                                            id="belt-slider"
                                            min="0"
                                            max="11"
                                            value="1"
                                            step="1"
                                            style="
                                                width: 100%;
                                                height: 8px;
                                                border-radius: 4px;
                                                background: linear-gradient(
                                                    to right,
                                                    #dc2626 0%,
                                                    #fbbf24 20%,
                                                    #f97316 30%,
                                                    #059669 40%,
                                                    #2563eb 50%,
                                                    #7c3aed 60%,
                                                    #92400e 100%
                                                );
                                                outline: none;
                                                -webkit-appearance: none;
                                                appearance: none;
                                                cursor: pointer;
                                            "
                                            oninput="updateBeltDisplay()"
                                        />
                                    </div>

                                    <div
                                        id="selected-belt-display"
                                        style="text-align: center; margin-bottom: 1rem"
                                    >
                                        <div
                                            style="
                                                display: inline-block;
                                                padding: 1.25rem 2.5rem;
                                                border-radius: 0.75rem;
                                                font-weight: 700;
                                                font-size: 1.5rem;
                                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                                            "
                                            id="belt-badge"
                                        >
                                            8th Ky - Yellow Belt
                                        </div>
                                    </div>

                                    <div
                                        id="included-belts"
                                        style="
                                            text-align: center;
                                            font-size: 1.125rem;
                                            color: #4b5563;
                                            margin-bottom: 1rem;
                                        "
                                    >
                                        Testing: Red, Yellow
                                    </div>

                                    <div
                                        id="question-count"
                                        style="
                                            text-align: center;
                                            font-size: 1.125rem;
                                            color: #059669;
                                            font-weight: 600;
                                        "
                                    >
                                        ~25 available questions
                                    </div>
                                </div>

                                <style>
                                    #belt-slider::-webkit-slider-thumb {
                                        -webkit-appearance: none;
                                        appearance: none;
                                        width: 24px;
                                        height: 24px;
                                        border-radius: 50%;
                                        background: white;
                                        border: 3px solid #dc2626;
                                        cursor: pointer;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                                    }
                                    #belt-slider::-moz-range-thumb {
                                        width: 24px;
                                        height: 24px;
                                        border-radius: 50%;
                                        background: white;
                                        border: 3px solid #dc2626;
                                        cursor: pointer;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                                    }
                                    #belt-badge.belt-red {
                                        background: #dc2626;
                                        color: white;
                                    }
                                    #belt-badge.belt-yellow {
                                        background: #fbbf24;
                                        color: #111;
                                    }
                                    #belt-badge.belt-orange {
                                        background: #f97316;
                                        color: white;
                                    }
                                    #belt-badge.belt-green {
                                        background: #059669;
                                        color: white;
                                    }
                                    #belt-badge.belt-blue {
                                        background: #2563eb;
                                        color: white;
                                    }
                                    #belt-badge.belt-purple {
                                        background: #7c3aed;
                                        color: white;
                                    }
                                    #belt-badge.belt-brown {
                                        background: #92400e;
                                        color: white;
                                    }
                                    #belt-badge.belt-brown-white {
                                        background: linear-gradient(
                                            to bottom,
                                            #92400e 0%,
                                            #92400e 40%,
                                            white 40%,
                                            white 50%,
                                            #92400e 50%,
                                            #92400e 100%
                                        );
                                        color: white;
                                    }
                                    #belt-badge.belt-brown-black {
                                        background: linear-gradient(
                                            to bottom,
                                            #92400e 0%,
                                            #92400e 40%,
                                            #000 40%,
                                            #000 50%,
                                            #92400e 50%,
                                            #92400e 100%
                                        );
                                        color: white;
                                    }
                                    #belt-badge.belt-black-1dan {
                                        background: linear-gradient(
                                            to bottom,
                                            #000 0%,
                                            #000 15%,
                                            #fbbf24 15%,
                                            #fbbf24 20%,
                                            #000 20%,
                                            #000 100%
                                        );
                                        color: white;
                                    }
                                    #belt-badge.belt-black-2dan {
                                        background: linear-gradient(
                                            to bottom,
                                            #000 0%,
                                            #000 12%,
                                            #fbbf24 12%,
                                            #fbbf24 17%,
                                            #000 17%,
                                            #000 22%,
                                            #fbbf24 22%,
                                            #fbbf24 27%,
                                            #000 27%,
                                            #000 100%
                                        );
                                        color: white;
                                    }
                                    #belt-badge.belt-black-3dan {
                                        background: linear-gradient(
                                            to bottom,
                                            #000 0%,
                                            #000 10%,
                                            #fbbf24 10%,
                                            #fbbf24 14%,
                                            #000 14%,
                                            #000 18%,
                                            #fbbf24 18%,
                                            #fbbf24 22%,
                                            #000 22%,
                                            #000 26%,
                                            #fbbf24 26%,
                                            #fbbf24 30%,
                                            #000 30%,
                                            #000 100%
                                        );
                                        color: white;
                                    }

                                    .training-level-box {
                                        background: linear-gradient(
                                            135deg,
                                            #eff6ff 0%,
                                            #dbeafe 100%
                                        );
                                        border: 2px solid #3b82f6;
                                        border-radius: 0.75rem;
                                        padding: 1.5rem;
                                        margin: 2rem 0;
                                        text-align: center;
                                    }

                                    .training-level-box h3 {
                                        color: #1e5ba8;
                                        margin-bottom: 1rem;
                                        font-size: 1.5rem;
                                    }

                                    .training-level-select {
                                        display: grid;
                                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                                        gap: 0.75rem;
                                        margin-top: 1rem;
                                    }

                                    .level-btn {
                                        padding: 1rem;
                                        border: 2px solid #bfdbfe;
                                        border-radius: 0.5rem;
                                        background: white;
                                        cursor: pointer;
                                        font-weight: 600;
                                        transition: all 0.2s;
                                    }

                                    .level-btn:hover {
                                        transform: translateY(-2px);
                                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                                    }

                                    .level-btn.active {
                                        border-color: #1e5ba8;
                                        box-shadow: 0 4px 12px rgba(30, 91, 168, 0.3);
                                        transform: scale(1.05);
                                    }

                                    .training-info {
                                        margin-top: 1rem;
                                        padding: 1rem;
                                        background: white;
                                        border-radius: 0.5rem;
                                        color: #1e5ba8;
                                        font-weight: 600;
                                    }
                                </style>

                                <div
                                    style="
                                        background: #f9fafb;
                                        padding: 1.75rem;
                                        border-radius: 0.75rem;
                                        max-width: 550px;
                                        margin: 0 auto 2rem auto;
                                        border-left: 6px solid #2563eb;
                                    "
                                >
                                    <div
                                        style="
                                            font-weight: 600;
                                            color: #111827;
                                            margin-bottom: 1rem;
                                            font-size: 1.25rem;
                                        "
                                    >
                                        Keyboard Shortcuts:
                                    </div>
                                    <div
                                        style="
                                            font-size: 1.125rem;
                                            color: #4b5563;
                                            line-height: 1.8;
                                        "
                                    >
                                        <strong>1-4</strong> = Select answer<br />
                                        <strong>S</strong> = Skip question<br />
                                        <strong>Enter</strong> = Next question<br />
                                        <strong>Esc</strong> = Exit quiz
                                    </div>
                                </div>

                                <div
                                    style="
                                        display: flex;
                                        gap: 1rem;
                                        justify-content: center;
                                        flex-wrap: wrap;
                                    "
                                >
                                    <button onclick="startQuiz()" class="btn-primary">
                                        Start Quiz
                                    </button>
                                    <button
                                        onclick="startDailyChallenge()"
                                        class="btn-primary"
                                        id="daily-challenge-btn"
                                        style="
                                            background: linear-gradient(135deg, #8b5cf6, #6366f1);
                                        "
                                    >
                                        Daily Challenge
                                        <span
                                            id="daily-challenge-status"
                                            style="
                                                display: block;
                                                font-size: 0.75rem;
                                                opacity: 0.9;
                                                margin-top: 0.25rem;
                                            "
                                        ></span>
                                    </button>
                                    <button
                                        onclick="startWeakSpotsQuiz()"
                                        class="btn-primary"
                                        id="weak-spots-btn"
                                        style="
                                            background: linear-gradient(135deg, #f59e0b, #d97706);
                                            display: none;
                                        "
                                    >
                                        Practice Weak Spots
                                        <span
                                            id="weak-spots-count"
                                            style="
                                                display: block;
                                                font-size: 0.75rem;
                                                opacity: 0.9;
                                                margin-top: 0.25rem;
                                            "
                                        ></span>
                                    </button>
                                </div>
                            </div>

                            <div id="quiz-active" style="display: none">
                                <div class="quiz-header">
                                    <div>
                                        <div class="quiz-score">
                                            Score: <span id="quiz-score">0</span>
                                        </div>
                                        <div class="quiz-progress">
                                            Question <span id="quiz-current">1</span> of
                                            <span id="quiz-total">10</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right">
                                        <div
                                            id="quiz-difficulty-display"
                                            style="
                                                font-size: 0.875rem;
                                                color: #6b7280;
                                                margin-bottom: 0.5rem;
                                            "
                                        ></div>
                                        <button
                                            onclick="exitQuiz()"
                                            style="
                                                background: #6b7280;
                                                color: white;
                                                border: none;
                                                padding: 0.5rem 1rem;
                                                border-radius: 0.5rem;
                                                cursor: pointer;
                                                font-size: 0.875rem;
                                                font-weight: 500;
                                                transition: all 0.2s;
                                            "
                                            onmouseover="this.style.background = '#4b5563'"
                                            onmouseout="this.style.background = '#6b7280'"
                                        >
                                            Exit Quiz
                                        </button>
                                    </div>
                                </div>

                                <div
                                    class="quiz-progress-bar"
                                    style="
                                        background: #e5e7eb;
                                        height: 8px;
                                        border-radius: 4px;
                                        margin-bottom: 2rem;
                                        overflow: hidden;
                                    "
                                >
                                    <div
                                        id="quiz-progress-fill"
                                        style="
                                            background: #dc2626;
                                            height: 100%;
                                            width: 0%;
                                            transition: width 0.3s;
                                        "
                                    ></div>
                                </div>

                                <div class="quiz-question-card">
                                    <div class="quiz-type" id="quiz-category"></div>
                                    <div class="quiz-question" id="quiz-question"></div>
                                    <p style="color: #6b7280; margin-top: 0.5rem">
                                        What does this mean in English?
                                    </p>

                                    <div class="quiz-options" id="quiz-options"></div>

                                    <div id="quiz-feedback" style="display: none"></div>
                                    <div
                                        style="
                                            display: flex;
                                            gap: 1rem;
                                            justify-content: center;
                                            margin-top: 1.5rem;
                                            flex-wrap: wrap;
                                        "
                                    >
                                        <button
                                            id="quiz-skip-btn"
                                            onclick="skipQuestion()"
                                            style="
                                                background: #6b7280;
                                                padding: 0.75rem 1.5rem;
                                                border-radius: 0.625rem;
                                                color: white;
                                                border: none;
                                                cursor: pointer;
                                                font-size: 0.9375rem;
                                                font-weight: 500;
                                                transition: all 0.2s;
                                            "
                                            onmouseover="this.style.background = '#4b5563'"
                                            onmouseout="this.style.background = '#6b7280'"
                                        >
                                            Skip (Press S)
                                        </button>
                                        <button
                                            id="quiz-next-btn"
                                            onclick="nextQuestion()"
                                            class="btn-primary"
                                            style="display: none; margin-top: 0"
                                        >
                                            Next Question (Press Enter) 
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="quiz-complete" class="quiz-complete" style="display: none">
                                <h3>Quiz Complete! </h3>
                                <div class="final-score"><span id="final-score">0</span>%</div>
                                <p style="color: #6b7280; margin-bottom: 2rem">
                                    Great work practising your Japanese terminology!
                                </p>

                                <div class="quiz-stats">
                                    <div class="quiz-stat">
                                        <div class="quiz-stat-value" id="correct-count">0</div>
                                        <div class="quiz-stat-label">Correct</div>
                                    </div>
                                    <div class="quiz-stat">
                                        <div class="quiz-stat-value" id="incorrect-count">0</div>
                                        <div class="quiz-stat-label">Incorrect</div>
                                    </div>
                                    <div class="quiz-stat">
                                        <div class="quiz-stat-value" id="skipped-count">0</div>
                                        <div class="quiz-stat-label">Skipped</div>
                                    </div>
                                    <div class="quiz-stat">
                                        <div class="quiz-stat-value" id="total-count">10</div>
                                        <div class="quiz-stat-label">Total</div>
                                    </div>
                                </div>

                                <div
                                    id="category-breakdown"
                                    style="
                                        background: #f9fafb;
                                        padding: 1.5rem;
                                        border-radius: 0.75rem;
                                        margin: 2rem 0;
                                        text-align: left;
                                    "
                                ></div>

                                <div
                                    style="
                                        display: flex;
                                        flex-wrap: wrap;
                                        gap: 1rem;
                                        justify-content: center;
                                    "
                                >
                                    <button
                                        onclick="startQuiz()"
                                        class="btn-primary"
                                        style="width: auto"
                                    >
                                        Try Again
                                    </button>
                                    <button
                                        onclick="exitQuiz()"
                                        style="background: #6b7280; width: auto"
                                        class="btn-primary"
                                    >
                                        Change Level
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Belt Tying Tab -->
                <div id="belt-tying-tab" class="tab-content">
                    <div class="card">
                        <h2>Hon-Musubi () - Traditional Wado Ryu Belt Tying</h2>

                        <p>
                            Hon-Musubi is the traditional Wado Ryu method of tying your belt (obi),
                            as taught by Hironori Ohtsuka. This technique is tested at 9th and 8th
                            Ky gradings and should become second nature.
                        </p>

                        <div class="info-box">
                            <strong>Important:</strong> The way you tie your belt demonstrates
                            discipline, respect, and attention to detail - core values of Wado Ryu
                            karate. Take time to learn this properly.
                        </div>

                        <h3>Step-by-Step Instructions</h3>

                        <div class="belt-tying-steps">
                            <div class="belt-step">
                                <div class="belt-step-number">Step 1: Find the Centre</div>
                                <div class="belt-step-text">
                                    Fold your belt in half to find the middle point. Hold this
                                    centre point against your abdomen, around belly button height.
                                </div>
                            </div>

                            <div class="belt-step">
                                <div class="belt-step-number">Step 2: Wrap Around</div>
                                <div class="belt-step-text">
                                    Wrap both ends of the belt around your waist to the back,
                                    keeping the belt flat against your body. The ends should be
                                    roughly equal length when they meet at the back.
                                </div>
                            </div>

                            <div class="belt-step">
                                <div class="belt-step-number">Step 3: Bring to Front</div>
                                <div class="belt-step-text">
                                    Bring both ends back to the front. Cross the right end over the
                                    left end in front of your body.
                                </div>
                            </div>

                            <div class="belt-step">
                                <div class="belt-step-number">Step 4: Tuck Under</div>
                                <div class="belt-step-text">
                                    Take the right end and tuck it under BOTH layers of the belt
                                    (between your gi and the belt), pulling it up through the
                                    centre. This is the key step that distinguishes Hon-Musubi.
                                </div>
                            </div>

                            <div class="belt-step">
                                <div class="belt-step-number">Step 5: Create the Knot</div>
                                <div class="belt-step-text">
                                    Now take the top end (that you just pulled through) and place it
                                    over the bottom end, forming a loop. Thread the top end through
                                    this loop from above.
                                </div>
                            </div>

                            <div class="belt-step">
                                <div class="belt-step-number">Step 6: Tighten</div>
                                <div class="belt-step-text">
                                    Pull both ends evenly to tighten the knot. The knot should sit
                                    flat and square against your abdomen. Both ends should hang down
                                    evenly, roughly the same length.
                                </div>
                            </div>
                        </div>

                        <div class="note-box">
                            <strong>Practice Tip:</strong> The finished knot should be a square knot
                            (koma-musubi) that sits flat and neat. Both ends should hang at roughly
                            the same length. Practice this daily until it becomes automatic!
                        </div>
                    </div>
                </div>

                <!-- Counting Tab -->
                <div id="counting-tab" class="tab-content">
                    <div class="card">
                        <h2>Japanese Counting (1-10)</h2>
                        <p>
                            Essential numbers used in training, gradings, and kata. You'll hear
                            these constantly in the dojo, so memorise them early!
                        </p>

                        <div class="counting-grid">
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Ichi / Ipponme</div>
                                <div class="count-number">1 / 1st</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Ni / Nihonme</div>
                                <div class="count-number">2 / 2nd</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">San / Sanbonme</div>
                                <div class="count-number">3 / 3rd</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Shi / Yonhonme</div>
                                <div class="count-number">4 / 4th</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Go / Gohonme</div>
                                <div class="count-number">5 / 5th</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Roku / Ropponme</div>
                                <div class="count-number">6 / 6th</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Shichi / Nanahonme</div>
                                <div class="count-number">7 / 7th</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Hachi / Napponme</div>
                                <div class="count-number">8 / 8th</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Ky</div>
                                <div class="count-number">9</div>
                            </div>
                            <div class="count-card">
                                <div class="count-kanji"></div>
                                <div class="count-japanese">Jy</div>
                                <div class="count-number">10</div>
                            </div>
                        </div>

                        <div class="info-box">
                            <strong>Note:</strong> The ordinal numbers (1st, 2nd, 3rd, etc.) are
                            used in sparring sequences. For example, "Ipponme" means "the first
                            technique", "Gohonme" means "the fifth technique".
                        </div>
                    </div>
                </div>

                <!-- Dojo Kun Tab -->
                <div id="dojo-kun-tab" class="tab-content">
                    <div class="card">
                        <h2>Dojo Kun ()</h2>
                        <p>
                            The five principles of the dojo - recited in Japanese and English at ALL
                            gradings. These represent the philosophical foundation of your training.
                        </p>

                        <div class="dojo-kun">
                            <div class="dojo-kun-item">
                                <div class="dojo-kun-japanese">REISETSU-O-MAMORI</div>
                                <div class="dojo-kun-phonetic">Ray-sets-o ma-mory</div>
                                <div class="dojo-kun-english">Stick to the rules of the Dojo.</div>
                            </div>
                            <div class="dojo-kun-item">
                                <div class="dojo-kun-japanese">SHINGI-O-OMANJI</div>
                                <div class="dojo-kun-phonetic">Shin-gee o oman-jee</div>
                                <div class="dojo-kun-english">Be loyal to your Instructor.</div>
                            </div>
                            <div class="dojo-kun-item">
                                <div class="dojo-kun-japanese">JOJITSU-NI-OBERESU</div>
                                <div class="dojo-kun-phonetic">Joe-jitsu nee obberezu</div>
                                <div class="dojo-kun-english">
                                    Students and Instructors are not all one; never take advantage
                                    of his friendship.
                                </div>
                            </div>
                            <div class="dojo-kun-item">
                                <div class="dojo-kun-japanese">SHINKENMI-NI-TESSEYO</div>
                                <div class="dojo-kun-phonetic">Shin-ken-mee nee tesseyo</div>
                                <div class="dojo-kun-english">Be serious in your efforts.</div>
                            </div>
                        </div>

                        <div class="note-box">
                            <strong>Grading Requirement:</strong> You must be able to recite the
                            Dojo Kun in both Japanese and English at all gradings, starting from 9th
                            Ky.
                        </div>

                        <a
                            href="https://hakuba-karate.co.uk/dojo-kun/"
                            target="_blank"
                            class="btn-primary"
                            >Read More About Dojo Kun </a
                        >
                    </div>
                </div>

                <!-- Terminology Tab -->
                <div id="terminology-tab" class="tab-content">
                    <div class="card">
                        <h2>Complete Terminology Reference</h2>
                        <p>
                            All Japanese terms used in training, organized by category. From 7th Ky
                            onwards, all commands are given in Japanese only!
                        </p>

                        <h3>Commands</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Yi ()</div>
                                <div class="english">
                                    Ready / Prepare - Stand in a ready position
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Rei ()</div>
                                <div class="english">
                                    Bow / Show respect - Formal bow to sensei or partner
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Hajime ()</div>
                                <div class="english">Begin - Start the technique or exercise</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Yame ()</div>
                                <div class="english">Stop / Cease - Return to ready position</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Mawatte ()</div>
                                <div class="english">Turn around - Usually 180 degrees</div>
                            </div>
                        </div>

                        <h3>Positioning & Levels</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Jdan ()</div>
                                <div class="english">Upper level</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Chdan ()</div>
                                <div class="english">Mid level</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Gedan ()</div>
                                <div class="english">Lower level</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Hidari ()</div>
                                <div class="english">Left</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Migi ()</div>
                                <div class="english">Right</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Mae ()</div>
                                <div class="english">In front</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ushiro ()</div>
                                <div class="english">Behind</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Yoko ()</div>
                                <div class="english">To the side</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Gyaku ()</div>
                                <div class="english">Reverse</div>
                            </div>
                        </div>

                        <h3>Blocks (Uke )</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Jdan-uke ()</div>
                                <div class="english">
                                    Upper block - Rising block to protect the head
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Soto-uke ()</div>
                                <div class="english">Outer block - Outside-to-inside block</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Uchi-uke ()</div>
                                <div class="english">Inner block - Inside-to-outside block</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Gedan-barai ()</div>
                                <div class="english">
                                    Lower sweeping block - Downward block to deflect low attacks
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Shut-uke ()</div>
                                <div class="english">Knife hand block - Open hand block</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Morote-uke ()</div>
                                <div class="english">
                                    Double hand (augmented) block - Reinforced block using both
                                    hands
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Jji-uke ()</div>
                                <div class="english">Cross block - Figure ten / X block</div>
                            </div>
                        </div>

                        <h3>Strikes (Zuki/Tsuki )</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Junzuki ()</div>
                                <div class="english">
                                    Orthodox punch (same arm, same leg forward)
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Gyakuzuki ()</div>
                                <div class="english">
                                    Reverse punch - Opposite arm to leg forward
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Junzuki-no-tsukkomi ()</div>
                                <div class="english">Leaning lunge punch</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Gyakuzuki-no-tsukkomi ()</div>
                                <div class="english">Leaning reverse punch</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Tobikomizuki ()</div>
                                <div class="english">Leaping body-in punch</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Nagashizuki ()</div>
                                <div class="english">Flowing punch</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Uraken ()</div>
                                <div class="english">Backfist</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Enpi Uchi ()</div>
                                <div class="english">Elbow strike (inner)</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Tettsui ()</div>
                                <div class="english">Hammer fist</div>
                            </div>
                        </div>

                        <h3>Kicks (Geri/Keri )</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Mae-geri ()</div>
                                <div class="english">Front kick</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Mawashi-geri ()</div>
                                <div class="english">Round-house kick</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ura-Mawashi-geri ()</div>
                                <div class="english">Reverse round-house kick</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Sokut ()</div>
                                <div class="english">Thrusting kick (Blade foot)</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ushiro-geri ()</div>
                                <div class="english">Back kick</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Tobi-geri ()</div>
                                <div class="english">Jumping (leaping) kick</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Mikazuki-geri ()</div>
                                <div class="english">Crescent kick</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ashi-barai ()</div>
                                <div class="english">Sweeping kick</div>
                            </div>
                        </div>

                        <h3>Stances (Dachi )</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Zenkutsu-dachi ()</div>
                                <div class="english">Front bent stance</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Kokutsu-dachi ()</div>
                                <div class="english">Back bent stance</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Hanmi-gamae ()</div>
                                <div class="english">Half-body posture (Fighting stance)</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Kiba-dachi ()</div>
                                <div class="english">Horse riding stance</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Shiko-dachi ()</div>
                                <div class="english">Square stance</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">
                                    Mahanmi-no-neko-ashi-dachi ()
                                </div>
                                <div class="english">Side viewing cat foot stance</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">
                                    Mashomen-no-neko-ashi-dachi ()
                                </div>
                                <div class="english">Front viewing cat foot stance</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Shizentai ()</div>
                                <div class="english">Natural stance</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Fud-dachi ()</div>
                                <div class="english">Immovable stance</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ksa-dachi ()</div>
                                <div class="english">Crossed-leg stance</div>
                            </div>
                        </div>

                        <h3>Movement</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Suri komi ()</div>
                                <div class="english">Step up</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Suri ashi ()</div>
                                <div class="english">Sliding step</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Tsukkomi ()</div>
                                <div class="english">Leaning</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Zenshinshite ()</div>
                                <div class="english">Advancing</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ktaishite ()</div>
                                <div class="english">Retreating</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ayumi ashi ()</div>
                                <div class="english">Natural stepping (walking foot)</div>
                            </div>
                        </div>

                        <h3>Sparring (Kumite )</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Sanbon-Gumite ()</div>
                                <div class="english">
                                    Three-step sparring - Pre-arranged three-attack sequence
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Kihon-Gumite ()</div>
                                <div class="english">
                                    Basic sparring - Fundamental sparring practice
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ohyo-Gumite ()</div>
                                <div class="english">
                                    Application sparring - Applied technique sparring
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Jiyu-Gumite ()</div>
                                <div class="english">
                                    Free sparring - Unrestricted sparring practice
                                </div>
                            </div>
                        </div>

                        <h3>Counting (1-10)</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Ichi ()</div>
                                <div class="english">One</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ni ()</div>
                                <div class="english">Two</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">San ()</div>
                                <div class="english">Three</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Shi/Yon ()</div>
                                <div class="english">Four</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Go ()</div>
                                <div class="english">Five</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Roku ()</div>
                                <div class="english">Six</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Shichi/Nana ()</div>
                                <div class="english">Seven</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Hachi ()</div>
                                <div class="english">Eight</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ky ()</div>
                                <div class="english">Nine</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">J ()</div>
                                <div class="english">Ten</div>
                            </div>
                        </div>

                        <h3>Technique Numbering</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Ipponme ()</div>
                                <div class="english">First technique</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Nihonme ()</div>
                                <div class="english">Second technique</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Sanbonme ()</div>
                                <div class="english">Third technique</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Yonhonme ()</div>
                                <div class="english">Fourth technique</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Gohonme ()</div>
                                <div class="english">Fifth technique</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ropponme ()</div>
                                <div class="english">Sixth technique</div>
                            </div>
                        </div>

                        <h3>General Terms</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Dojo ()</div>
                                <div class="english">
                                    Training hall - "The place of the way". We bow entering and
                                    exiting to show respect.
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Sensei ()</div>
                                <div class="english">
                                    Teacher - Literally "preceding in life". Used for any teacher,
                                    not just martial arts.
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Kata ()</div>
                                <div class="english">Form - Pre-arranged sequence of movements</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Kihon ()</div>
                                <div class="english">Basics - Fundamental techniques</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Kumite ()</div>
                                <div class="english">
                                    Sparring - Literally "grappling hands". Partner practice.
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Waza ()</div>
                                <div class="english">Technique - A specific move or skill</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Uke ()</div>
                                <div class="english">
                                    Block - Literally "to receive". Defensive techniques.
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Kiai ()</div>
                                <div class="english">
                                    Spirit shout - Literally "unification of energy". Used to focus
                                    effort at the moment of impact.
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Ki ()</div>
                                <div class="english">
                                    Energy/Spirit - Internal energy cultivated through training and
                                    proper technique.
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Bunkai ()</div>
                                <div class="english">
                                    Application - Literally "to break down". Practical application
                                    of kata movements.
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Gi ()</div>
                                <div class="english">Uniform - The karate training suit</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Obi ()</div>
                                <div class="english">
                                    Belt - Worn around the waist to indicate rank
                                </div>
                            </div>
                        </div>

                        <h3>Wado Technique</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Maai ()</div>
                                <div class="english">
                                    Distancing, timing and attitude respective to opponent
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Kuzushi ()</div>
                                <div class="english">Unbalancing your opponent</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Tai sabaki ()</div>
                                <div class="english">Body movement / manipulation</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Noru ()</div>
                                <div class="english">Riding a technique</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Irimi ()</div>
                                <div class="english">Entering an opponent's space</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Hikite ()</div>
                                <div class="english">Pullback</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Sente ()</div>
                                <div class="english">Initiative</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Go no sen ()</div>
                                <div class="english">
                                    Attack after opponent has started to attack
                                </div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Sen no sen ()</div>
                                <div class="english">
                                    Attack before opponent by reading movement
                                </div>
                            </div>
                        </div>

                        <h3>Four Minds (Yonshin )</h3>
                        <div class="technique-grid">
                            <div class="technique-card">
                                <div class="japanese">Mushin ()</div>
                                <div class="english">Clear mind</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Senshin ()</div>
                                <div class="english">Preparatory mind</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Tsushin ()</div>
                                <div class="english">Concentrating mind</div>
                            </div>
                            <div class="technique-card">
                                <div class="japanese">Zanshin ()</div>
                                <div class="english">Remaining mind</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Mode Tab -->
                <div id="study-tab" class="tab-content">
                    <div class="card">
                        <h2>Study Mode</h2>
                        <p>
                            Choose a study mode to practice your karate terminology. Flashcards help
                            you memorise terms, while Focus Mode lets you study specific technique
                            categories.
                        </p>

                        <div
                            class="study-mode-selector"
                            style="
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                                gap: 1.5rem;
                                margin: 2rem 0;
                            "
                        >
                            <div
                                class="study-mode-card"
                                style="
                                    background: white;
                                    border: 1px solid #e5e7eb;
                                    border-radius: 0.5rem;
                                    padding: 2rem;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                "
                                onclick="startFlashcards()"
                            >
                                <div style="font-size: 3rem; margin-bottom: 1rem"></div>
                                <h3 style="margin-bottom: 0.5rem; color: #1e5ba8">
                                    Flashcard Mode
                                </h3>
                                <p style="color: #6b7280; font-size: 1rem">
                                    Flip through cards to test your memory. See the Japanese term,
                                    then reveal the English translation.
                                </p>
                            </div>
                            <div
                                class="study-mode-card"
                                style="
                                    background: white;
                                    border: 1px solid #e5e7eb;
                                    border-radius: 0.5rem;
                                    padding: 2rem;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                "
                                onclick="startFocusMode()"
                            >
                                <div style="font-size: 3rem; margin-bottom: 1rem"></div>
                                <h3 style="margin-bottom: 0.5rem; color: #1e5ba8">Focus Mode</h3>
                                <p style="color: #6b7280; font-size: 1rem">
                                    Study specific categories like blocks, kicks, or commands.
                                    Perfect for targeted practice.
                                </p>
                            </div>
                        </div>

                        <!-- Flashcard Container -->
                        <div id="flashcard-container" style="display: none">
                            <div
                                style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    margin-bottom: 1.5rem;
                                "
                            >
                                <h3 style="margin: 0">Flashcards</h3>
                                <button
                                    onclick="exitStudyMode()"
                                    style="
                                        background: #6b7280;
                                        color: white;
                                        border: none;
                                        padding: 0.5rem 1rem;
                                        border-radius: 0.5rem;
                                        cursor: pointer;
                                    "
                                >
                                    Exit
                                </button>
                            </div>

                            <div style="margin-bottom: 1.5rem">
                                <label style="font-weight: 600; margin-right: 1rem"
                                    >Select Belt Level:</label
                                >
                                <select
                                    id="flashcard-belt"
                                    onchange="loadFlashcards()"
                                    style="
                                        padding: 0.5rem 1rem;
                                        border: 1px solid #e5e7eb;
                                        border-radius: 0.375rem;
                                        font-size: 1rem;
                                    "
                                ></select>
                            </div>

                            <div
                                id="flashcard-progress"
                                style="text-align: center; color: #6b7280; margin-bottom: 1rem"
                            ></div>

                            <div
                                id="flashcard"
                                style="
                                    background: white;
                                    border: 1px solid #e5e7eb;
                                    border-radius: 0.75rem;
                                    padding: 3rem;
                                    text-align: center;
                                    min-height: 250px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    position: relative;
                                "
                                onclick="flipFlashcard()"
                            >
                                <div
                                    id="flashcard-front"
                                    style="
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        min-height: 180px;
                                    "
                                >
                                    <div
                                        id="flashcard-category"
                                        style="
                                            font-size: 0.875rem;
                                            color: #6b7280;
                                            margin-bottom: 1rem;
                                        "
                                    ></div>
                                    <div
                                        id="flashcard-term"
                                        style="font-size: 2.5rem; font-weight: 700; color: #1e5ba8"
                                    ></div>
                                    <div
                                        style="
                                            font-size: 0.875rem;
                                            color: #9ca3af;
                                            margin-top: 1.5rem;
                                        "
                                    >
                                        Click to reveal answer
                                    </div>
                                </div>
                                <div
                                    id="flashcard-back"
                                    style="
                                        display: none;
                                        flex-direction: column;
                                        justify-content: center;
                                        min-height: 180px;
                                    "
                                >
                                    <div
                                        id="flashcard-term-back"
                                        style="
                                            font-size: 1.5rem;
                                            color: #6b7280;
                                            margin-bottom: 0.5rem;
                                        "
                                    ></div>
                                    <div
                                        id="flashcard-answer"
                                        style="font-size: 2.5rem; font-weight: 700; color: #059669"
                                    ></div>
                                </div>
                            </div>

                            <div
                                style="
                                    display: flex;
                                    justify-content: center;
                                    gap: 1rem;
                                    margin-top: 1.5rem;
                                "
                            >
                                <button
                                    onclick="prevFlashcard()"
                                    class="btn-primary"
                                    style="background: #6b7280"
                                >
                                     Previous
                                </button>
                                <button
                                    onclick="shuffleFlashcards()"
                                    class="btn-primary"
                                    style="background: #7c3aed"
                                >
                                    Shuffle
                                </button>
                                <button onclick="nextFlashcard()" class="btn-primary">
                                    Next 
                                </button>
                            </div>

                            <div
                                style="
                                    background: #f9fafb;
                                    padding: 1.5rem;
                                    border-radius: 0.5rem;
                                    margin-top: 2rem;
                                    text-align: center;
                                "
                            >
                                <div style="font-weight: 600; margin-bottom: 0.5rem">
                                    Keyboard Shortcuts:
                                </div>
                                <div style="color: #6b7280">
                                    <strong>Space</strong> = Flip card | <strong>/</strong> =
                                    Navigate | <strong>S</strong> = Shuffle | <strong>Esc</strong> =
                                    Exit
                                </div>
                            </div>
                        </div>

                        <!-- Focus Mode Container -->
                        <div id="focus-container" style="display: none">
                            <div
                                style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    margin-bottom: 1.5rem;
                                "
                            >
                                <h3 style="margin: 0">Focus Mode</h3>
                                <button
                                    onclick="exitStudyMode()"
                                    style="
                                        background: #6b7280;
                                        color: white;
                                        border: none;
                                        padding: 0.5rem 1rem;
                                        border-radius: 0.5rem;
                                        cursor: pointer;
                                    "
                                >
                                    Exit
                                </button>
                            </div>

                            <div id="focus-category-select" style="margin-bottom: 2rem">
                                <label style="font-weight: 600; display: block; margin-bottom: 1rem"
                                    >Select a category to focus on:</label
                                >
                                <div
                                    id="focus-categories"
                                    style="
                                        display: grid;
                                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                                        gap: 0.75rem;
                                    "
                                ></div>
                            </div>

                            <div id="focus-content" style="display: none">
                                <div
                                    id="focus-header"
                                    style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-bottom: 1.5rem;
                                    "
                                >
                                    <h4 id="focus-title" style="margin: 0"></h4>
                                    <button
                                        onclick="showFocusCategories()"
                                        style="
                                            background: #e5e7eb;
                                            color: #374151;
                                            border: none;
                                            padding: 0.5rem 1rem;
                                            border-radius: 0.5rem;
                                            cursor: pointer;
                                        "
                                    >
                                        Change Category
                                    </button>
                                </div>
                                <div
                                    id="focus-terms"
                                    style="
                                        display: grid;
                                        grid-template-columns: repeat(
                                            auto-fill,
                                            minmax(320px, 1fr)
                                        );
                                        gap: 1rem;
                                    "
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grading Checklist Tab -->
                <div id="grading-tab" class="tab-content">
                    <div class="card">
                        <h2>Grading Checklist</h2>
                        <p>
                            Track your preparation for your next grading. Select your current belt
                            level to see everything you need to know and practice.
                        </p>

                        <div style="margin: 1.5rem 0">
                            <label style="font-weight: 600; margin-right: 1rem"
                                >I am currently:</label
                            >
                            <select
                                id="grading-current-belt"
                                onchange="updateGradingChecklist()"
                                style="
                                    padding: 0.5rem 1rem;
                                    border: 1px solid #e5e7eb;
                                    border-radius: 0.375rem;
                                    font-size: 1rem;
                                    min-width: 200px;
                                "
                            ></select>
                        </div>

                        <div
                            id="grading-target"
                            style="
                                background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                                border: 2px solid #3b82f6;
                                border-radius: 0.75rem;
                                padding: 1.5rem;
                                margin-bottom: 2rem;
                                text-align: center;
                            "
                        >
                            <div style="font-size: 1rem; color: #1e5ba8; margin-bottom: 0.5rem">
                                Preparing for:
                            </div>
                            <div
                                id="grading-target-belt"
                                style="font-size: 1.75rem; font-weight: 700; color: #1e5ba8"
                            ></div>
                        </div>

                        <div
                            id="grading-progress-summary"
                            style="
                                background: white;
                                border: 1px solid #e5e7eb;
                                border-radius: 0.5rem;
                                padding: 1.5rem;
                                margin-bottom: 2rem;
                            "
                        >
                            <div
                                style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    margin-bottom: 1rem;
                                "
                            >
                                <span style="font-weight: 600; color: #374151"
                                    >Overall Progress</span
                                >
                                <span
                                    id="grading-progress-text"
                                    style="font-weight: 600; color: #1e5ba8"
                                ></span>
                            </div>
                            <div
                                style="
                                    height: 12px;
                                    background: #e5e7eb;
                                    border-radius: 6px;
                                    overflow: hidden;
                                "
                            >
                                <div
                                    id="grading-progress-bar"
                                    style="
                                        height: 100%;
                                        background: #1e5ba8;
                                        border-radius: 6px;
                                        transition: width 0.3s;
                                    "
                                ></div>
                            </div>
                        </div>

                        <div id="grading-checklist-content"></div>

                        <div
                            style="
                                margin-top: 2rem;
                                padding: 1.5rem;
                                background: #f9fafb;
                                border-radius: 0.5rem;
                            "
                        >
                            <div style="font-weight: 600; margin-bottom: 0.5rem">
                                Tips for Grading Success:
                            </div>
                            <ul style="color: #4b5563; padding-left: 1.25rem; line-height: 1.8">
                                <li>Practice each technique until it becomes automatic</li>
                                <li>Know the Japanese names and English translations</li>
                                <li>Memorise the Dojo Kun in both languages</li>
                                <li>Practice your kata with proper timing and kiai</li>
                                <li>Stay calm and focused during the grading</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Achievements Tab -->
                <div id="achievements-tab" class="tab-content">
                    <div class="card">
                        <h2>Achievements</h2>
                        <p>
                            Earn badges as you progress on your karate journey. Keep training to
                            unlock them all!
                        </p>

                        <!-- XP Progress -->
                        <div class="xp-container">
                            <div class="xp-header">
                                <span class="xp-level" id="user-level">Lvl 1</span>
                                <span class="xp-text" id="xp-text">0 / 100 XP</span>
                            </div>
                            <div class="xp-bar">
                                <div class="xp-bar-fill" id="xp-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>

                        <div
                            id="achievements-summary"
                            style="display: flex; gap: 2rem; margin: 2rem 0; flex-wrap: wrap"
                        >
                            <div
                                style="
                                    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
                                    padding: 1.5rem 2rem;
                                    border-radius: 0.75rem;
                                    color: white;
                                    text-align: center;
                                    min-width: 150px;
                                "
                            >
                                <div style="font-size: 2.5rem; font-weight: 700" id="badges-earned">
                                    0
                                </div>
                                <div style="font-size: 1rem; opacity: 0.9">Badges Earned</div>
                            </div>
                            <div
                                style="
                                    background: linear-gradient(135deg, #1e5ba8 0%, #1e40af 100%);
                                    padding: 1.5rem 2rem;
                                    border-radius: 0.75rem;
                                    color: white;
                                    text-align: center;
                                    min-width: 150px;
                                "
                            >
                                <div style="font-size: 2.5rem; font-weight: 700" id="badges-total">
                                    12
                                </div>
                                <div style="font-size: 1rem; opacity: 0.9">Total Badges</div>
                            </div>
                        </div>

                        <div
                            id="achievements-grid"
                            style="
                                display: grid;
                                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                                gap: 1.5rem;
                                margin-top: 2rem;
                            "
                        ></div>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div id="calendar-tab" class="tab-content">
                    <div class="card">
                        <h2>Dojo Calendar</h2>
                        <p>Upcoming classes, events, and gradings.</p>

                        <!-- Location Filter -->
                        <div
                            style="
                                margin: 1.5rem 0;
                                display: flex;
                                align-items: center;
                                gap: 1rem;
                                flex-wrap: wrap;
                            "
                        >
                            <span style="font-weight: 600; color: #374151">Show:</span>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
                                <button
                                    onclick="filterCalendar('all')"
                                    id="cal-filter-all"
                                    class="cal-filter-btn"
                                    style="
                                        padding: 0.5rem 1rem;
                                        border-radius: 2rem;
                                        border: none;
                                        background: #1e5ba8;
                                        color: white;
                                        font-weight: 500;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                    "
                                >
                                    All
                                </button>
                                <button
                                    onclick="filterCalendar('swindon')"
                                    id="cal-filter-swindon"
                                    class="cal-filter-btn"
                                    style="
                                        padding: 0.5rem 1rem;
                                        border-radius: 2rem;
                                        border: none;
                                        background: #e5e7eb;
                                        color: #374151;
                                        font-weight: 500;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.4rem;
                                    "
                                >
                                    <span
                                        style="
                                            width: 10px;
                                            height: 10px;
                                            background: #039be5;
                                            border-radius: 50%;
                                        "
                                    ></span>
                                    Swindon
                                </button>
                                <button
                                    onclick="filterCalendar('mevagissey')"
                                    id="cal-filter-mevagissey"
                                    class="cal-filter-btn"
                                    style="
                                        padding: 0.5rem 1rem;
                                        border-radius: 2rem;
                                        border: none;
                                        background: #e5e7eb;
                                        color: #374151;
                                        font-weight: 500;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.4rem;
                                    "
                                >
                                    <span
                                        style="
                                            width: 10px;
                                            height: 10px;
                                            background: #9e69af;
                                            border-radius: 50%;
                                        "
                                    ></span>
                                    Mevagissey
                                </button>
                            </div>
                        </div>

                        <!-- Calendar Embed -->
                        <div
                            style="
                                background: white;
                                border-radius: 0.75rem;
                                overflow: hidden;
                                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                            "
                        >
                            <iframe
                                id="dojo-calendar"
                                src="https://calendar.google.com/calendar/embed?height=600&wkst=1&ctz=Europe/London&showPrint=0&showTitle=0&showNav=1&showTabs=0&mode=AGENDA&hl=en_GB&src=aGFrdWJhLndhZG9yeXUua2FyYXRlQGdtYWlsLmNvbQ&src=ZDg4MjliN2RjOGMzZmRkNjIyYjFlMWYyZTBlODIyNjNjODI1YWI2ZDNhNmExYzYzODYwNmU2M2I5M2FmNjViYUBncm91cC5jYWxlbmRhci5nb29nbGUuY29t&color=%23039be5&color=%239e69af"
                                style="border: 0; width: 100%; height: 500px"
                                frameborder="0"
                            ></iframe>
                        </div>

                        <!-- Legend -->
                        <div
                            style="
                                margin-top: 1rem;
                                padding: 0.75rem 1rem;
                                background: #f9fafb;
                                border-radius: 0.5rem;
                                display: flex;
                                gap: 1.5rem;
                                flex-wrap: wrap;
                                font-size: 0.85rem;
                                color: #6b7280;
                            "
                        >
                            <span style="display: flex; align-items: center; gap: 0.35rem">
                                <span
                                    style="
                                        width: 10px;
                                        height: 10px;
                                        background: #039be5;
                                        border-radius: 50%;
                                    "
                                ></span>
                                Swindon
                            </span>
                            <span style="display: flex; align-items: center; gap: 0.35rem">
                                <span
                                    style="
                                        width: 10px;
                                        height: 10px;
                                        background: #9e69af;
                                        border-radius: 50%;
                                    "
                                ></span>
                                Mevagissey
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Search Tab -->
                <div id="search-tab" class="tab-content">
                    <div class="card">
                        <h2>Search</h2>
                        <p>Search across all techniques, terminology, and belt requirements.</p>

                        <div style="margin: 1.5rem 0">
                            <input
                                type="text"
                                id="search-input"
                                placeholder="Search for a technique, term, or translation..."
                                oninput="performSearch()"
                                style="
                                    width: 100%;
                                    padding: 1rem 1.25rem;
                                    font-size: 1.125rem;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 0.5rem;
                                    outline: none;
                                    transition: border-color 0.2s;
                                "
                                onfocus="this.style.borderColor = '#1e5ba8'"
                                onblur="this.style.borderColor = '#e5e7eb'"
                            />
                        </div>

                        <div
                            id="search-results-count"
                            style="margin-bottom: 1rem; color: #6b7280; font-size: 1rem"
                        ></div>

                        <div id="search-results"></div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <div class="container">
                <p>
                    Content from
                    <a href="https://hakuba-karate.co.uk/" target="_blank">Hakuba Karate Dojo</a>
                </p>
                <p style="margin-top: 1rem">
                    <a
                        href="https://ko-fi.com/torncheesecake"
                        target="_blank"
                        style="
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                            background: #ff5e5b;
                            color: white;
                            padding: 0.5rem 1rem;
                            border-radius: 0.5rem;
                            text-decoration: none;
                            font-weight: 600;
                            font-size: 0.9rem;
                            transition: background 0.2s;
                        "
                    >
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604 0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407 0 0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311z"
                            />
                        </svg>
                        Support this app
                    </a>
                </p>
                <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.75rem">
                     2026 Matthew Hillman - Black Belt in Coding
                </p>
            </div>
        </footer>

        <script>
            // ==========================================
            // AUTHENTICATION SYSTEM
            // ==========================================
            let currentUser = null;
            let isAuthMode = "login"; // 'login' or 'register'
            let isSyncing = false;

            // Auth state listener - runs on page load
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                window.currentUser = user; // Also set on window for reliability
                updateAuthUI();

                if (user) {
                    console.log("User signed in:", user.email);
                    // Wait for page to fully load before syncing
                    const doSync = async () => {
                        try {
                            await loadDataFromFirestore();
                            // Also sync local data to cloud on login
                            await syncLocalDataToCloud();
                        } catch (err) {
                            console.error("Sync error:", err);
                        }
                    };

                    if (document.readyState === "complete") {
                        setTimeout(doSync, 500); // Small delay to ensure everything is ready
                    } else {
                        window.addEventListener("load", () => setTimeout(doSync, 500));
                    }
                } else {
                    // Check if first visit
                    const hasVisited = localStorage.getItem("hakubaHasVisited");
                    if (!hasVisited) {
                        // Show auth modal on first visit
                        setTimeout(() => showAuthModal(), 500);
                    }
                }
            });

            function updateAuthUI() {
                const signInBtn = document.getElementById("sign-in-btn");
                const userMenuBtn = document.getElementById("user-menu-btn");
                const userDisplayName = document.getElementById("user-display-name");
                const userEmailDisplay = document.getElementById("user-email-display");

                if (currentUser) {
                    // User is logged in
                    signInBtn.style.display = "none";
                    userMenuBtn.style.display = "flex";
                    const displayName = currentUser.email.split("@")[0];
                    userDisplayName.textContent = displayName;
                    userEmailDisplay.textContent = currentUser.email;
                } else {
                    // User is logged out
                    signInBtn.style.display = "flex";
                    userMenuBtn.style.display = "none";
                }
            }

            function showAuthModal() {
                document.getElementById("auth-modal").classList.add("active");
                document.getElementById("auth-email").focus();
            }

            function hideAuthModal() {
                document.getElementById("auth-modal").classList.remove("active");
                document.getElementById("auth-error").classList.remove("show");
                document.getElementById("auth-form").reset();
            }

            function toggleAuthMode() {
                isAuthMode = isAuthMode === "login" ? "register" : "login";
                const title = document.getElementById("auth-modal-title");
                const submitBtn = document.getElementById("auth-submit-btn");
                const toggle = document.getElementById("auth-toggle");
                const confirmGroup = document.getElementById("auth-confirm-group");
                const confirmInput = document.getElementById("auth-confirm");

                if (isAuthMode === "register") {
                    title.textContent = "Create Account";
                    submitBtn.textContent = "Sign Up";
                    toggle.innerHTML =
                        'Already have an account? <a onclick="toggleAuthMode()">Sign in</a>';
                    confirmGroup.style.display = "block";
                    confirmInput.required = true;
                } else {
                    title.textContent = "Sign In";
                    submitBtn.textContent = "Sign In";
                    toggle.innerHTML =
                        'Don\'t have an account? <a onclick="toggleAuthMode()">Sign up</a>';
                    confirmGroup.style.display = "none";
                    confirmInput.required = false;
                }

                document.getElementById("auth-error").classList.remove("show");
            }

            function showAuthError(message) {
                const errorEl = document.getElementById("auth-error");
                errorEl.textContent = message;
                errorEl.classList.add("show");
            }

            async function handleAuthSubmit(event) {
                event.preventDefault();

                const email = document.getElementById("auth-email").value;
                const password = document.getElementById("auth-password").value;
                const submitBtn = document.getElementById("auth-submit-btn");

                if (isAuthMode === "register") {
                    const confirm = document.getElementById("auth-confirm").value;
                    if (password !== confirm) {
                        showAuthError("Passwords do not match");
                        return;
                    }
                }

                submitBtn.disabled = true;
                submitBtn.textContent =
                    isAuthMode === "login" ? "Signing in..." : "Creating account...";

                try {
                    if (isAuthMode === "login") {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        await auth.createUserWithEmailAndPassword(email, password);
                        // Create user profile in Firestore
                        await db.collection("users").doc(auth.currentUser.uid).set(
                            {
                                email: email,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            },
                            { merge: true },
                        );
                    }

                    hideAuthModal();

                    // Sync local data to cloud after login/register
                    await syncLocalDataToCloud();
                } catch (error) {
                    let message = "An error occurred. Please try again.";
                    switch (error.code) {
                        case "auth/email-already-in-use":
                            message = "This email is already registered. Try signing in.";
                            break;
                        case "auth/invalid-email":
                            message = "Please enter a valid email address.";
                            break;
                        case "auth/weak-password":
                            message = "Password must be at least 6 characters.";
                            break;
                        case "auth/user-not-found":
                        case "auth/wrong-password":
                        case "auth/invalid-credential":
                            message = "Invalid email or password.";
                            break;
                        case "auth/too-many-requests":
                            message = "Too many failed attempts. Please try again later.";
                            break;
                    }
                    showAuthError(message);
                }

                submitBtn.disabled = false;
                submitBtn.textContent = isAuthMode === "login" ? "Sign In" : "Sign Up";
            }

            function continueAsGuest() {
                localStorage.setItem("hakubaHasVisited", "true");
                hideAuthModal();
            }

            async function handleLogout() {
                try {
                    await auth.signOut();
                    closeUserMenu();
                } catch (error) {
                    console.error("Logout error:", error);
                }
            }

            function toggleUserMenu() {
                const dropdown = document.getElementById("user-menu-dropdown");
                dropdown.classList.toggle("show");
            }

            function closeUserMenu() {
                document.getElementById("user-menu-dropdown").classList.remove("show");
            }

            // Close dropdown when clicking outside
            document.addEventListener("click", (e) => {
                const userMenu = document.getElementById("user-menu");
                if (userMenu && !userMenu.contains(e.target)) {
                    closeUserMenu();
                }
            });

            // ==========================================
            // FIRESTORE DATA SYNC
            // ==========================================
            function showSyncIndicator(syncing) {
                const indicator = document.getElementById("sync-indicator");
                if (!indicator) return;

                if (syncing) {
                    indicator.style.display = "inline-flex";
                    indicator.className = "sync-indicator syncing";
                } else {
                    indicator.className = "sync-indicator synced";
                    setTimeout(() => {
                        indicator.style.display = "none";
                    }, 2000);
                }
            }

            async function loadDataFromFirestore() {
                if (!currentUser) return;

                try {
                    const userDoc = await db.collection("users").doc(currentUser.uid).get();
                    const cloudData = userDoc.exists ? userDoc.data() : {};

                    // Get local data
                    const localAchievements = JSON.parse(
                        localStorage.getItem("hakubaAchievements") || "{}",
                    );
                    const localQuizHistory = JSON.parse(
                        localStorage.getItem("quizHistory") || "{}",
                    );
                    const localProgress = JSON.parse(
                        localStorage.getItem("hakubaProgress") || "{}",
                    );

                    // Merge achievements - take the higher values
                    const mergedAchievements = mergeAchievements(
                        localAchievements,
                        cloudData.achievements || {},
                    );
                    localStorage.setItem("hakubaAchievements", JSON.stringify(mergedAchievements));

                    // Merge quiz history - combine both
                    const mergedQuizHistory = mergeQuizHistory(
                        localQuizHistory,
                        cloudData.quizHistory || {},
                    );
                    localStorage.setItem("quizHistory", JSON.stringify(mergedQuizHistory));

                    // Load progress (prefer cloud if exists, otherwise keep local)
                    if (cloudData.progress) {
                        if (cloudData.progress.currentBelt) {
                            selectBelt(cloudData.progress.currentBelt, true);
                        }
                        if (cloudData.progress.notes) {
                            window.userNotes = {
                                ...localProgress.notes,
                                ...cloudData.progress.notes,
                            };
                        }
                        if (cloudData.progress.bookmarks) {
                            window.userBookmarks = {
                                ...localProgress.bookmarks,
                                ...cloudData.progress.bookmarks,
                            };
                        }
                        if (cloudData.progress.darkMode) {
                            toggleDarkMode(true);
                        }
                    }

                    // Always sync merged data back to cloud
                    await syncLocalDataToCloud();
                } catch (error) {
                    console.error("Error loading from Firestore:", error);
                }
            }

            // Merge achievements - take the maximum values
            function mergeAchievements(local, cloud) {
                const merged = { ...local };

                // Numeric fields - take the max
                const numericFields = [
                    "techniquesLearned",
                    "quizzesCompleted",
                    "perfectQuizzes",
                    "bestStreak",
                    "currentStreak",
                    "beltsCompleted",
                    "categoriesStudied",
                    "practiceStreak",
                    "correctAnswers",
                    "badgesEarned",
                ];

                numericFields.forEach((field) => {
                    merged[field] = Math.max(local[field] || 0, cloud[field] || 0);
                });

                // Array fields - combine unique values
                const arrayFields = ["unlockedBadges", "studiedCategories", "earnedBelts"];
                arrayFields.forEach((field) => {
                    const localArr = local[field] || [];
                    const cloudArr = cloud[field] || [];
                    merged[field] = [...new Set([...localArr, ...cloudArr])];
                });

                // Boolean fields - true if either is true
                if (local.allTechniquesLearned || cloud.allTechniquesLearned) {
                    merged.allTechniquesLearned = true;
                }

                // Date fields - take the most recent
                if (cloud.lastPracticeDate && local.lastPracticeDate) {
                    merged.lastPracticeDate =
                        new Date(cloud.lastPracticeDate) > new Date(local.lastPracticeDate)
                            ? cloud.lastPracticeDate
                            : local.lastPracticeDate;
                } else {
                    merged.lastPracticeDate = cloud.lastPracticeDate || local.lastPracticeDate;
                }

                return merged;
            }

            // Merge quiz history - combine records, taking best performance
            function mergeQuizHistory(local, cloud) {
                const merged = { ...local };

                Object.keys(cloud).forEach((term) => {
                    if (!merged[term]) {
                        merged[term] = cloud[term];
                    } else {
                        // Take the record with more correct answers, or combine
                        merged[term] = {
                            wrong: Math.min(merged[term].wrong || 0, cloud[term].wrong || 0),
                            correct: Math.max(merged[term].correct || 0, cloud[term].correct || 0),
                            lastSeen: Math.max(
                                merged[term].lastSeen || 0,
                                cloud[term].lastSeen || 0,
                            ),
                        };
                    }
                });

                return merged;
            }

            async function syncLocalDataToCloud() {
                if (!currentUser || isSyncing) return;

                isSyncing = true;
                showSyncIndicator(true);
                console.log("Starting sync to cloud...");

                try {
                    const progressData = {
                        currentBelt:
                            document.querySelector(".belt-button.active")?.dataset?.belt || "9th",
                        notes: window.userNotes || {},
                        bookmarks: window.userBookmarks || {},
                        darkMode: document.body.classList.contains("dark-mode"),
                    };

                    const achievementData = JSON.parse(
                        localStorage.getItem("hakubaAchievements") || "{}",
                    );
                    const quizHistoryData = JSON.parse(localStorage.getItem("quizHistory") || "{}");

                    console.log("Syncing data:", {
                        progressData,
                        achievementData,
                        quizHistoryData,
                    });

                    await db.collection("users").doc(currentUser.uid).set(
                        {
                            progress: progressData,
                            achievements: achievementData,
                            quizHistory: quizHistoryData,
                            lastSyncedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        },
                        { merge: true },
                    );
                    console.log("Sync complete!");
                } catch (error) {
                    console.error("Error syncing to Firestore:", error);
                } finally {
                    isSyncing = false;
                    showSyncIndicator(false);
                }
            }

            // Sync function - syncs every 30 seconds if there are pending changes
            let syncTimeout = null;
            let hasPendingChanges = false;

            function debouncedSync() {
                hasPendingChanges = true;
                // Only start timer if not already running
                if (!syncTimeout) {
                    syncTimeout = setTimeout(() => {
                        if (hasPendingChanges) {
                            syncLocalDataToCloud();
                            hasPendingChanges = false;
                        }
                        syncTimeout = null;
                    }, 30000); // Sync every 30 seconds
                }
            }

            // Sync on page unload to catch final changes
            window.addEventListener("beforeunload", () => {
                if (hasPendingChanges && currentUser) {
                    // Use sendBeacon for reliable sync on page close
                    hasPendingChanges = false;
                    syncLocalDataToCloud();
                }
            });

            // Also sync when page becomes hidden (mobile tab switch)
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === "hidden" && hasPendingChanges && currentUser) {
                    syncLocalDataToCloud();
                    hasPendingChanges = false;
                }
            });

            // ==========================================
            // ORIGINAL APP CODE
            // ==========================================

            // Translations for common terms
            const translations = {
                Ipponme: "First technique",
                Nihonme: "Second technique",
                Sanbonme: "Third technique",
                Yonhonme: "Fourth technique",
                Gohonme: "Fifth technique",
                Ropponme: "Sixth technique",
                Nanahonme: "Seventh technique",
                Napponme: "Eighth technique",
                "chudan soto-uke": "middle outer block",
                "chudan uchi-uke": "middle inner block",
                maegeri: "front kick",
                gyakuzuki: "reverse punch",
                empi: "elbow strike",
                "Junzuki-uke": "Defending against straight punches",
                "Maegeri-uke": "Defending against front kicks",
            };

            const beltData = {
                "9th": {
                    name: "9th Ky",
                    color: "Red Belt",
                    cssClass: "belt-red",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2018/09/9thKyu_RedBelt_Syllabus.pdf",
                    note: "Commands will be given first in Japanese then in English",
                    dojoKun: true,
                    beltTying: true,
                    kihon: {
                        blocksStance: "Junzuki-dachi",
                        otherStance: "Hanmi-gamae",
                        blocks: [
                            { name: "Jdan-uke", translation: "Head block" },
                            { name: "Soto-uke", translation: "Outer block" },
                            { name: "Uchi-uke", translation: "Inner block" },
                            { name: "Gedan-barai", translation: "Lower sweeping block" },
                        ],
                        strikes: [
                            { name: "Jdan-zuki", translation: "Head snap-punch" },
                            { name: "Uraken-uchi-jdan", translation: "Head back-fist strike" },
                        ],
                        kicks: [
                            { name: "Mae-geri-chdan", translation: "Body front kick" },
                            {
                                name: "Suri komi-mae-geri-chdan",
                                translation: "One step body front kick",
                            },
                            { name: "Mawashi-geri-chdan", translation: "Body round-house kick" },
                            {
                                name: "Suri komi-mawashi-geri-chdan",
                                translation: "One step body round-house kick",
                            },
                        ],
                    },
                },
                "8th": {
                    name: "8th Ky",
                    color: "Yellow Belt",
                    cssClass: "belt-yellow",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2018/09/8thKyu_YellowBelt_Syllabus.pdf",
                    note: "Commands will be given first in Japanese then in English",
                    dojoKun: true,
                    beltTying: true,
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Junzuki, Mawatte-jdan-uke",
                                translation: "Orthodox punch, turn with head block",
                            },
                            {
                                name: "Gyakuzuki, Mawatte-gedan-barai",
                                translation: "Reverse punch, turn with lower sweeping block",
                            },
                            { name: "Mae-geri-chdan", translation: "Body front kick" },
                            {
                                name: "Suri komi-mae-geri-chdan",
                                translation: "One step body front kick",
                            },
                            {
                                name: "Sokut-fumikomi-hiza",
                                translation: "Thrusting stamp kick to the knee",
                            },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Mae-geri-chdan-tobikomizuki-jdan",
                                translation:
                                    "Front kick to mid level, leaping punch to upper level",
                            },
                            {
                                name: "Suri komi-mae-geri-chdan-tobikomizuki-jdan",
                                translation:
                                    "Step up front kick to mid level, leaping punch to upper level",
                            },
                            {
                                name: "Mae-geri-chdan-gyakuzuki-chdan",
                                translation: "Front kick, reverse punch to mid level",
                            },
                            {
                                name: "Suri komi-mae-geri-chdan-gyakuzuki-chdan",
                                translation: "Step up front kick, reverse punch to mid level",
                            },
                        ],
                    },
                    uke: {
                        title: "Uke-Waza (Blocking techniques)",
                        stance: "Junzuki-dachi",
                        list: [
                            {
                                name: "Soto-uke-gyakuzuki",
                                translation: "Outer block, reverse punch",
                            },
                            {
                                name: "Uchi-uke-gyakuzuki",
                                translation: "Inner block, reverse punch",
                            },
                        ],
                        note: "All blocks performed with turning block (outer/inner), reverse punch",
                    },
                },
                "7th": {
                    name: "7th Ky",
                    color: "Orange Belt",
                    cssClass: "belt-orange",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2018/09/7thKyu_OrangeBelt_Syllabus.pdf",
                    note: "From this belt onwards, all commands are in Japanese only",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            { name: "Junzuki-no-tsukkomi", translation: "Leaning lunge punch" },
                            { name: "Gyakuzuki-no-tsukkomi", translation: "Leaning reverse punch" },
                            { name: "Mawashi-geri-chdan", translation: "Body round-house kick" },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Mae-geri-chdan  Mawashi-geri-chdan  Gyakuzuki-chdan",
                                translation:
                                    "Front kick  Round-house kick  Reverse punch (all to body)",
                            },
                            {
                                name: "Suri komi-mae-geri-chdan  Mawashi-geri-chdan  Gyakuzuki-chdan",
                                translation:
                                    "Step up front kick  Round-house kick  Reverse punch (all to body)",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            {
                                name: "Junzuki-uke",
                                translation: "Defending against straight punches",
                            },
                            {
                                name: "Gohonme",
                                translation:
                                    "5th technique: middle outer block - front kick - reverse punch",
                                detail: "(chudan soto-uke - maegeri - gyakuzuki)",
                            },
                            {
                                name: "Ropponme",
                                translation: "6th technique: middle inner block - elbow strike",
                                detail: "(chudan uchi-uke - empi)",
                            },
                        ],
                    },
                    kata: {
                        name: "Pinan Nidan",
                        link: "https://youtu.be/SM1OS-k4BCE",
                    },
                },
                "6th": {
                    name: "6th Ky",
                    color: "Green Belt",
                    cssClass: "belt-green",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2018/09/6thKyu_GreenBelt_Syllabus.pdf",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Tobikomizuki-jdan",
                                translation: "Leaping body-in punch to upper level",
                            },
                            {
                                name: "Suri komi-mawashi-geri-chdan",
                                translation: "One step body round-house kick",
                            },
                            {
                                name: "Suri komi-sokut-chdan",
                                translation: "Step up thrusting kick to mid level",
                            },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Mae-geri-chdan  Sokut-fumikomi-hiza  Gyakuzuki-chdan",
                                translation:
                                    "Front kick mid level  Thrusting stamp kick to knee  Reverse punch mid level",
                            },
                            {
                                name: "Suri komi-mae-geri-chdan  Sokut-chdan  Gyakuzuki-chdan",
                                translation:
                                    "Step up front kick  Thrusting kick mid level  Reverse punch mid level",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            {
                                name: "Junzuki-uke: Ipponme, Nihonme",
                                translation:
                                    "Defending against straight punches: 1st & 2nd techniques",
                            },
                            {
                                name: "Maegeri-uke: Ipponme, Nihonme",
                                translation: "Defending against front kicks: 1st & 2nd techniques",
                            },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [{ name: "Ipponme", translation: "First technique" }],
                    },
                    kata: {
                        name: "Pinan Shodan, Pinan Sandan",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                },
                "5th": {
                    name: "5th Ky",
                    color: "Blue Belt",
                    cssClass: "belt-blue",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2018/09/5thKyu_BlueBelt_Syllabus.pdf",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Kette-junzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning reverse punch",
                            },
                            {
                                name: "Nagashizuki-jdan",
                                translation: "Deflecting punch to upper level",
                            },
                            { name: "Ushiro-geri-gedan", translation: "Back kick to lower level" },
                            { name: "Sokut-chdan", translation: "Thrusting kick to mid level" },
                            { name: "Nidan-geri-jdan", translation: "Double kick to upper level" },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Mawashi-geri-chdan  Ushiro-geri-gedan  Gyakuzuki-chdan",
                                translation:
                                    "Round-house kick body  Back kick lower level  Reverse punch body",
                            },
                            {
                                name: "Suri komi-sokut-fumikomi-hiza  Ushiro-geri-gedan  Uraken-uchi-jdan",
                                translation:
                                    "Step up thrusting stamp kick to knee  Back kick lower level  Backfist strike upper level",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            {
                                name: "Junzuki-uke: Sanbonme, Yonhonme",
                                translation:
                                    "Defending against straight punches: 3rd & 4th techniques",
                            },
                            {
                                name: "Maegeri-uke: Sanbonme, Yonhonme",
                                translation: "Defending against front kicks: 3rd & 4th techniques",
                            },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [{ name: "Nihonme", translation: "Second technique" }],
                    },
                    kata: {
                        name: "Pinan Sandan, Pinan Yodan",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                },
                "4th": {
                    name: "4th Ky",
                    color: "Purple Belt",
                    cssClass: "belt-purple",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2018/09/4thKyu_PurpleBelt_Syllabus.pdf",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Kette-junzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning reverse punch",
                            },
                            {
                                name: "Nagashizuki-jdan",
                                translation: "Deflecting punch to upper level",
                            },
                            {
                                name: "Mawashi-geri-chdan",
                                translation: "Body round-house kick",
                            },
                            { name: "Ushiro-geri-chdan", translation: "Back kick to mid level" },
                            { name: "Sokut-chdan", translation: "Thrusting kick to mid level" },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Mae-geri-chdan  Nagashizuki-jdan  Gyakuzuki-chdan",
                                translation:
                                    "Front kick mid level  Deflecting punch upper level  Reverse punch mid level",
                            },
                            {
                                name: "Suri komi-mae-geri-chdan  Nagashizuki-jdan  Mawashi-geri-chdan",
                                translation:
                                    "Step up front kick  Deflecting punch head  Round-house kick body",
                            },
                            {
                                name: "Mae-geri-chdan  Sokut-fumikomi-hiza  Ushiro-geri-gedan  Gyakuzuki-chdan",
                                translation:
                                    "Front kick  Thrusting stamp kick to knee  Back kick lower level  Reverse punch mid level",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            {
                                name: "Junzuki-uke: Gohonme, Ropponme",
                                translation:
                                    "Defending against straight punches: 5th & 6th techniques",
                            },
                            {
                                name: "Maegeri-uke: Gohonme, Ropponme",
                                translation: "Defending against front kicks: 5th & 6th techniques",
                            },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [{ name: "Sanbonme", translation: "Third technique" }],
                    },
                    kata: {
                        name: "Pinan Yodan, Pinan Godan",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                },
                "3rd": {
                    name: "3rd Ky",
                    color: "Brown Belt",
                    cssClass: "belt-brown",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2023/03/3rdKyu_BrownBelt_Syllabus.pdf",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Kette-junzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning reverse punch",
                            },
                            {
                                name: "Tobikomizuki-jdan",
                                translation: "Leaping body-in punch to upper level",
                            },
                            {
                                name: "Nagashizuki-jdan",
                                translation: "Deflecting punch to upper level",
                            },
                            {
                                name: "Mawashi-geri-jdan",
                                translation: "Head round-house kick",
                            },
                            { name: "Ushiro-geri-chdan", translation: "Back kick to mid level" },
                            {
                                name: "Suri komi-sokut-jdan",
                                translation: "Step up thrusting kick to upper level",
                            },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Suri komi-mae-geri-chdan  Mawashi-geri-chdan  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step up front kick  Round-house kick body  Back kick body  Backfist strike head",
                            },
                            {
                                name: "Mae-geri-chdan - Nagashizuki-jdan  Gyakuzuki-chdan  Mawashi-geri-chdan",
                                translation:
                                    "Front kick  Deflecting punch head  Reverse punch body  Round-house kick body",
                            },
                            {
                                name: "Suri komi-mae-geri-chdan  Sokut-fumikomi-hiza  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step up front kick  Thrusting stamp kick to knee  Back kick mid level  Backfist strike upper level",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            {
                                name: "Junzuki-uke: Ipponme, Nihonme",
                                translation:
                                    "Defending against straight punches: 1st & 2nd techniques",
                            },
                            {
                                name: "Maegeri-uke: Ipponme, Nihonme",
                                translation: "Defending against front kicks: 1st & 2nd techniques",
                            },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [{ name: "Yonhonme", translation: "Fourth technique" }],
                    },
                    kihonGumite: {
                        title: "Kihon-Gumite (Basic sparring)",
                        items: [{ name: "Ipponme, Nihonme", translation: "1st & 2nd techniques" }],
                    },
                    machiOhyo: {
                        title: "Machi-Ohyo (Street application)",
                        items: [{ name: "Ipponme, Nihonme", translation: "1st & 2nd techniques" }],
                    },
                    kata: {
                        name: "Ku-Shanku (Kushanku)",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                },
                "2nd": {
                    name: "2nd Ky",
                    color: "Brown Belt (White Stripe)",
                    cssClass: "belt-brown-white",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2023/03/2ndKyu_BrownWhiteBelt_Syllabus.pdf",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Kette-junzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning reverse punch",
                            },
                            {
                                name: "Nagashizuki-jdan",
                                translation: "Deflecting punch to upper level",
                            },
                            {
                                name: "Mawashi-geri-jdan",
                                translation: "Head round-house kick",
                            },
                            { name: "Sokut-jdan", translation: "Thrusting kick to upper level" },
                            { name: "Ushiro-geri-chdan", translation: "Back kick to mid level" },
                            { name: "Nidan-geri-jdan", translation: "Double kick to upper level" },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Suri komi-mae-geri-chdan  Nagashizuki-jdan  Mawashi-geri-jdan",
                                translation:
                                    "Step up front kick  Deflecting punch head  Round-house kick head",
                            },
                            {
                                name: "Mae-geri-chdan  Sokut-chdan  Ushiro-geri-chdan  Gyakuzuki-chdan",
                                translation:
                                    "Front kick mid level  Thrusting kick mid level  Back kick mid level  Reverse punch mid level",
                            },
                            {
                                name: "Zenshinshite-jdan - Renzuki-chdan - Suri komi-mae-geri-chdan - Mawashi-geri-chdan - Gyakuzuki-chdan",
                                translation:
                                    "Step forward head  Follow punch body  Step up front kick  Round-house kick body  Reverse punch body",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            {
                                name: "Junzuki-uke: Sanbonme, Yonhonme",
                                translation:
                                    "Defending against straight punches: 3rd & 4th techniques",
                            },
                            {
                                name: "Maegeri-uke: Sanbonme, Yonhonme",
                                translation: "Defending against front kicks: 3rd & 4th techniques",
                            },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [{ name: "Gohonme, Ropponme", translation: "5th & 6th techniques" }],
                    },
                    kihonGumite: {
                        title: "Kihon-Gumite (Basic sparring)",
                        items: [
                            { name: "Sanbonme, Yonhonme", translation: "3rd & 4th techniques" },
                        ],
                    },
                    machiOhyo: {
                        title: "Machi-Ohyo (Street application)",
                        items: [
                            {
                                name: "Ipponme, Nihonme, Sanbonme, Yonhonme",
                                translation: "1st, 2nd, 3rd & 4th techniques",
                            },
                        ],
                    },
                    kata: {
                        name: "Ku-Shanku, Nai-hanchi",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                },
                "1st": {
                    name: "1st Ky",
                    color: "Brown Belt (Black Stripe)",
                    cssClass: "belt-brown-black",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2023/03/1stKyu_BrownBlackBeltSyllabus.pdf",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Kette-junzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning reverse punch",
                            },
                            {
                                name: "Nagashizuki-jdan",
                                translation: "Deflecting punch to upper level",
                            },
                            {
                                name: "Suri komi-mawashi-geri-jdan",
                                translation: "One step head round-house kick",
                            },
                            {
                                name: "Suri komi-sokut-jdan",
                                translation: "Step up thrusting kick to upper level",
                            },
                            { name: "Ushiro-geri-chdan", translation: "Back kick to mid level" },
                            { name: "Nidan-geri-jdan", translation: "Double kick to upper level" },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Zenshinshite-jdan  Renzuki-chdan  Mae-geri-chdan  Mawashi-geri-chdan  Ushiro-geri-chdan  Gyakuzuki-chdan",
                                translation:
                                    "Step forward head  Follow punch body  Front kick body  Round-house kick body  Back kick body  Reverse punch body",
                            },
                            {
                                name: "Suri komi-jdan  Renzuki-chdan  Suri komi-mae-geri-chdan  Mawashi-geri-chdan  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step up head  Follow punch body  Step up front kick  Round-house kick body  Back kick body  Backfist strike head",
                            },
                            {
                                name: "Zenshinshite-jdan  Renzuki-chdan  Mae-geri-chdan  Nagashizuki-jdan  Gyakuzuki-chdan  Mawashi-geri-jdan",
                                translation:
                                    "Step forward head  Follow punch body  Front kick body  Deflecting punch head  Reverse punch body  Round-house kick head",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            {
                                name: "Junzuki-uke: Gohonme, Ropponme",
                                translation:
                                    "Defending against straight punches: 5th & 6th techniques",
                            },
                            {
                                name: "Maegeri-uke: Gohonme, Ropponme",
                                translation: "Defending against front kicks: 5th & 6th techniques",
                            },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [
                            { name: "Nanahonme, Napponme", translation: "7th & 8th techniques" },
                        ],
                    },
                    kihonGumite: {
                        title: "Kihon-Gumite (Basic sparring)",
                        items: [{ name: "Gohonme", translation: "5th technique" }],
                    },
                    machiOhyo: {
                        title: "Machi-Ohyo (Street application)",
                        items: [
                            {
                                name: "Ipponme, Nihonme, Sanbonme, Yonhonme, Gohonme, Ropponme",
                                translation: "1st, 2nd, 3rd, 4th, 5th & 6th techniques",
                            },
                        ],
                    },
                    kata: {
                        name: "Ku-Shanku, Seishan, Chinto",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                },
                Shodan: {
                    name: "Shodan (1st Dan)",
                    color: "Black Belt",
                    cssClass: "belt-black-1dan",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2023/03/SHODAN-.pdf",
                    note: "First degree black belt - demonstrates proficiency in fundamental techniques",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Kette-junzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning reverse punch",
                            },
                            {
                                name: "Tobikomizuki-jdan",
                                translation: "Leaping body-in punch to upper level",
                            },
                            {
                                name: "Nagashizuki-jdan",
                                translation: "Deflecting punch to upper level",
                            },
                            {
                                name: "Mawashi-geri-jdan",
                                translation: "Head round-house kick",
                            },
                            { name: "Sokut-jdan", translation: "Thrusting kick to upper level" },
                            { name: "Ushiro-geri-chdan", translation: "Back kick to mid level" },
                            { name: "Nidan-geri-jdan", translation: "Double kick to upper level" },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Zenshinshite-jdan  Renzuki-chdan  Mae-geri-chdan  Mawashi-geri-jdan  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step forward head  Follow punch body  Front kick body  Round-house kick head  Back kick body  Backfist strike head",
                            },
                            {
                                name: "Suri komi-jdan  Renzuki-chdan  Suri komi-sokut-jdan  Ushiro-geri-chdan  Gyakuzuki-chdan",
                                translation:
                                    "Step up upper level  Follow punch mid level  Step up thrusting kick upper level  Back kick mid level  Reverse punch mid level",
                            },
                            {
                                name: "Zenshinshite-jdan  Renzuki-chdan  Mae-geri-chdan  Nagashizuki-jdan  Gyakuzuki-chdan  Mawashi-geri-jdan  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step forward head  Follow punch body  Front kick body  Deflecting punch head  Reverse punch body  Round-house kick head  Back kick mid level  Backfist strike upper level",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            { name: "All techniques", translation: "All Sanbon-Gumite sequences" },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [
                            {
                                name: "Ipponme, Nihonme, Sanbonme, Yonhonme",
                                translation: "1st, 2nd, 3rd & 4th techniques",
                            },
                        ],
                    },
                    kihonGumite: {
                        title: "Kihon-Gumite (Basic sparring)",
                        items: [
                            {
                                name: "Ipponme, Nihonme, Sanbonme, Yonhonme",
                                translation: "1st, 2nd, 3rd & 4th techniques",
                            },
                        ],
                    },
                    machiOhyo: {
                        title: "Machi-Ohyo (Street application)",
                        items: [
                            {
                                name: "Ipponme - Happonme",
                                translation: "1st through 8th techniques",
                            },
                        ],
                    },
                    kata: {
                        name: "Three Kata from first nine (examiner's choice) + Bassai, Wanshu",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                    additional: {
                        jiyuGumite: "Free fighting",
                        hikkiShiken: "Written test required",
                    },
                },
                Nidan: {
                    name: "Nidan (2nd Dan)",
                    color: "Black Belt",
                    cssClass: "belt-black-2dan",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2023/03/NIDAN-.pdf",
                    note: "Second degree black belt - advanced technical proficiency",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Kette-junzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning reverse punch",
                            },
                            {
                                name: "Tobikomizuki-jdan",
                                translation: "Leaping body-in punch to upper level",
                            },
                            {
                                name: "Nagashizuki-jdan",
                                translation: "Deflecting punch to upper level",
                            },
                            {
                                name: "Mawashi-geri-jdan",
                                translation: "Head round-house kick",
                            },
                            { name: "Sokut-jdan", translation: "Thrusting kick to upper level" },
                            { name: "Ushiro-geri-chdan", translation: "Back kick to mid level" },
                            { name: "Nidan-geri-jdan", translation: "Double kick to upper level" },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Zenshinshite-jdan  Renzuki-chdan  Mae-geri-chdan  Mawashi-geri-jdan  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step forward head  Follow punch body  Front kick body  Round-house kick head  Back kick body  Backfist strike head",
                            },
                            {
                                name: "Suri komi-jdan  Renzuki-chdan  Suri komi-sokut-jdan  Ushiro-geri-chdan  Gyakuzuki-chdan",
                                translation:
                                    "Step up upper level  Follow punch mid level  Step up thrusting kick upper level  Back kick mid level  Reverse punch mid level",
                            },
                            {
                                name: "Zenshinshite-jdan  Renzuki-chdan  Mae-geri-chdan  Nagashizuki-jdan  Gyakuzuki-chdan  Mawashi-geri-jdan  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step forward head  Follow punch body  Front kick body  Deflecting punch head  Reverse punch body  Round-house kick head  Back kick mid level  Backfist strike upper level",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            { name: "All techniques", translation: "All Sanbon-Gumite sequences" },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [
                            {
                                name: "Gohonme, Ropponme, Nanahonme, Napponme",
                                translation: "5th, 6th, 7th & 8th techniques",
                            },
                        ],
                    },
                    kihonGumite: {
                        title: "Kihon-Gumite (Basic sparring)",
                        items: [
                            {
                                name: "Gohonme, Ropponme, Nanahonme, Napponme",
                                translation: "5th, 6th, 7th & 8th techniques",
                            },
                        ],
                    },
                    machiOhyo: {
                        title: "Machi-Ohyo (Street application)",
                        items: [
                            {
                                name: "Ipponme - Happonme",
                                translation: "1st through 8th techniques",
                            },
                        ],
                    },
                    kata: {
                        name: "Three Kata from first nine (examiner's choice) + Ni-sei-shi, Rohai",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                    additional: {
                        jiyuGumite: "Free fighting",
                        hikkiShiken: "Written test required",
                    },
                },
                Sandan: {
                    name: "Sandan (3rd Dan)",
                    color: "Black Belt",
                    cssClass: "belt-black-3dan",
                    pdf: "https://hakuba-karate.co.uk/wp-content/uploads/2023/03/SANDAN-.pdf",
                    note: "Third degree black belt - expert level proficiency",
                    kihon: {
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Kette-junzuki",
                                translation: "Front kick, landing with lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki",
                                translation: "Front kick, landing with reverse punch",
                            },
                            {
                                name: "Kette-junzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning lunge punch",
                            },
                            {
                                name: "Kette-gyakuzuki-no-tsukkomi",
                                translation: "Front kick, landing with leaning reverse punch",
                            },
                            {
                                name: "Tobikomizuki-jdan",
                                translation: "Leaping body-in punch to upper level",
                            },
                            {
                                name: "Nagashizuki-jdan",
                                translation: "Deflecting punch to upper level",
                            },
                            {
                                name: "Mawashi-geri-jdan",
                                translation: "Head round-house kick",
                            },
                            { name: "Sokut-jdan", translation: "Thrusting kick to upper level" },
                            { name: "Ushiro-geri-chdan", translation: "Back kick to mid level" },
                            { name: "Nidan-geri-jdan", translation: "Double kick to upper level" },
                        ],
                    },
                    renraku: {
                        title: "Renraku-Waza (Combination techniques)",
                        stance: "Hanmi-gamae",
                        list: [
                            {
                                name: "Zenshinshite-jdan  Renzuki-chdan  Mae-geri-chdan  Mawashi-geri-jdan  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step forward head  Follow punch body  Front kick body  Round-house kick head  Back kick body  Backfist strike head",
                            },
                            {
                                name: "Suri komi-jdan  Renzuki-chdan  Suri komi-sokut-jdan  Ushiro-geri-chdan  Gyakuzuki-chdan",
                                translation:
                                    "Step up upper level  Follow punch mid level  Step up thrusting kick upper level  Back kick mid level  Reverse punch mid level",
                            },
                            {
                                name: "Zenshinshite-jdan  Renzuki-chdan  Mae-geri-chdan  Nagashizuki-jdan  Gyakuzuki-chdan  Mawashi-geri-jdan  Ushiro-geri-chdan  Uraken-uchi-jdan",
                                translation:
                                    "Step forward head  Follow punch body  Front kick body  Deflecting punch head  Reverse punch body  Round-house kick head  Back kick mid level  Backfist strike upper level",
                            },
                        ],
                    },
                    sanbon: {
                        title: "Sanbon-Gumite (Three-step sparring)",
                        items: [
                            { name: "All techniques", translation: "All Sanbon-Gumite sequences" },
                        ],
                    },
                    ohyo: {
                        title: "Ohyo-Gumite (Application sparring)",
                        items: [
                            { name: "All techniques", translation: "All Ohyo-Gumite sequences" },
                        ],
                    },
                    kihonGumite: {
                        title: "Kihon-Gumite (Basic sparring)",
                        items: [
                            { name: "All techniques", translation: "All Kihon-Gumite sequences" },
                        ],
                    },
                    machiOhyo: {
                        title: "Machi-Ohyo (Street application)",
                        items: [
                            {
                                name: "All 1-8 plus one additional",
                                translation: "All eight techniques plus one additional technique",
                            },
                        ],
                    },
                    kata: {
                        name: "Three Kata from first nine (examiner's choice) + Ji'tte, Ji'han, Ji'in",
                        link: "https://hakuba-karate.co.uk/katas-of-wadoryu/",
                    },
                    additional: {
                        jiyuGumite: "Free fighting",
                        hikkiShiken: "Written test required",
                    },
                },
            };

            let currentBelt = "9th";
            let learnedTechniques = {};

            function initBeltSelector() {
                const selector = document.getElementById("belt-selector");
                const savedBelt = localStorage.getItem("selectedBelt") || "9th";

                Object.keys(beltData).forEach((key) => {
                    const belt = beltData[key];
                    const button = document.createElement("button");
                    button.className = "belt-button " + belt.cssClass;
                    button.dataset.belt = key;
                    button.innerHTML =
                        '<div class="belt-name">' +
                        belt.name +
                        '</div><div class="belt-color">' +
                        belt.color +
                        "</div>";
                    button.onclick = () => selectBelt(key);
                    if (key === savedBelt) button.classList.add("active");
                    selector.appendChild(button);
                });

                currentBelt = savedBelt;
                displayBelt(savedBelt);
            }

            function toggleSection(header) {
                const section = header.parentElement;
                section.classList.toggle("collapsed");
            }

            function selectBelt(key, skipScroll) {
                currentBelt = key;
                localStorage.setItem("selectedBelt", key);
                document
                    .querySelectorAll(".belt-button")
                    .forEach((btn) => btn.classList.remove("active"));
                // Find and activate the belt button by data-belt attribute
                const beltButton = document.querySelector('.belt-button[data-belt="' + key + '"]');
                if (beltButton) {
                    beltButton.classList.add("active");
                }
                displayBelt(key);
                // Scroll to the belt content (unless skipScroll is true, e.g. on page load)
                if (!skipScroll) {
                    document
                        .getElementById("belt-content")
                        .scrollIntoView({ behavior: "smooth", block: "start" });
                }
            }

            function getTechniqueCardHtml(key, tech, stanceInfo) {
                const techId = key + "-" + tech.name;
                const learned = isLearned(techId);
                const cardClass = learned ? "technique-card learned" : "technique-card";
                const btnClass = learned ? "learn-btn learned" : "learn-btn";
                const btnText = learned ? " Learned" : "Mark as learned";

                let html = '<div class="' + cardClass + '">';
                html += '<div class="japanese">' + tech.name + "</div>";
                html += '<div class="english">' + tech.translation + "</div>";
                if (stanceInfo) {
                    html +=
                        '<div class="stance-info">From: <a href="#" onclick="switchToStances(); return false;">' +
                        stanceInfo +
                        "</a></div>";
                }
                html +=
                    '<button class="' +
                    btnClass +
                    '" onclick="toggleLearned(\'' +
                    techId.replace(/'/g, "\\'") +
                    "')\">" +
                    btnText +
                    "</button>";
                html += "</div>";
                return html;
            }

            function displayBelt(key) {
                const belt = beltData[key];
                const content = document.getElementById("belt-content");
                const progress = getBeltProgress(key);

                // Get belt color for progress bar
                const beltColors = {
                    "9th": "#dc2626", // Red
                    "8th": "#fbbf24", // Yellow
                    "7th": "#f97316", // Orange
                    "6th": "#059669", // Green
                    "5th": "#2563eb", // Blue
                    "4th": "#7c3aed", // Purple
                    "3rd": "#92400e", // Brown
                    "2nd": "#92400e", // Brown
                    "1st": "#92400e", // Brown
                    Shodan: "#000", // Black
                    Nidan: "#000", // Black
                    Sandan: "#000", // Black
                };
                const beltColor = beltColors[key] || "#1e5ba8";

                let html = '<div class="card">';

                // Progress summary with belt color
                if (progress.total > 0) {
                    html +=
                        '<div class="progress-summary" style="flex-direction: column; gap: 0.75rem;">';
                    html +=
                        '<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">';
                    html +=
                        '<div class="progress-text" style="font-weight: 700; color: ' +
                        beltColor +
                        ';">' +
                        belt.color +
                        " Progress</div>";
                    html +=
                        '<div class="progress-text">' +
                        progress.learned +
                        " / " +
                        progress.total +
                        " techniques (" +
                        progress.percentage +
                        "%)</div>";
                    html += "</div>";
                    html +=
                        '<div class="progress-bar-large" style="width: 100%;"><div class="progress-bar-large-fill" style="width: ' +
                        progress.percentage +
                        "%; background: " +
                        beltColor +
                        ';"></div></div>';
                    html += "</div>";
                }

                // Belt header with requirements
                html += '<div class="belt-header-section">';
                html +=
                    '<div class="belt-indicator ' +
                    belt.cssClass +
                    '">' +
                    belt.name +
                    " - " +
                    belt.color +
                    "</div>";

                // Build compact requirements
                if (belt.note || belt.dojoKun || belt.beltTying) {
                    html += '<div class="requirements-container">';
                    html += '<span class="req-label">Also required:</span>';

                    if (belt.note) {
                        html +=
                            '<a href="#" onclick="switchTab(\'terminology\'); return false;" class="req-chip req-note"><span class="req-icon"></span><span>Japanese commands</span></a>';
                    }

                    if (belt.dojoKun) {
                        html +=
                            '<a href="#" onclick="switchTab(\'dojo-kun\'); return false;" class="req-chip req-dojo"><span class="req-icon"></span><span>Recite Dojo Kun</span></a>';
                    }

                    if (belt.beltTying) {
                        html +=
                            '<a href="#" onclick="switchTab(\'belt-tying\'); return false;" class="req-chip req-belt"><span class="req-icon"></span><span>Belt tying</span></a>';
                    }

                    html += "</div>";
                }
                html += "</div>"; // close belt-header-section

                if (belt.kihon) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>Kihon-Waza (Fundamental Techniques)</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';

                    if (belt.kihon.blocks) {
                        html += "<h4>Blocks</h4>";
                        html += '<div class="technique-grid">';
                        belt.kihon.blocks.forEach((tech) => {
                            html += getTechniqueCardHtml(
                                key,
                                tech,
                                belt.kihon.blocksStance + " (forward stance)",
                            );
                        });
                        html += "</div>";
                    }

                    if (belt.kihon.strikes) {
                        html += "<h4>Strikes</h4>";
                        html += '<div class="technique-grid">';
                        belt.kihon.strikes.forEach((tech) => {
                            html += getTechniqueCardHtml(
                                key,
                                tech,
                                belt.kihon.otherStance + " (fighting stance)",
                            );
                        });
                        html += "</div>";
                    }

                    if (belt.kihon.kicks) {
                        html += "<h4>Kicks</h4>";
                        html += '<div class="technique-grid">';
                        belt.kihon.kicks.forEach((tech) => {
                            html += getTechniqueCardHtml(
                                key,
                                tech,
                                belt.kihon.otherStance + " (fighting stance)",
                            );
                        });
                        html += "</div>";
                    }

                    if (belt.kihon.list) {
                        html += '<div class="technique-grid">';
                        belt.kihon.list.forEach((tech) => {
                            const stanceInfo = belt.kihon.stance
                                ? belt.kihon.stance + " (fighting stance)"
                                : null;
                            html += getTechniqueCardHtml(key, tech, stanceInfo);
                        });
                        html += "</div>";
                    }

                    html += "</div></div>"; // close collapsible-content and collapsible-section
                }

                if (belt.renraku) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>" + belt.renraku.title + "</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';
                    html += '<div class="technique-grid">';
                    belt.renraku.list.forEach((tech) => {
                        const stanceInfo = belt.renraku.stance
                            ? belt.renraku.stance + " (fighting stance)"
                            : null;
                        html += getTechniqueCardHtml(key, tech, stanceInfo);
                    });
                    html += "</div>";
                    html += "</div></div>";
                }

                if (belt.uke) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>" + belt.uke.title + "</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';
                    if (belt.uke.note) {
                        html +=
                            '<p style="font-style:italic;color:#6b7280;">' + belt.uke.note + "</p>";
                    }
                    html += '<div class="technique-grid">';
                    belt.uke.list.forEach((tech) => {
                        const stanceInfo = belt.uke.stance
                            ? belt.uke.stance + " (forward stance)"
                            : null;
                        html += getTechniqueCardHtml(key, tech, stanceInfo);
                    });
                    html += "</div>";
                    html += "</div></div>";
                }

                if (belt.sanbon) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>" + belt.sanbon.title + "</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';
                    html += '<div class="sparring-section"><ul>';
                    belt.sanbon.items.forEach((item) => {
                        html +=
                            '<li><span class="technique-name">' +
                            item.name +
                            "</span>: " +
                            item.translation;
                        if (item.detail) html += " " + item.detail;
                        html += "</li>";
                    });
                    html += "</ul></div>";
                    html += "</div></div>";
                }

                if (belt.ohyo) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>" + belt.ohyo.title + "</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';
                    html += '<div class="sparring-section"><ul>';
                    belt.ohyo.items.forEach((item) => {
                        html +=
                            '<li><span class="technique-name">' +
                            item.name +
                            "</span>: " +
                            item.translation +
                            "</li>";
                    });
                    html += "</ul></div>";
                    html += "</div></div>";
                }

                if (belt.kihonGumite) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>" + belt.kihonGumite.title + "</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';
                    html += '<div class="sparring-section"><ul>';
                    belt.kihonGumite.items.forEach((item) => {
                        html +=
                            '<li><span class="technique-name">' +
                            item.name +
                            "</span>: " +
                            item.translation +
                            "</li>";
                    });
                    html += "</ul></div>";
                    html += "</div></div>";
                }

                if (belt.machiOhyo) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>" + belt.machiOhyo.title + "</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';
                    html += '<div class="sparring-section"><ul>';
                    belt.machiOhyo.items.forEach((item) => {
                        html +=
                            '<li><span class="technique-name">' +
                            item.name +
                            "</span>: " +
                            item.translation +
                            "</li>";
                    });
                    html += "</ul></div>";
                    html += "</div></div>";
                }

                if (belt.kata) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>Kata</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';
                    html +=
                        '<div class="info-box"><strong>Required Kata:</strong> ' +
                        belt.kata.name +
                        "</div>";

                    // Add kata videos if available
                    const kataVideos = {
                        "Pinan Nidan": "https://www.youtube.com/embed/SM1OS-k4BCE?feature=oembed",
                        "Pinan Shodan": "https://www.youtube.com/embed/3HOPMLxlHO8?feature=oembed",
                        "Pinan Sandan": "https://www.youtube.com/embed/_PNcWV9FAp8?feature=oembed",
                        "Pinan Yodan": "https://www.youtube.com/embed/mUQFUOpp-9E?feature=oembed",
                        "Pinan Godan": "https://www.youtube.com/embed/hWV56JLPC5A?feature=oembed",
                        "Ku-Shanku": "https://www.youtube.com/embed/4iJJNeVXbI8?feature=oembed",
                        "Nai-hanchi": "https://www.youtube.com/embed/_q9mPQUwx7Y?feature=oembed",
                        Seishan: "https://www.youtube.com/embed/hntFG9WTQJE?feature=oembed",
                        Chinto: "https://www.youtube.com/embed/Gv9uPfz1tkM?feature=oembed",
                        Bassai: "https://www.youtube.com/embed/GMJyFrf4BtA?feature=oembed",
                        Wanshu: "https://www.youtube.com/embed/0Ck8rk5xDwI?feature=oembed",
                    };

                    // Find matching videos for this belt's kata
                    const kataNames = belt.kata.name.split(",").map((k) => k.trim());
                    let hasVideos = false;
                    let videoHtml =
                        '<div class="kata-videos" style="margin-top: 1.5rem;"><h4 style="margin-bottom: 1rem;">Kata Videos</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';

                    kataNames.forEach((kataName) => {
                        // Check each known kata name
                        Object.keys(kataVideos).forEach((key) => {
                            if (kataName.includes(key)) {
                                hasVideos = true;
                                videoHtml +=
                                    '<div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden;">';
                                videoHtml +=
                                    '<div style="position: relative; padding-bottom: 56.25%; height: 0;">';
                                videoHtml +=
                                    '<iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="' +
                                    kataVideos[key] +
                                    '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>';
                                videoHtml += "</div>";
                                videoHtml +=
                                    '<div style="padding: 0.75rem; font-weight: 600; color: #374151;">' +
                                    key +
                                    "</div>";
                                videoHtml += "</div>";
                            }
                        });
                    });

                    videoHtml += "</div></div>";
                    if (hasVideos) {
                        html += videoHtml;
                    }
                    html += "</div></div>"; // close kata collapsible
                }

                if (belt.additional) {
                    html += '<div class="collapsible-section">';
                    html += '<div class="collapsible-header" onclick="toggleSection(this)">';
                    html += "<h3>Additional Requirements</h3>";
                    html += '<span class="collapsible-toggle"></span>';
                    html += "</div>";
                    html += '<div class="collapsible-content">';
                    html += '<div class="sparring-section"><ul>';
                    if (belt.additional.jiyuGumite) {
                        html +=
                            '<li><span class="technique-name">Jiyu-Gumite ()</span>: ' +
                            belt.additional.jiyuGumite +
                            "</li>";
                    }
                    if (belt.additional.hikkiShiken) {
                        html +=
                            '<li><span class="technique-name">Hikki-Shiken ()</span>: ' +
                            belt.additional.hikkiShiken +
                            "</li>";
                    }
                    html += "</ul></div>";
                    html += "</div></div>";
                }

                // Add "I passed this grading" button
                const stats = getAchievementStats();
                const hasEarnedBelt = stats.earnedBelts && stats.earnedBelts.includes(key);

                html +=
                    '<div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">';
                if (hasEarnedBelt) {
                    html +=
                        '<div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 0.75rem; border: 2px solid #059669;">';
                    html += '<span style="font-size: 2rem;"></span>';
                    html += "<div>";
                    html +=
                        '<div style="font-weight: 700; color: #059669; font-size: 1.1rem;">Grading Passed!</div>';
                    html +=
                        '<div style="color: #047857;">Congratulations on earning your ' +
                        belt.color +
                        "</div>";
                    html += "</div>";
                    html +=
                        "<button onclick=\"unmarkBeltEarned('" +
                        key +
                        '\')" style="margin-left: auto; padding: 0.5rem 1rem; background: transparent; border: 1px solid #059669; color: #059669; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">Undo</button>';
                    html += "</div>";
                } else {
                    html +=
                        "<button onclick=\"markBeltEarned('" +
                        key +
                        '\')" class="btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; background: linear-gradient(135deg, ' +
                        beltColor +
                        " 0%, " +
                        beltColor +
                        'dd 100%);">';
                    html += " I Passed My " + belt.color + " Grading!";
                    html += "</button>";
                }
                html += "</div>";

                html +=
                    '<a href="' +
                    belt.pdf +
                    '" target="_blank" class="btn-primary" style="margin-top: 1rem;">Download Full Syllabus PDF </a>';
                html += "</div>";

                content.innerHTML = html;
            }

            function goHome() {
                document
                    .querySelectorAll(".nav-button")
                    .forEach((b) => b.classList.remove("active"));
                document
                    .querySelectorAll(".tab-content")
                    .forEach((t) => t.classList.remove("active"));

                document.querySelector('[data-tab="belts"]').classList.add("active");
                document.getElementById("belts-tab").classList.add("active");
                window.scrollTo(0, 0);
            }

            function switchToStances() {
                document
                    .querySelectorAll(".nav-button")
                    .forEach((b) => b.classList.remove("active"));
                document
                    .querySelectorAll(".tab-content")
                    .forEach((t) => t.classList.remove("active"));

                document.querySelector('[data-tab="stances"]').classList.add("active");
                document.getElementById("stances-tab").classList.add("active");
                window.scrollTo(0, 0);
            }

            function initTabs() {
                document.querySelectorAll(".nav-button").forEach((button) => {
                    button.addEventListener("click", function () {
                        const tabName = this.getAttribute("data-tab");

                        document
                            .querySelectorAll(".nav-button")
                            .forEach((b) => b.classList.remove("active"));
                        document
                            .querySelectorAll(".tab-content")
                            .forEach((t) => t.classList.remove("active"));

                        this.classList.add("active");
                        document.getElementById(tabName + "-tab").classList.add("active");

                        // Render achievements when tab is selected
                        if (tabName === "achievements") {
                            renderAchievements();
                        }

                        // Update daily challenge button when quiz tab is selected
                        if (tabName === "quiz") {
                            updateDailyChallengeButton();
                        }

                        // Close mobile menu when tab is clicked
                        closeMobileMenu();
                    });
                });
            }

            // Mobile menu functions
            function toggleMobileMenu() {
                const hamburger = document.getElementById("hamburger");
                const navContainer = document.getElementById("nav-container");
                const navOverlay = document.getElementById("nav-overlay");

                hamburger.classList.toggle("active");
                navContainer.classList.toggle("active");
                navOverlay.classList.toggle("active");

                // Prevent body scroll when menu is open
                if (navContainer.classList.contains("active")) {
                    document.body.style.overflow = "hidden";
                } else {
                    document.body.style.overflow = "";
                }
            }

            function closeMobileMenu() {
                const hamburger = document.getElementById("hamburger");
                const navContainer = document.getElementById("nav-container");
                const navOverlay = document.getElementById("nav-overlay");

                hamburger.classList.remove("active");
                navContainer.classList.remove("active");
                navOverlay.classList.remove("active");
                document.body.style.overflow = "";
            }

            document.addEventListener("DOMContentLoaded", function () {
                // Load learned techniques BEFORE initializing belt selector
                const savedProgress = localStorage.getItem("hakubaProgress");
                if (savedProgress) {
                    try {
                        learnedTechniques = JSON.parse(savedProgress);
                    } catch (e) {
                        learnedTechniques = {};
                    }
                }
                initBeltSelector();
                initTabs();
                updateBeltProgress();
                // Sync achievement stats with current progress
                if (typeof updateTechniqueStats === "function") {
                    updateTechniqueStats();
                }
                // Load saved quiz belt level
                const savedQuizBelt = localStorage.getItem("quizBeltLevel");
                if (savedQuizBelt !== null) {
                    document.getElementById("belt-slider").value = savedQuizBelt;
                }
                updateBeltDisplay(); // Initialize belt slider display

                // Update weak spots button
                if (typeof updateWeakSpotsButton === "function") {
                    updateWeakSpotsButton();
                }
            });

            // Quiz functionality
            const beltLevels = [
                { id: "9th", name: "9th Ky", color: "Red Belt", cssClass: "belt-red" },
                { id: "8th", name: "8th Ky", color: "Yellow Belt", cssClass: "belt-yellow" },
                { id: "7th", name: "7th Ky", color: "Orange Belt", cssClass: "belt-orange" },
                { id: "6th", name: "6th Ky", color: "Green Belt", cssClass: "belt-green" },
                { id: "5th", name: "5th Ky", color: "Blue Belt", cssClass: "belt-blue" },
                { id: "4th", name: "4th Ky", color: "Purple Belt", cssClass: "belt-purple" },
                { id: "3rd", name: "3rd Ky", color: "Brown Belt", cssClass: "belt-brown" },
                { id: "2nd", name: "2nd Ky", color: "Brown/White", cssClass: "belt-brown-white" },
                { id: "1st", name: "1st Ky", color: "Brown/Black", cssClass: "belt-brown-black" },
                { id: "Shodan", name: "Shodan", color: "1st Dan", cssClass: "belt-black-1dan" },
                { id: "Nidan", name: "Nidan", color: "2nd Dan", cssClass: "belt-black-2dan" },
                { id: "Sandan", name: "Sandan", color: "3rd Dan", cssClass: "belt-black-3dan" },
            ];

            // Achievement badges system
            const badges = [
                {
                    id: "first_steps",
                    name: "First Steps",
                    icon: "",
                    description: "Mark your first technique as learned",
                    xp: 25,
                    check: (stats) => stats.techniquesLearned >= 1,
                },
                {
                    id: "dedicated_student",
                    name: "Dedicated Student",
                    icon: "",
                    description: "Complete 10 quizzes",
                    xp: 50,
                    check: (stats) => stats.quizzesCompleted >= 10,
                },
                {
                    id: "sharpshooter",
                    name: "Sharpshooter",
                    icon: "",
                    description: "Get 100% on a quiz",
                    xp: 50,
                    check: (stats) => stats.perfectQuizzes >= 1,
                },
                {
                    id: "on_fire",
                    name: "On Fire",
                    icon: "",
                    description: "Get 5 correct answers in a row",
                    xp: 30,
                    check: (stats) => stats.bestStreak >= 5,
                },
                {
                    id: "belt_master",
                    name: "Belt Master",
                    icon: "",
                    description: "Learn all techniques for one belt",
                    xp: 100,
                    check: (stats) => stats.beltsCompleted >= 1,
                },
                {
                    id: "scholar",
                    name: "Scholar",
                    icon: "",
                    description: "Study all terminology categories in Focus Mode",
                    xp: 75,
                    check: (stats) => stats.categoriesStudied >= 8,
                },
                {
                    id: "consistent",
                    name: "Consistent",
                    icon: "",
                    description: "Practice 7 days in a row",
                    xp: 100,
                    check: (stats) => stats.practiceStreak >= 7,
                },
                {
                    id: "century",
                    name: "Century",
                    icon: "",
                    description: "Answer 100 quiz questions correctly",
                    xp: 75,
                    check: (stats) => stats.correctAnswers >= 100,
                },
                {
                    id: "perfectionist",
                    name: "Perfectionist",
                    icon: "",
                    description: "Get 100% on 5 quizzes",
                    xp: 100,
                    check: (stats) => stats.perfectQuizzes >= 5,
                },
                {
                    id: "rising_star",
                    name: "Rising Star",
                    icon: "",
                    description: "Earn 5 badges",
                    xp: 50,
                    check: (stats) => stats.badgesEarned >= 5,
                },
                {
                    id: "quiz_warrior",
                    name: "Quiz Warrior",
                    icon: "",
                    description: "Complete 50 quizzes",
                    xp: 150,
                    check: (stats) => stats.quizzesCompleted >= 50,
                },
                {
                    id: "karate_master",
                    name: "Karate Master",
                    icon: "",
                    description: "Learn all techniques across all belts",
                    xp: 500,
                    check: (stats) => stats.allTechniquesLearned,
                },
                // Belt grading achievements
                {
                    id: "red_belt",
                    name: "9th Kyu",
                    icon: "",
                    description: "Pass your Red Belt grading",
                    xp: 100,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("9th"),
                },
                {
                    id: "yellow_belt",
                    name: "8th Kyu",
                    icon: "",
                    description: "Pass your Yellow Belt grading",
                    xp: 100,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("8th"),
                },
                {
                    id: "orange_belt",
                    name: "7th Kyu",
                    icon: "",
                    description: "Pass your Orange Belt grading",
                    xp: 100,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("7th"),
                },
                {
                    id: "green_belt",
                    name: "6th Kyu",
                    icon: "",
                    description: "Pass your Green Belt grading",
                    xp: 125,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("6th"),
                },
                {
                    id: "blue_belt",
                    name: "5th Kyu",
                    icon: "",
                    description: "Pass your Blue Belt grading",
                    xp: 125,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("5th"),
                },
                {
                    id: "purple_belt",
                    name: "4th Kyu",
                    icon: "",
                    description: "Pass your Purple Belt grading",
                    xp: 150,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("4th"),
                },
                {
                    id: "brown_belt",
                    name: "3rd Kyu",
                    icon: "",
                    description: "Pass your Brown Belt grading",
                    xp: 175,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("3rd"),
                },
                {
                    id: "brown_white_belt",
                    name: "2nd Kyu",
                    icon: "",
                    description: "Pass your Brown & White Belt grading",
                    xp: 200,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("2nd"),
                },
                {
                    id: "brown_black_belt",
                    name: "1st Kyu",
                    icon: "",
                    description: "Pass your Brown & Black Belt grading",
                    xp: 250,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("1st"),
                },
                {
                    id: "shodan",
                    name: "Shodan",
                    icon: "",
                    description: "Achieve 1st Dan Black Belt",
                    xp: 500,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("Shodan"),
                },
                {
                    id: "nidan",
                    name: "Nidan",
                    icon: "",
                    description: "Achieve 2nd Dan Black Belt",
                    xp: 750,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("Nidan"),
                },
                {
                    id: "sandan",
                    name: "Sandan",
                    icon: "",
                    description: "Achieve 3rd Dan Black Belt",
                    xp: 1000,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("Sandan"),
                },
                // Milestone achievements
                {
                    id: "ten_streak",
                    name: "Unstoppable",
                    icon: "",
                    description: "Get 10 correct answers in a row",
                    xp: 75,
                    check: (stats) => stats.bestStreak >= 10,
                },
                {
                    id: "halfway_there",
                    name: "Halfway There",
                    icon: "",
                    description: "Complete 6 belt gradings",
                    xp: 200,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.length >= 6,
                },
                {
                    id: "thousand_answers",
                    name: "Knowledge Seeker",
                    icon: "",
                    description: "Answer 1000 quiz questions correctly",
                    xp: 300,
                    check: (stats) => stats.correctAnswers >= 1000,
                },
                // New achievements
                {
                    id: "quiz_champion",
                    name: "Quiz Champion",
                    icon: "",
                    description: "Complete 25 quizzes",
                    xp: 75,
                    check: (stats) => stats.quizzesCompleted >= 25,
                },
                {
                    id: "speed_demon",
                    name: "Speed Demon",
                    icon: "",
                    description: "Complete a quiz in under 60 seconds",
                    xp: 100,
                    check: (stats) => stats.fastestQuizTime && stats.fastestQuizTime < 60,
                },
                {
                    id: "night_owl",
                    name: "Night Owl",
                    icon: "",
                    description: "Practice after 10pm",
                    xp: 25,
                    check: (stats) => stats.nightOwlPractice === true,
                },
                {
                    id: "early_bird",
                    name: "Early Bird",
                    icon: "",
                    description: "Practice before 7am",
                    xp: 25,
                    check: (stats) => stats.earlyBirdPractice === true,
                },
                {
                    id: "weekend_warrior",
                    name: "Weekend Warrior",
                    icon: "",
                    description: "Practice on both Saturday and Sunday",
                    xp: 50,
                    check: (stats) => stats.weekendWarrior === true,
                },
                {
                    id: "triple_threat",
                    name: "Triple Threat",
                    icon: "",
                    description: "Get 3 perfect quizzes in a row",
                    xp: 150,
                    check: (stats) => stats.bestConsecutivePerfect >= 3,
                },
                {
                    id: "green_belt_journey",
                    name: "Green Belt Journey",
                    icon: "",
                    description: "Reach Green Belt level (6th Kyu)",
                    xp: 125,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("6th"),
                },
                {
                    id: "brown_belt_journey",
                    name: "Brown Belt Journey",
                    icon: "",
                    description: "Reach Brown Belt level (3rd Kyu)",
                    xp: 175,
                    check: (stats) => stats.earnedBelts && stats.earnedBelts.includes("3rd"),
                },
                {
                    id: "daily_dedication",
                    name: "Daily Dedication",
                    icon: "",
                    description: "Complete 7 daily challenges",
                    xp: 100,
                    check: (stats) => stats.dailyChallengesCompleted >= 7,
                },
                {
                    id: "xp_collector",
                    name: "XP Collector",
                    icon: "",
                    description: "Earn 1000 XP",
                    xp: 100,
                    check: (stats) => stats.totalXP >= 1000,
                },
            ];

            // Get achievement stats from localStorage
            function getAchievementStats() {
                const saved = localStorage.getItem("hakubaAchievements");
                const defaultStats = {
                    techniquesLearned: 0,
                    quizzesCompleted: 0,
                    perfectQuizzes: 0,
                    bestStreak: 0,
                    currentStreak: 0,
                    beltsCompleted: 0,
                    categoriesStudied: 0,
                    practiceStreak: 0,
                    lastPracticeDate: null,
                    correctAnswers: 0,
                    badgesEarned: 0,
                    allTechniquesLearned: false,
                    unlockedBadges: [],
                    studiedCategories: [],
                    earnedBelts: [],
                    // New stats for additional achievements
                    fastestQuizTime: null,
                    nightOwlPractice: false,
                    earlyBirdPractice: false,
                    weekendWarrior: false,
                    lastWeekendSaturday: null,
                    lastWeekendSunday: null,
                    consecutivePerfectQuizzes: 0,
                    bestConsecutivePerfect: 0,
                    // XP System
                    totalXP: 0,
                    level: 1,
                    // Daily Challenge
                    lastDailyChallengeDate: null,
                    dailyChallengeStreak: 0,
                    dailyChallengesCompleted: 0,
                    // Grading
                    nextGradingDate: null,
                };
                if (saved) {
                    return { ...defaultStats, ...JSON.parse(saved) };
                }
                return defaultStats;
            }

            // Save achievement stats
            function saveAchievementStats(stats) {
                localStorage.setItem("hakubaAchievements", JSON.stringify(stats));

                // Sync to cloud if logged in
                debouncedSync();
            }

            // Mark a belt as earned (passed grading)
            function markBeltEarned(beltKey) {
                const stats = getAchievementStats();
                if (!stats.earnedBelts) {
                    stats.earnedBelts = [];
                }
                if (!stats.earnedBelts.includes(beltKey)) {
                    stats.earnedBelts.push(beltKey);
                    saveAchievementStats(stats);
                    checkBadges();
                    // Re-render to show updated state
                    displayBelt(beltKey);
                }
            }

            // Unmark a belt as earned
            function unmarkBeltEarned(beltKey) {
                const stats = getAchievementStats();
                if (stats.earnedBelts) {
                    stats.earnedBelts = stats.earnedBelts.filter((b) => b !== beltKey);
                    saveAchievementStats(stats);
                    // Re-render to show updated state
                    displayBelt(beltKey);
                }
            }

            // One-time migration to award XP for existing badges
            function migrateExistingBadgeXP() {
                const stats = getAchievementStats();

                // Check if migration already done
                if (stats.badgeXPMigrated) return;

                // Calculate XP for all unlocked badges
                let earnedXP = 0;
                if (stats.unlockedBadges && stats.unlockedBadges.length > 0) {
                    stats.unlockedBadges.forEach((badgeId) => {
                        const badge = badges.find((b) => b.id === badgeId);
                        if (badge && badge.xp) {
                            earnedXP += badge.xp;
                        }
                    });

                    // Add to existing XP (don't replace)
                    stats.totalXP = (stats.totalXP || 0) + earnedXP;
                    stats.level = calculateLevel(stats.totalXP);
                }

                // Mark migration as done
                stats.badgeXPMigrated = true;
                saveAchievementStats(stats);

                if (earnedXP > 0) {
                    console.log("Migrated " + earnedXP + " XP for existing badges");
                }
            }

            // Check and unlock badges
            function checkBadges() {
                const stats = getAchievementStats();
                let newBadges = [];

                badges.forEach((badge) => {
                    if (!stats.unlockedBadges.includes(badge.id) && badge.check(stats)) {
                        stats.unlockedBadges.push(badge.id);
                        newBadges.push(badge);
                        // Award XP for unlocking badge
                        if (badge.xp) {
                            stats.totalXP = (stats.totalXP || 0) + badge.xp;
                        }
                    }
                });

                stats.badgesEarned = stats.unlockedBadges.length;
                stats.level = calculateLevel(stats.totalXP || 0);
                saveAchievementStats(stats);

                // Show toast for each new badge (includes XP info)
                newBadges.forEach((badge, index) => {
                    setTimeout(() => showBadgeToast(badge), index * 1500);
                });

                // Update XP display after badges
                if (newBadges.length > 0) {
                    updateXPDisplay();
                }

                return newBadges;
            }

            // Show badge unlock toast
            function showBadgeToast(badge) {
                const toast = document.createElement("div");
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #1e5ba8 0%, #7c3aed 100%);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 0.75rem;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    animation: slideIn 0.5s ease, slideOut 0.5s ease 3.5s forwards;
                    max-width: 320px;
                `;
                const xpText = badge.xp
                    ? `<div style="font-size: 0.875rem; color: #fef08a; font-weight: 600;">+${badge.xp} XP</div>`
                    : "";
                toast.innerHTML = `
                    <div style="font-size: 2.5rem;">${badge.icon}</div>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1rem;">Badge Unlocked!</div>
                        <div style="font-weight: 600;">${badge.name}</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">${badge.description}</div>
                        ${xpText}
                    </div>
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }

            // Update stats when technique is learned
            function updateTechniqueStats() {
                const stats = getAchievementStats();

                // Count learned techniques from learnedTechniques object (not localStorage with learned_ prefix)
                const learned = Object.keys(learnedTechniques).length;
                stats.techniquesLearned = learned;

                // Check if any belt is complete - use same logic as getBeltProgress
                let beltsCompleted = 0;
                let totalTechniques = 0;

                Object.keys(beltData).forEach((beltKey) => {
                    const belt = beltData[beltKey];
                    let beltTotal = 0;
                    let beltLearned = 0;

                    // Count kihon techniques
                    if (belt.kihon) {
                        if (belt.kihon.blocks) {
                            belt.kihon.blocks.forEach((t) => {
                                beltTotal++;
                                if (learnedTechniques[beltKey + "-" + t.name]) beltLearned++;
                            });
                        }
                        if (belt.kihon.strikes) {
                            belt.kihon.strikes.forEach((t) => {
                                beltTotal++;
                                if (learnedTechniques[beltKey + "-" + t.name]) beltLearned++;
                            });
                        }
                        if (belt.kihon.kicks) {
                            belt.kihon.kicks.forEach((t) => {
                                beltTotal++;
                                if (learnedTechniques[beltKey + "-" + t.name]) beltLearned++;
                            });
                        }
                        if (belt.kihon.list) {
                            belt.kihon.list.forEach((t) => {
                                beltTotal++;
                                if (learnedTechniques[beltKey + "-" + t.name]) beltLearned++;
                            });
                        }
                    }

                    // Count renraku techniques
                    if (belt.renraku && belt.renraku.list) {
                        belt.renraku.list.forEach((t) => {
                            beltTotal++;
                            if (learnedTechniques[beltKey + "-" + t.name]) beltLearned++;
                        });
                    }

                    // Count uke techniques
                    if (belt.uke && belt.uke.list) {
                        belt.uke.list.forEach((t) => {
                            beltTotal++;
                            if (learnedTechniques[beltKey + "-" + t.name]) beltLearned++;
                        });
                    }

                    totalTechniques += beltTotal;
                    if (beltTotal > 0 && beltLearned >= beltTotal) {
                        beltsCompleted++;
                    }
                });

                stats.beltsCompleted = beltsCompleted;
                stats.allTechniquesLearned = learned >= totalTechniques && totalTechniques > 0;

                // Update practice streak
                const today = new Date().toDateString();
                if (stats.lastPracticeDate !== today) {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (stats.lastPracticeDate === yesterday) {
                        stats.practiceStreak++;
                    } else if (stats.lastPracticeDate !== today) {
                        stats.practiceStreak = 1;
                    }
                    stats.lastPracticeDate = today;
                }

                saveAchievementStats(stats);
                checkBadges();
            }

            // Update stats when quiz is completed
            function updateQuizStats(score, total, currentStreakCount, quizTimeSeconds) {
                const stats = getAchievementStats();
                stats.quizzesCompleted++;
                stats.correctAnswers += score;

                if (score === total && total > 0) {
                    stats.perfectQuizzes++;
                    // Track consecutive perfect quizzes
                    stats.consecutivePerfectQuizzes = (stats.consecutivePerfectQuizzes || 0) + 1;
                    if (stats.consecutivePerfectQuizzes > (stats.bestConsecutivePerfect || 0)) {
                        stats.bestConsecutivePerfect = stats.consecutivePerfectQuizzes;
                    }
                } else {
                    stats.consecutivePerfectQuizzes = 0;
                }

                if (currentStreakCount > stats.bestStreak) {
                    stats.bestStreak = currentStreakCount;
                }

                // Track fastest quiz time
                if (
                    quizTimeSeconds &&
                    (!stats.fastestQuizTime || quizTimeSeconds < stats.fastestQuizTime)
                ) {
                    stats.fastestQuizTime = quizTimeSeconds;
                }

                // Check time of day for Night Owl / Early Bird
                const hour = new Date().getHours();
                if (hour >= 22 || hour < 5) {
                    stats.nightOwlPractice = true;
                }
                if (hour >= 5 && hour < 7) {
                    stats.earlyBirdPractice = true;
                }

                // Check for Weekend Warrior
                const now = new Date();
                const dayOfWeek = now.getDay();
                const weekId = getWeekId(now);

                if (dayOfWeek === 6) {
                    // Saturday
                    stats.lastWeekendSaturday = weekId;
                } else if (dayOfWeek === 0) {
                    // Sunday
                    stats.lastWeekendSunday = weekId;
                }

                if (
                    stats.lastWeekendSaturday === stats.lastWeekendSunday &&
                    stats.lastWeekendSaturday
                ) {
                    stats.weekendWarrior = true;
                }

                // Update practice streak
                const today = new Date().toDateString();
                if (stats.lastPracticeDate !== today) {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (stats.lastPracticeDate === yesterday) {
                        stats.practiceStreak++;
                    } else {
                        stats.practiceStreak = 1;
                    }
                    stats.lastPracticeDate = today;
                }

                saveAchievementStats(stats);
                checkBadges();

                // Award XP for quiz completion
                let xpEarned = XP_AWARDS.quizComplete;
                xpEarned += score * XP_AWARDS.correctAnswer;
                if (score === total && total > 0) {
                    xpEarned += XP_AWARDS.perfectQuiz;
                }
                awardXP(xpEarned, "Quiz completed");
            }

            // Helper to get a unique week identifier
            function getWeekId(date) {
                const startOfYear = new Date(date.getFullYear(), 0, 1);
                const weekNum = Math.ceil(
                    ((date - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7,
                );
                return date.getFullYear() + "-W" + weekNum;
            }

            // ==========================================
            // XP SYSTEM
            // ==========================================
            const XP_AWARDS = {
                quizComplete: 10,
                perfectQuiz: 25,
                correctAnswer: 2,
                techniqueLearned: 5,
                dailyLogin: 10,
                streakBonus: 5,
                dailyChallenge: 50,
                dailyChallengePerfect: 25,
            };

            const LEVEL_THRESHOLDS = [
                0, 100, 250, 500, 800, 1200, 1700, 2300, 3000, 4000, 5000, 6500, 8000, 10000, 12500,
                15000, 18000, 22000, 27000, 35000,
            ];

            function calculateLevel(xp) {
                for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
                    if (xp >= LEVEL_THRESHOLDS[i]) {
                        return i + 1;
                    }
                }
                return 1;
            }

            function getXPForNextLevel(currentXP) {
                const level = calculateLevel(currentXP);
                if (level >= LEVEL_THRESHOLDS.length) return null;
                return LEVEL_THRESHOLDS[level];
            }

            function awardXP(amount, reason) {
                const stats = getAchievementStats();
                const oldLevel = calculateLevel(stats.totalXP || 0);
                stats.totalXP = (stats.totalXP || 0) + amount;
                const newLevel = calculateLevel(stats.totalXP);
                stats.level = newLevel;
                saveAchievementStats(stats);

                showXPPopup(amount, reason);

                if (newLevel > oldLevel) {
                    showLevelUpPopup(newLevel);
                }

                checkBadges();
                updateXPDisplay();
                return stats.totalXP;
            }

            function showXPPopup(amount, reason) {
                const popup = document.createElement("div");
                popup.innerHTML = "+" + amount + " XP";
                popup.style.cssText =
                    "position: fixed; top: 80px; right: 20px; background: linear-gradient(135deg, #8b5cf6, #6366f1); " +
                    "color: white; padding: 0.75rem 1.25rem; border-radius: 2rem; font-weight: 700; font-size: 1rem; " +
                    "box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); z-index: 9999; " +
                    "animation: xpSlideIn 0.3s ease forwards;";
                document.body.appendChild(popup);
                setTimeout(() => {
                    popup.style.opacity = "0";
                    popup.style.transition = "opacity 0.3s";
                    setTimeout(() => popup.remove(), 300);
                }, 1500);
            }

            function showLevelUpPopup(level) {
                const overlay = document.createElement("div");
                overlay.style.cssText =
                    "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); " +
                    "display: flex; align-items: center; justify-content: center; z-index: 10000;";
                const popup = document.createElement("div");
                popup.innerHTML =
                    '<div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>' +
                    '<div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">Level Up!</div>' +
                    '<div style="font-size: 1.125rem; opacity: 0.9;">You reached Level ' +
                    level +
                    "</div>";
                popup.style.cssText =
                    "background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 2rem 3rem; " +
                    "border-radius: 1rem; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); " +
                    "transform: scale(0.8); animation: levelUpPop 0.3s ease forwards;";
                overlay.appendChild(popup);
                document.body.appendChild(overlay);
                overlay.onclick = () => overlay.remove();
                setTimeout(() => overlay.remove(), 3000);
            }

            function updateXPDisplay() {
                const stats = getAchievementStats();
                const xp = stats.totalXP || 0;
                const level = calculateLevel(xp);
                const nextLevelXP = getXPForNextLevel(xp);
                const prevLevelXP = LEVEL_THRESHOLDS[level - 1] || 0;

                const levelEl = document.getElementById("user-level");
                const xpBarEl = document.getElementById("xp-bar-fill");
                const xpTextEl = document.getElementById("xp-text");

                if (levelEl) levelEl.textContent = "Lvl " + level;
                if (xpBarEl && nextLevelXP) {
                    const progress = ((xp - prevLevelXP) / (nextLevelXP - prevLevelXP)) * 100;
                    xpBarEl.style.width = progress + "%";
                }
                if (xpTextEl) {
                    xpTextEl.textContent = nextLevelXP
                        ? xp + " / " + nextLevelXP + " XP"
                        : xp + " XP (Max Level)";
                }
            }

            // Update stats when category is studied
            function updateCategoryStats(category) {
                const stats = getAchievementStats();
                if (!stats.studiedCategories.includes(category)) {
                    stats.studiedCategories.push(category);
                    stats.categoriesStudied = stats.studiedCategories.length;
                    saveAchievementStats(stats);
                    checkBadges();
                }
            }

            // ==========================================
            // DAILY CHALLENGE
            // ==========================================
            let isDailyChallenge = false;

            function getDailySeed() {
                const today = new Date();
                return today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
            }

            function seededRandom(seed) {
                const x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            }

            function shuffleWithSeed(array, seed) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(seededRandom(seed + i) * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            function getTodayString() {
                return new Date().toISOString().split("T")[0];
            }

            function hasDoneDailyChallenge() {
                const stats = getAchievementStats();
                return stats.lastDailyChallengeDate === getTodayString();
            }

            function updateDailyChallengeButton() {
                const statusEl = document.getElementById("daily-challenge-status");
                const btn = document.getElementById("daily-challenge-btn");
                if (!statusEl || !btn) return;

                // Get user's current belt level from slider
                const sliderValue = parseInt(document.getElementById("belt-slider").value) || 0;
                const currentBeltInfo = beltLevels[sliderValue];

                if (hasDoneDailyChallenge()) {
                    statusEl.textContent = " Completed today!";
                    btn.style.opacity = "0.7";
                } else {
                    statusEl.innerHTML = "Up to " + currentBeltInfo.color + " | +50 XP bonus!";
                    btn.style.opacity = "1";
                }
            }

            function startDailyChallenge() {
                if (hasDoneDailyChallenge()) {
                    alert(
                        "You have already completed today's Daily Challenge! Come back tomorrow for a new one.",
                    );
                    return;
                }

                isDailyChallenge = true;

                // Reset quiz state
                score = 0;
                skipped = 0;
                currentQuestion = 0;
                answered = false;
                categoryStats = {};
                streakCount = 0;
                currentStreak = 0;

                // Get user's current belt level from slider
                const sliderValue = parseInt(document.getElementById("belt-slider").value) || 0;
                const includedBelts = beltLevels.slice(0, sliderValue + 1);
                const beltIds = includedBelts.map((b) => b.id);

                // Filter terms by user's belt level
                const filteredTerms = quizTerms.filter((q) => beltIds.includes(q.belt));

                // Use seeded random to get consistent questions for the day (but filtered by belt)
                const seed = getDailySeed();
                const shuffledTerms = shuffleWithSeed(filteredTerms, seed);
                currentQuiz = shuffledTerms.slice(0, 10);

                // Initialize category stats
                currentQuiz.forEach((q) => {
                    if (!categoryStats[q.category]) {
                        categoryStats[q.category] = {
                            correct: 0,
                            incorrect: 0,
                            skipped: 0,
                            total: 0,
                        };
                    }
                    categoryStats[q.category].total++;
                });

                // Show quiz
                document.getElementById("quiz-start").style.display = "none";
                document.getElementById("quiz-complete").style.display = "none";
                document.getElementById("quiz-active").style.display = "block";

                quizStartTime = Date.now();

                // Display difficulty indicator with belt info
                const currentBeltInfo = beltLevels[sliderValue];
                document.getElementById("quiz-difficulty-display").textContent =
                    "Daily Challenge - Up to " + currentBeltInfo.color;

                displayQuestion();
            }

            function completeDailyChallenge(score, total) {
                const stats = getAchievementStats();
                stats.lastDailyChallengeDate = getTodayString();
                stats.dailyChallengesCompleted = (stats.dailyChallengesCompleted || 0) + 1;

                // Update daily challenge streak
                const yesterday = new Date(Date.now() - 86400000).toISOString().split("T")[0];
                if (stats.previousDailyChallengeDate === yesterday) {
                    stats.dailyChallengeStreak = (stats.dailyChallengeStreak || 0) + 1;
                } else {
                    stats.dailyChallengeStreak = 1;
                }
                stats.previousDailyChallengeDate = stats.lastDailyChallengeDate;

                saveAchievementStats(stats);

                // Award XP
                let xpEarned = XP_AWARDS.dailyChallenge;
                if (score === total && total > 0) {
                    xpEarned += XP_AWARDS.dailyChallengePerfect;
                }
                awardXP(xpEarned, "Daily Challenge");

                updateDailyChallengeButton();
                isDailyChallenge = false;
            }

            // ==========================================
            // GRADING COUNTDOWN
            // ==========================================
            function updateGradingCountdown() {
                const stats = getAchievementStats();
                const countdownContainer = document.getElementById("grading-countdown-container");
                const setContainer = document.getElementById("grading-set-container");
                const dateInput = document.getElementById("grading-date-input");

                if (!countdownContainer || !setContainer) return;

                if (stats.nextGradingDate) {
                    const gradingDate = new Date(stats.nextGradingDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    gradingDate.setHours(0, 0, 0, 0);

                    const diffTime = gradingDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        // Grading date has passed
                        clearGradingDate();
                        return;
                    }

                    // Update days count
                    document.getElementById("grading-days-count").textContent = diffDays;

                    // Update date display
                    document.getElementById("grading-date-display").textContent =
                        gradingDate.toLocaleDateString("en-GB", {
                            weekday: "long",
                            day: "numeric",
                            month: "long",
                        });

                    // Update progress ring (based on 90 days max)
                    const maxDays = 90;
                    const progress = Math.min(diffDays / maxDays, 1);
                    const circumference = 2 * Math.PI * 42; // ~264
                    const offset = circumference * (1 - progress);
                    const ringProgress = document.getElementById("grading-ring-progress");
                    if (ringProgress) {
                        ringProgress.style.strokeDashoffset = offset;
                        // Change color based on urgency
                        if (diffDays <= 7) {
                            ringProgress.style.stroke = "#ef4444"; // Red - urgent!
                        } else if (diffDays <= 21) {
                            ringProgress.style.stroke = "#f59e0b"; // Orange - getting close
                        } else {
                            ringProgress.style.stroke = "#fbbf24"; // Yellow/Gold - plenty of time
                        }
                    }

                    // Motivational message based on time remaining
                    const messageEl = document.getElementById("grading-message");
                    let message = "";
                    if (diffDays === 0) {
                        message = " Grading day! You've got this!";
                    } else if (diffDays === 1) {
                        message = " Tomorrow! Rest well tonight.";
                    } else if (diffDays <= 3) {
                        message = " Almost there! Final preparations!";
                    } else if (diffDays <= 7) {
                        message = " One week to go - stay focused!";
                    } else if (diffDays <= 14) {
                        message = " Two weeks - keep practicing!";
                    } else if (diffDays <= 30) {
                        message = " Train consistently!";
                    } else {
                        message = " Plenty of time - train hard!";
                    }
                    messageEl.textContent = message;

                    countdownContainer.style.display = "block";
                    setContainer.style.display = "none";
                } else {
                    countdownContainer.style.display = "none";
                    setContainer.style.display = "flex";
                    // Clear the date input when no date is set
                    if (dateInput) dateInput.value = "";
                }
            }

            function setGradingDate(dateStr) {
                if (dateStr) {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        const stats = getAchievementStats();
                        stats.nextGradingDate = dateStr;
                        saveAchievementStats(stats);
                        updateGradingCountdown();
                        debouncedSync();
                    }
                }
            }

            function clearGradingDate() {
                const stats = getAchievementStats();
                stats.nextGradingDate = null;
                saveAchievementStats(stats);
                updateGradingCountdown();
            }

            // Render achievements page
            function renderAchievements() {
                const stats = getAchievementStats();
                const grid = document.getElementById("achievements-grid");
                const earnedEl = document.getElementById("badges-earned");
                const totalEl = document.getElementById("badges-total");

                earnedEl.textContent = stats.unlockedBadges.length;
                totalEl.textContent = badges.length;

                // Update XP display
                updateXPDisplay();

                grid.innerHTML = badges
                    .map((badge) => {
                        const unlocked = stats.unlockedBadges.includes(badge.id);
                        const xpDisplay = badge.xp
                            ? `<div style="margin-top: 0.5rem; color: ${unlocked ? "#7c3aed" : "#9ca3af"}; font-weight: 600; font-size: 0.875rem;">${unlocked ? "+" : ""}${badge.xp} XP</div>`
                            : "";
                        return `
                        <div style="
                            background: ${unlocked ? "white" : "#f3f4f6"};
                            border: 2px solid ${unlocked ? "#1e5ba8" : "#e5e7eb"};
                            border-radius: 0.75rem;
                            padding: 1.5rem;
                            text-align: center;
                            opacity: ${unlocked ? "1" : "0.6"};
                            transition: all 0.2s;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem; ${unlocked ? "" : "filter: grayscale(100%);"}">${badge.icon}</div>
                            <div style="font-weight: 700; font-size: 1.25rem; color: ${unlocked ? "#1e5ba8" : "#9ca3af"}; margin-bottom: 0.5rem;">${badge.name}</div>
                            <div style="color: ${unlocked ? "#4b5563" : "#9ca3af"}; font-size: 0.95rem;">${badge.description}</div>
                            ${xpDisplay}
                            ${unlocked ? '<div style="margin-top: 0.5rem; color: #059669; font-weight: 600; font-size: 0.875rem;"> Unlocked</div>' : ""}
                        </div>
                    `;
                    })
                    .join("");
            }

            const quizTerms = [
                // 9th Kyu (Red Belt) - Absolute basics
                {
                    term: "Jdan-uke",
                    answer: "Upper block",
                    category: "Block",
                    belt: "9th",
                    wrong: ["Inner block", "Lower block", "Outer block"],
                },
                {
                    term: "Soto-uke",
                    answer: "Outer block",
                    category: "Block",
                    belt: "9th",
                    wrong: ["Inner block", "Upper block", "Lower block"],
                },
                {
                    term: "Uchi-uke",
                    answer: "Inner block",
                    category: "Block",
                    belt: "9th",
                    wrong: ["Outer block", "Upper block", "Lower block"],
                },
                {
                    term: "Gedan-barai",
                    answer: "Lower sweeping block",
                    category: "Block",
                    belt: "9th",
                    wrong: ["Upper block", "Inner block", "Outer block"],
                },
                {
                    term: "Jdan",
                    answer: "Upper level",
                    category: "Level",
                    belt: "9th",
                    wrong: ["Mid level", "Lower level", "Side level"],
                },
                {
                    term: "Chdan",
                    answer: "Mid level",
                    category: "Level",
                    belt: "9th",
                    wrong: ["Upper level", "Lower level", "Front level"],
                },
                {
                    term: "Gedan",
                    answer: "Lower level",
                    category: "Level",
                    belt: "9th",
                    wrong: ["Upper level", "Mid level", "Front level"],
                },
                {
                    term: "Mae-geri",
                    answer: "Front kick",
                    category: "Kick",
                    belt: "9th",
                    wrong: ["Back kick", "Round-house kick", "Thrusting kick"],
                },
                {
                    term: "Mawashi-geri",
                    answer: "Round-house kick",
                    category: "Kick",
                    belt: "9th",
                    wrong: ["Front kick", "Thrusting kick", "Back kick"],
                },
                {
                    term: "Uraken",
                    answer: "Backfist",
                    category: "Strike",
                    belt: "9th",
                    wrong: ["Elbow strike", "Reverse punch", "Orthodox punch"],
                },
                {
                    term: "Yi",
                    answer: "Ready",
                    category: "Command",
                    belt: "9th",
                    wrong: ["Begin", "Stop", "Turn around"],
                },
                {
                    term: "Rei",
                    answer: "Bow",
                    category: "Command",
                    belt: "9th",
                    wrong: ["Ready", "Begin", "Stop"],
                },
                {
                    term: "Hajime",
                    answer: "Begin",
                    category: "Command",
                    belt: "9th",
                    wrong: ["Stop", "Ready", "Turn around"],
                },
                {
                    term: "Yame",
                    answer: "Stop",
                    category: "Command",
                    belt: "9th",
                    wrong: ["Begin", "Ready", "Bow"],
                },
                {
                    term: "Junzuki-dachi",
                    answer: "Orthodox punch stance",
                    category: "Stance",
                    belt: "9th",
                    wrong: ["Fighting stance", "Reverse punch stance", "Horse riding stance"],
                },
                {
                    term: "Hanmi-gamae",
                    answer: "Half-body posture (Fighting stance)",
                    category: "Stance",
                    belt: "9th",
                    wrong: ["Orthodox punch stance", "Horse riding stance", "Cat stance"],
                },
                {
                    term: "Kata",
                    answer: "Form",
                    category: "General",
                    belt: "9th",
                    wrong: ["Sparring", "Technique", "Stance"],
                },
                {
                    term: "Kihon",
                    answer: "Basics / Fundamentals",
                    category: "General",
                    belt: "9th",
                    wrong: ["Sparring", "Form", "Technique"],
                },
                {
                    term: "Kumite",
                    answer: "Sparring",
                    category: "General",
                    belt: "9th",
                    wrong: ["Form", "Basics", "Technique"],
                },
                {
                    term: "Ichi",
                    answer: "One",
                    category: "Number",
                    belt: "9th",
                    wrong: ["Two", "Three", "Five"],
                },
                {
                    term: "Ni",
                    answer: "Two",
                    category: "Number",
                    belt: "9th",
                    wrong: ["One", "Three", "Four"],
                },
                {
                    term: "San",
                    answer: "Three",
                    category: "Number",
                    belt: "9th",
                    wrong: ["Two", "Four", "Five"],
                },
                {
                    term: "Go",
                    answer: "Five",
                    category: "Number",
                    belt: "9th",
                    wrong: ["One", "Three", "Four"],
                },

                // 8th Kyu (Yellow Belt) - Building on basics
                {
                    term: "Gyakuzuki",
                    answer: "Reverse punch",
                    category: "Strike",
                    belt: "8th",
                    wrong: ["Orthodox punch", "Backfist", "Elbow strike"],
                },
                {
                    term: "Junzuki",
                    answer: "Orthodox punch",
                    category: "Strike",
                    belt: "8th",
                    wrong: ["Reverse punch", "Backfist", "Elbow strike"],
                },
                {
                    term: "Mawatte",
                    answer: "Turn around",
                    category: "Command",
                    belt: "8th",
                    wrong: ["Begin", "Stop", "Ready"],
                },
                {
                    term: "Sokut",
                    answer: "Thrusting kick (Blade foot)",
                    category: "Kick",
                    belt: "8th",
                    wrong: ["Front kick", "Back kick", "Round-house kick"],
                },
                {
                    term: "Suri komi",
                    answer: "Step up",
                    category: "Movement",
                    belt: "8th",
                    wrong: ["Sliding step", "Turn around", "Advancing"],
                },

                // 7th Kyu (Orange Belt)
                {
                    term: "Tsukkomi",
                    answer: "Leaning",
                    category: "Movement",
                    belt: "7th",
                    wrong: ["Step up", "Sliding step", "Advancing"],
                },
                {
                    term: "Gyakuzuki-dachi",
                    answer: "Reverse punch stance",
                    category: "Stance",
                    belt: "7th",
                    wrong: ["Orthodox punch stance", "Fighting stance", "Horse riding stance"],
                },
                {
                    term: "Enpi Uchi",
                    answer: "Elbow strike",
                    category: "Strike",
                    belt: "7th",
                    wrong: ["Backfist", "Reverse punch", "Orthodox punch"],
                },
                {
                    term: "Ipponme",
                    answer: "First technique",
                    category: "Number",
                    belt: "7th",
                    wrong: ["Second technique", "Third technique", "Fifth technique"],
                },
                {
                    term: "Nihonme",
                    answer: "Second technique",
                    category: "Number",
                    belt: "7th",
                    wrong: ["First technique", "Third technique", "Fourth technique"],
                },
                {
                    term: "Sanbonme",
                    answer: "Third technique",
                    category: "Number",
                    belt: "7th",
                    wrong: ["Second technique", "Fourth technique", "Fifth technique"],
                },

                // 6th Kyu (Green Belt)
                {
                    term: "Suri ashi",
                    answer: "Sliding step",
                    category: "Movement",
                    belt: "6th",
                    wrong: ["Step up", "Leaning", "Advancing"],
                },
                {
                    term: "Tobikomizuki",
                    answer: "Leaping body-in punch",
                    category: "Strike",
                    belt: "6th",
                    wrong: ["Reverse punch", "Orthodox punch", "Flowing punch"],
                },
                {
                    term: "Yonhonme",
                    answer: "Fourth technique",
                    category: "Number",
                    belt: "6th",
                    wrong: ["Second technique", "Third technique", "Fifth technique"],
                },

                // 5th Kyu (Blue Belt)
                {
                    term: "Ushiro-geri",
                    answer: "Back kick",
                    category: "Kick",
                    belt: "5th",
                    wrong: ["Front kick", "Thrusting kick", "Round-house kick"],
                },
                {
                    term: "Nagashizuki",
                    answer: "Flowing punch",
                    category: "Strike",
                    belt: "5th",
                    wrong: ["Leaping body-in punch", "Orthodox punch", "Reverse punch"],
                },
                {
                    term: "Gohonme",
                    answer: "Fifth technique",
                    category: "Number",
                    belt: "5th",
                    wrong: ["First technique", "Third technique", "Fourth technique"],
                },
                {
                    term: "Tobi-geri",
                    answer: "Jumping kick",
                    category: "Kick",
                    belt: "5th",
                    wrong: ["Front kick", "Thrusting kick", "Round-house kick"],
                },

                // 4th Kyu (Purple Belt)
                {
                    term: "Ropponme",
                    answer: "Sixth technique",
                    category: "Number",
                    belt: "4th",
                    wrong: ["Fifth technique", "Seventh technique", "Eighth technique"],
                },
                {
                    term: "Shut-uke",
                    answer: "Knife hand block",
                    category: "Block",
                    belt: "4th",
                    wrong: ["Upper block", "Inner block", "Outer block"],
                },
                {
                    term: "Morote-uke",
                    answer: "Double hand block",
                    category: "Block",
                    belt: "4th",
                    wrong: ["Upper block", "Knife hand block", "Lower sweeping block"],
                },

                // 3rd Kyu+ (Brown/Black) - Advanced terms
                {
                    term: "Maai",
                    answer: "Distancing and timing",
                    category: "Wado Technique",
                    belt: "3rd",
                    wrong: ["Unbalancing", "Body movement", "Initiative"],
                },
                {
                    term: "Kuzushi",
                    answer: "Unbalancing your opponent",
                    category: "Wado Technique",
                    belt: "3rd",
                    wrong: ["Distancing", "Body movement", "Initiative"],
                },
                {
                    term: "Tai sabaki",
                    answer: "Body movement",
                    category: "Wado Technique",
                    belt: "3rd",
                    wrong: ["Distancing", "Unbalancing", "Initiative"],
                },
                {
                    term: "Zanshin",
                    answer: "Remaining mind",
                    category: "Wado Technique",
                    belt: "3rd",
                    wrong: ["Clear mind", "Preparatory mind", "Concentrating mind"],
                },
                {
                    term: "Mushin",
                    answer: "Clear mind",
                    category: "Wado Technique",
                    belt: "3rd",
                    wrong: ["Remaining mind", "Preparatory mind", "Concentrating mind"],
                },
            ];
            let currentQuiz = [];
            let currentQuestion = 0;
            let score = 0;
            let skipped = 0;
            let answered = false;
            let currentDifficulty = "beginner";
            let categoryStats = {};
            let quizHistory = [];
            let streakCount = 0;
            let currentStreak = 0;
            let missedQuestions = [];
            let timerInterval = null;
            let quizStartTime = 0;

            // Load saved data
            function loadUserData() {
                const saved = localStorage.getItem("hakubaProgress");
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.currentBelt) {
                        selectBelt(data.currentBelt, true);
                    }
                    if (data.quizHistory) {
                        quizHistory = data.quizHistory;
                    }
                    if (data.notes) {
                        window.userNotes = data.notes;
                    }
                    if (data.bookmarks) {
                        window.userBookmarks = data.bookmarks;
                    }
                    if (data.darkMode) {
                        toggleDarkMode(true);
                    }
                }
            }

            // Save user data
            function saveUserData() {
                const data = {
                    currentBelt: document.querySelector(".belt-button.active")?.dataset?.belt,
                    quizHistory: quizHistory.slice(-20), // Keep last 20
                    notes: window.userNotes || {},
                    bookmarks: window.userBookmarks || {},
                    darkMode: document.body.classList.contains("dark-mode"),
                };
                localStorage.setItem("hakubaProgress", JSON.stringify(data));

                // Sync to cloud if logged in
                debouncedSync();
            }

            function updateBeltDisplay() {
                const sliderValue = parseInt(document.getElementById("belt-slider").value);
                localStorage.setItem("quizBeltLevel", sliderValue);
                const belt = beltLevels[sliderValue];

                // Update badge
                const badge = document.getElementById("belt-badge");
                badge.textContent = belt.name + " - " + belt.color;
                badge.className = belt.cssClass;

                // Get included belts
                const includedBelts = beltLevels.slice(0, sliderValue + 1);
                const beltNames = includedBelts.map((b) => b.color).join(", ");
                document.getElementById("included-belts").textContent = "Testing: " + beltNames;

                // Count available questions
                const beltIds = includedBelts.map((b) => b.id);
                const availableQuestions = quizTerms.filter((q) => beltIds.includes(q.belt));
                document.getElementById("question-count").textContent =
                    "~" + availableQuestions.length + " available questions";
            }

            function exitQuiz() {
                document.getElementById("quiz-active").style.display = "none";
                document.getElementById("quiz-complete").style.display = "none";
                document.getElementById("quiz-start").style.display = "block";
            }

            function updateProgressBar() {
                const progress = ((currentQuestion + 1) / currentQuiz.length) * 100;
                document.getElementById("quiz-progress-fill").style.width = progress + "%";
            }

            // Spaced repetition - track wrong answers
            function getQuizHistory() {
                const data = localStorage.getItem("quizHistory");
                return data ? JSON.parse(data) : {};
            }

            function saveQuizHistory(history) {
                localStorage.setItem("quizHistory", JSON.stringify(history));

                // Sync to cloud if logged in
                debouncedSync();
            }

            function recordQuizAnswer(term, correct) {
                const history = getQuizHistory();
                if (!history[term]) {
                    history[term] = { wrong: 0, correct: 0, lastSeen: 0 };
                }
                if (correct) {
                    history[term].correct++;
                    // Reduce wrong count on correct answer (but not below 0)
                    history[term].wrong = Math.max(0, history[term].wrong - 1);
                } else {
                    history[term].wrong++;
                }
                history[term].lastSeen = Date.now();
                saveQuizHistory(history);
                updateWeakSpotsButton();
            }

            function getWeakSpots() {
                const history = getQuizHistory();
                const weakSpots = [];

                for (const [term, record] of Object.entries(history)) {
                    // Term is a weak spot if wrong count is 2 or more
                    if (record.wrong >= 2) {
                        // Find the quiz term data
                        const termData = quizTerms.find((q) => q.term === term);
                        if (termData) {
                            weakSpots.push({ ...termData, wrongCount: record.wrong });
                        }
                    }
                }

                // Sort by wrong count (most wrong first)
                weakSpots.sort((a, b) => b.wrongCount - a.wrongCount);
                return weakSpots;
            }

            function updateWeakSpotsButton() {
                const weakSpots = getWeakSpots();
                const btn = document.getElementById("weak-spots-btn");
                const countSpan = document.getElementById("weak-spots-count");

                if (weakSpots.length >= 3) {
                    btn.style.display = "inline-flex";
                    countSpan.textContent = weakSpots.length + " terms to practice";
                } else {
                    btn.style.display = "none";
                }
            }

            function startWeakSpotsQuiz() {
                const weakSpots = getWeakSpots();

                if (weakSpots.length < 3) {
                    alert("You need at least 3 weak spots to start this quiz. Keep practicing!");
                    return;
                }

                // Reset
                score = 0;
                skipped = 0;
                currentQuestion = 0;
                answered = false;
                categoryStats = {};
                streakCount = 0;
                currentStreak = 0;

                // Use weak spots as the quiz, max 10 questions
                currentQuiz = weakSpots.slice(0, Math.min(10, weakSpots.length));

                // Initialize category stats
                currentQuiz.forEach((q) => {
                    if (!categoryStats[q.category]) {
                        categoryStats[q.category] = { correct: 0, total: 0 };
                    }
                    categoryStats[q.category].total++;
                });

                document.getElementById("quiz-start").style.display = "none";
                document.getElementById("quiz-active").style.display = "block";
                document.getElementById("quiz-result").style.display = "none";
                document.getElementById("quiz-total").textContent = currentQuiz.length;
                document.getElementById("quiz-title").textContent = "Practice Weak Spots";

                showQuestion();
            }

            function startQuiz() {
                // Reset
                score = 0;
                skipped = 0;
                currentQuestion = 0;
                answered = false;
                categoryStats = {};
                streakCount = 0;
                currentStreak = 0;

                // Get selected belt level
                const sliderValue = parseInt(document.getElementById("belt-slider").value);
                const selectedBelt = beltLevels[sliderValue];

                // Get all belts up to and including selected
                const includedBelts = beltLevels.slice(0, sliderValue + 1);
                const beltIds = includedBelts.map((b) => b.id);

                // Filter questions by included belts
                let availableTerms = quizTerms.filter((q) => beltIds.includes(q.belt));

                // Spaced repetition: prioritize terms that were answered wrong
                const history = getQuizHistory();
                availableTerms = availableTerms.map((term) => {
                    const record = history[term.term] || { wrong: 0, correct: 0, lastSeen: 0 };
                    // Calculate priority score: more wrong answers = higher priority
                    // Also boost terms not seen recently
                    const daysSinceLastSeen =
                        (Date.now() - record.lastSeen) / (1000 * 60 * 60 * 24);
                    const priority =
                        record.wrong * 3 +
                        (daysSinceLastSeen > 7 ? 2 : 0) +
                        (record.correct === 0 ? 1 : 0);
                    return { ...term, priority };
                });

                // Sort by priority (highest first), then shuffle within same priority
                availableTerms.sort((a, b) => {
                    if (b.priority !== a.priority) return b.priority - a.priority;
                    return Math.random() - 0.5;
                });

                // Select 10 questions (prioritized terms first)
                currentQuiz = availableTerms.slice(0, Math.min(10, availableTerms.length));

                // Initialize category stats
                currentQuiz.forEach((q) => {
                    if (!categoryStats[q.category]) {
                        categoryStats[q.category] = {
                            correct: 0,
                            incorrect: 0,
                            skipped: 0,
                            total: 0,
                        };
                    }
                    categoryStats[q.category].total++;
                });

                // Show quiz
                document.getElementById("quiz-start").style.display = "none";
                document.getElementById("quiz-complete").style.display = "none";
                document.getElementById("quiz-active").style.display = "block";

                // Start timer for speed achievement
                quizStartTime = Date.now();

                // Display difficulty
                const beltNames = includedBelts.map((b) => b.color).join(", ");
                document.getElementById("quiz-difficulty-display").textContent =
                    "Testing: " + beltNames;

                // Display first question
                displayQuestion();
            }

            function displayQuestion() {
                const question = currentQuiz[currentQuestion];
                answered = false;

                // Update progress
                document.getElementById("quiz-score").textContent = score;
                document.getElementById("quiz-current").textContent = currentQuestion + 1;
                document.getElementById("quiz-total").textContent = currentQuiz.length;
                updateProgressBar();

                // Display question
                document.getElementById("quiz-category").textContent = question.category;
                document.getElementById("quiz-question").textContent = question.term;

                // Create options (shuffle correct answer with wrong answers)
                const options = [question.answer, ...question.wrong].sort(
                    () => Math.random() - 0.5,
                );

                const optionsContainer = document.getElementById("quiz-options");
                optionsContainer.innerHTML = "";

                options.forEach((option, index) => {
                    const button = document.createElement("button");
                    button.className = "quiz-option";
                    button.textContent = option;
                    button.setAttribute("data-key", index + 1);
                    button.onclick = () => checkAnswer(option, question.answer);
                    optionsContainer.appendChild(button);
                });

                // Hide feedback and next button, show skip button
                document.getElementById("quiz-feedback").style.display = "none";
                document.getElementById("quiz-next-btn").style.display = "none";
                document.getElementById("quiz-skip-btn").style.display = "inline-block";
            }

            function skipQuestion() {
                if (answered) return;
                answered = true;
                skipped++;

                const question = currentQuiz[currentQuestion];
                categoryStats[question.category].skipped++;

                // Disable all buttons
                const buttons = document.querySelectorAll(".quiz-option");
                buttons.forEach((btn) => {
                    btn.classList.add("disabled");
                    if (btn.textContent === question.answer) {
                        btn.classList.add("correct");
                    }
                });

                // Show feedback
                const feedback = document.getElementById("quiz-feedback");
                feedback.style.display = "block";
                feedback.className = "quiz-feedback";
                feedback.style.background = "#fef3c7";
                feedback.style.color = "#92400e";
                feedback.textContent = " Skipped. The correct answer was: " + question.answer;

                // Hide skip button, show next button
                document.getElementById("quiz-skip-btn").style.display = "none";
                document.getElementById("quiz-next-btn").style.display = "inline-block";
            }

            function checkAnswer(selected, correct) {
                if (answered) return;
                answered = true;

                const isCorrect = selected === correct;
                const question = currentQuiz[currentQuestion];

                // Record for spaced repetition
                recordQuizAnswer(question.term, isCorrect);

                if (isCorrect) {
                    score++;
                    categoryStats[question.category].correct++;
                    currentStreak++;
                    if (currentStreak > streakCount) {
                        streakCount = currentStreak;
                    }
                } else {
                    categoryStats[question.category].incorrect++;
                    currentStreak = 0;
                }

                // Update all buttons
                const buttons = document.querySelectorAll(".quiz-option");
                buttons.forEach((btn) => {
                    btn.classList.add("disabled");
                    if (btn.textContent === correct) {
                        btn.classList.add("correct");
                    } else if (btn.textContent === selected && !isCorrect) {
                        btn.classList.add("incorrect");
                    }
                });

                // Show feedback
                const feedback = document.getElementById("quiz-feedback");
                feedback.style.display = "block";
                feedback.className = "quiz-feedback " + (isCorrect ? "correct" : "incorrect");
                feedback.textContent = isCorrect
                    ? " Correct!"
                    : " Incorrect. The correct answer is: " + correct;

                // Hide skip button
                document.getElementById("quiz-skip-btn").style.display = "none";

                // Auto-advance after correct answer, show next button for incorrect
                if (isCorrect) {
                    setTimeout(() => {
                        nextQuestion();
                    }, 800);
                } else {
                    document.getElementById("quiz-next-btn").style.display = "inline-block";
                }
            }

            function nextQuestion() {
                currentQuestion++;

                if (currentQuestion < currentQuiz.length) {
                    displayQuestion();
                } else {
                    showResults();
                }
            }

            function showResults() {
                document.getElementById("quiz-active").style.display = "none";
                document.getElementById("quiz-complete").style.display = "block";

                const attempted = currentQuiz.length - skipped;
                const percentage = attempted > 0 ? Math.round((score / attempted) * 100) : 0;
                const correct = score;
                const incorrect = attempted - score;

                document.getElementById("final-score").textContent = percentage;
                document.getElementById("correct-count").textContent = correct;
                document.getElementById("incorrect-count").textContent = incorrect;
                document.getElementById("skipped-count").textContent = skipped;
                document.getElementById("total-count").textContent = currentQuiz.length;

                // Calculate quiz duration in seconds
                const quizTimeSeconds = Math.round((Date.now() - quizStartTime) / 1000);

                // Update achievement stats (only for regular quizzes)
                if (!isDailyChallenge) {
                    updateQuizStats(correct, attempted, streakCount, quizTimeSeconds);
                } else {
                    // Complete daily challenge
                    completeDailyChallenge(correct, attempted);
                }

                // Show category breakdown
                let breakdownHTML =
                    '<h4 style="margin-bottom: 1rem; color: #111827; font-size: 1.125rem;">Performance by Category:</h4>';
                breakdownHTML += '<div style="display: grid; gap: 0.75rem;">';

                Object.keys(categoryStats)
                    .sort()
                    .forEach((category) => {
                        const stats = categoryStats[category];
                        const catPercentage =
                            stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                        const color =
                            catPercentage >= 80
                                ? "#059669"
                                : catPercentage >= 60
                                  ? "#f59e0b"
                                  : "#dc2626";

                        breakdownHTML +=
                            '<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border-radius: 0.5rem; border-left: 4px solid ' +
                            color +
                            ';">';
                        breakdownHTML +=
                            '<span style="font-weight: 600; color: #374151;">' +
                            category +
                            "</span>";
                        breakdownHTML +=
                            '<span style="color: #6b7280; font-size: 0.875rem;">' +
                            stats.correct +
                            "/" +
                            stats.total +
                            " (" +
                            catPercentage +
                            "%)</span>";
                        breakdownHTML += "</div>";
                    });

                breakdownHTML += "</div>";
                document.getElementById("category-breakdown").innerHTML = breakdownHTML;
            }

            // Keyboard shortcuts
            document.addEventListener("keydown", function (e) {
                const quizActive = document.getElementById("quiz-active").style.display === "block";
                if (!quizActive || answered) return;

                // Number keys 1-4 for selecting answers
                if (e.key >= "1" && e.key <= "4") {
                    const buttons = document.querySelectorAll(".quiz-option");
                    const index = parseInt(e.key) - 1;
                    if (buttons[index]) {
                        buttons[index].click();
                    }
                }

                // S key to skip
                if (e.key.toLowerCase() === "s" && !answered) {
                    skipQuestion();
                }

                // Escape to exit
                if (e.key === "Escape") {
                    exitQuiz();
                }
            });

            // Enter key for next question when answered
            document.addEventListener("keydown", function (e) {
                const quizActive = document.getElementById("quiz-active").style.display === "block";
                if (!quizActive || !answered) return;

                if (e.key === "Enter") {
                    nextQuestion();
                }
            });

            // ==========================================
            // PROGRESS TRACKING SYSTEM
            // ==========================================

            function setTrainingLevel(level, name) {
                userTrainingLevel = level;
                trainingLevelIndex = trainingBeltLevels[level].index;
            }

            function loadProgress() {
                const saved = localStorage.getItem("hakubaProgress");
                if (saved) {
                    learnedTechniques = JSON.parse(saved);
                }
            }

            function saveProgress() {
                localStorage.setItem("hakubaProgress", JSON.stringify(learnedTechniques));
            }

            function toggleLearned(techniqueId) {
                if (learnedTechniques[techniqueId]) {
                    delete learnedTechniques[techniqueId];
                } else {
                    learnedTechniques[techniqueId] = Date.now();
                }
                saveProgress();
                // Re-render current belt to update UI
                displayBelt(currentBelt);
                updateBeltProgress();
                // Update achievement stats
                updateTechniqueStats();
            }

            function isLearned(techniqueId) {
                return !!learnedTechniques[techniqueId];
            }

            function getBeltProgress(beltKey) {
                const belt = beltData[beltKey];
                if (!belt) return { learned: 0, total: 0, percentage: 0 };

                let total = 0;
                let learned = 0;

                // Count kihon techniques
                if (belt.kihon) {
                    if (belt.kihon.blocks) {
                        belt.kihon.blocks.forEach((t) => {
                            total++;
                            if (isLearned(beltKey + "-" + t.name)) learned++;
                        });
                    }
                    if (belt.kihon.strikes) {
                        belt.kihon.strikes.forEach((t) => {
                            total++;
                            if (isLearned(beltKey + "-" + t.name)) learned++;
                        });
                    }
                    if (belt.kihon.kicks) {
                        belt.kihon.kicks.forEach((t) => {
                            total++;
                            if (isLearned(beltKey + "-" + t.name)) learned++;
                        });
                    }
                    if (belt.kihon.list) {
                        belt.kihon.list.forEach((t) => {
                            total++;
                            if (isLearned(beltKey + "-" + t.name)) learned++;
                        });
                    }
                }

                // Count renraku techniques
                if (belt.renraku && belt.renraku.list) {
                    belt.renraku.list.forEach((t) => {
                        total++;
                        if (isLearned(beltKey + "-" + t.name)) learned++;
                    });
                }

                // Count uke techniques
                if (belt.uke && belt.uke.list) {
                    belt.uke.list.forEach((t) => {
                        total++;
                        if (isLearned(beltKey + "-" + t.name)) learned++;
                    });
                }

                const percentage = total > 0 ? Math.round((learned / total) * 100) : 0;
                return { learned, total, percentage };
            }

            function updateBeltProgress() {
                document.querySelectorAll(".belt-button").forEach((btn, index) => {
                    const beltKey = Object.keys(beltData)[index];
                    const progress = getBeltProgress(beltKey);

                    let progressBar = btn.querySelector(".belt-progress");
                    if (!progressBar && progress.total > 0) {
                        progressBar = document.createElement("div");
                        progressBar.className = "belt-progress";
                        progressBar.innerHTML = '<div class="belt-progress-fill"></div>';
                        btn.appendChild(progressBar);
                    }

                    if (progressBar) {
                        const fill = progressBar.querySelector(".belt-progress-fill");
                        fill.style.width = progress.percentage + "%";
                        if (progress.percentage === 100) {
                            fill.style.background = "#059669";
                        }
                    }
                });

                // Update overall progress bar
                updateOverallProgress();
            }

            function updateOverallProgress() {
                // Belt colors and data for rainbow bar
                const beltColors = {
                    "9th": { color: "#dc2626", name: "Red Belt" },
                    "8th": { color: "#fbbf24", name: "Yellow Belt" },
                    "7th": { color: "#f97316", name: "Orange Belt" },
                    "6th": { color: "#059669", name: "Green Belt" },
                    "5th": { color: "#2563eb", name: "Blue Belt" },
                    "4th": { color: "#7c3aed", name: "Purple Belt" },
                    "3rd": { color: "#92400e", name: "Brown Belt" },
                    "2nd": { color: "#78350f", name: "Brown/White" },
                    "1st": { color: "#451a03", name: "Brown/Black" },
                    Shodan: { color: "#1f2937", name: "1st Dan" },
                    Nidan: { color: "#111827", name: "2nd Dan" },
                    Sandan: { color: "#000000", name: "3rd Dan" },
                };

                const beltKeys = Object.keys(beltData);
                let beltStats = [];
                let totalLearned = 0;
                let totalTechniques = 0;

                // Calculate progress for each belt
                beltKeys.forEach((beltKey) => {
                    const progress = getBeltProgress(beltKey);
                    beltStats.push({
                        key: beltKey,
                        learned: progress.learned,
                        total: progress.total,
                        color: beltColors[beltKey]?.color || "#6b7280",
                        name: beltColors[beltKey]?.name || beltKey,
                    });
                    totalLearned += progress.learned;
                    totalTechniques += progress.total;
                });

                // Build rainbow progress bar
                const rainbowBar = document.getElementById("rainbow-progress-bar");
                if (rainbowBar && totalTechniques > 0) {
                    rainbowBar.innerHTML = "";

                    beltStats.forEach((belt, index) => {
                        if (belt.total > 0) {
                            const widthPercent = (belt.total / totalTechniques) * 100;
                            const segment = document.createElement("div");
                            segment.style.cssText =
                                "height: 100%; background: " +
                                belt.color +
                                "; width: " +
                                widthPercent +
                                "%;";

                            // Add subtle divider between segments (except last)
                            if (index < beltStats.length - 1) {
                                segment.style.borderRight = "1px solid rgba(255,255,255,0.3)";
                            }

                            // Dim incomplete sections to show progress
                            if (belt.learned === belt.total && belt.total > 0) {
                                segment.style.opacity = "1";
                            } else if (belt.learned > 0) {
                                segment.style.opacity = "0.85";
                            } else {
                                segment.style.opacity = "0.5";
                            }

                            rainbowBar.appendChild(segment);
                        }
                    });
                }

                // Position marker based on learned techniques
                const marker = document.getElementById("progress-marker");
                const percentage = totalTechniques > 0 ? (totalLearned / totalTechniques) * 100 : 0;
                if (marker) {
                    marker.style.left = percentage + "%";
                }

                // Find current belt (first one not fully completed)
                let currentBeltName = "Getting Started";
                for (let i = 0; i < beltStats.length; i++) {
                    const belt = beltStats[i];
                    if (belt.learned < belt.total) {
                        currentBeltName = "Working on: " + belt.name;
                        break;
                    } else if (i === beltStats.length - 1 && belt.learned === belt.total) {
                        currentBeltName = "Master - All Belts Complete!";
                    }
                }

                // Update UI
                const progressText = document.getElementById("overall-progress-text");
                const beltLabel = document.getElementById("current-belt-label");

                if (progressText) {
                    progressText.textContent =
                        totalLearned +
                        " / " +
                        totalTechniques +
                        " techniques (" +
                        Math.round(percentage) +
                        "%)";
                }

                if (beltLabel) {
                    beltLabel.textContent = currentBeltName;
                }
            }

            // Load progress on page load
            document.addEventListener("DOMContentLoaded", function () {
                loadProgress();
                setTimeout(updateBeltProgress, 100);
                updateGradingCountdown();
                updateDailyChallengeButton();
                // Migrate XP for existing badges (one-time)
                migrateExistingBadgeXP();
            });

            // ==========================================
            // STUDY MODES
            // ==========================================

            let flashcards = [];
            let currentFlashcardIndex = 0;
            let flashcardFlipped = false;

            function startFlashcards() {
                document.querySelector(".study-mode-selector").style.display = "none";
                document.getElementById("flashcard-container").style.display = "block";
                document.getElementById("focus-container").style.display = "none";

                // Populate belt selector
                const select = document.getElementById("flashcard-belt");
                select.innerHTML = '<option value="all">All Belts</option>';
                beltLevels.forEach((belt) => {
                    select.innerHTML +=
                        '<option value="' +
                        belt.id +
                        '">' +
                        belt.name +
                        " - " +
                        belt.color +
                        "</option>";
                });

                loadFlashcards();
            }

            function loadFlashcards() {
                const selectedBelt = document.getElementById("flashcard-belt").value;

                if (selectedBelt === "all") {
                    flashcards = [...quizTerms];
                } else {
                    // Get all belts up to and including selected
                    const beltIndex = beltLevels.findIndex((b) => b.id === selectedBelt);
                    const includedBelts = beltLevels.slice(0, beltIndex + 1).map((b) => b.id);
                    flashcards = quizTerms.filter((q) => includedBelts.includes(q.belt));
                }

                // Shuffle initially
                flashcards = flashcards.sort(() => Math.random() - 0.5);
                currentFlashcardIndex = 0;
                flashcardFlipped = false;
                displayFlashcard();
            }

            function displayFlashcard() {
                if (flashcards.length === 0) {
                    document.getElementById("flashcard-term").textContent = "No cards available";
                    document.getElementById("flashcard-category").textContent = "";
                    document.getElementById("flashcard-progress").textContent = "";
                    return;
                }

                const card = flashcards[currentFlashcardIndex];
                document.getElementById("flashcard-category").textContent = card.category;
                document.getElementById("flashcard-term").textContent = card.term;
                document.getElementById("flashcard-term-back").textContent = card.term;
                document.getElementById("flashcard-answer").textContent = card.answer;
                document.getElementById("flashcard-progress").textContent =
                    "Card " + (currentFlashcardIndex + 1) + " of " + flashcards.length;

                // Reset to front
                flashcardFlipped = false;
                document.getElementById("flashcard-front").style.display = "flex";
                document.getElementById("flashcard-back").style.display = "none";
                document.getElementById("flashcard").style.background = "white";
            }

            function flipFlashcard() {
                flashcardFlipped = !flashcardFlipped;
                if (flashcardFlipped) {
                    document.getElementById("flashcard-front").style.display = "none";
                    document.getElementById("flashcard-back").style.display = "flex";
                    document.getElementById("flashcard").style.background = "#f0fdf4";
                } else {
                    document.getElementById("flashcard-front").style.display = "flex";
                    document.getElementById("flashcard-back").style.display = "none";
                    document.getElementById("flashcard").style.background = "white";
                }
            }

            function nextFlashcard() {
                currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcards.length;
                displayFlashcard();
            }

            function prevFlashcard() {
                currentFlashcardIndex =
                    (currentFlashcardIndex - 1 + flashcards.length) % flashcards.length;
                displayFlashcard();
            }

            function shuffleFlashcards() {
                flashcards = flashcards.sort(() => Math.random() - 0.5);
                currentFlashcardIndex = 0;
                displayFlashcard();
            }

            function startFocusMode() {
                document.querySelector(".study-mode-selector").style.display = "none";
                document.getElementById("flashcard-container").style.display = "none";
                document.getElementById("focus-container").style.display = "block";

                showFocusCategories();
            }

            function showFocusCategories() {
                document.getElementById("focus-category-select").style.display = "block";
                document.getElementById("focus-content").style.display = "none";

                // Get unique categories
                const categories = [...new Set(quizTerms.map((q) => q.category))].sort();

                const container = document.getElementById("focus-categories");
                container.innerHTML = "";

                categories.forEach((category) => {
                    const count = quizTerms.filter((q) => q.category === category).length;
                    const btn = document.createElement("button");
                    btn.style.cssText =
                        "padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; text-align: center;";
                    btn.innerHTML =
                        '<div style="font-weight: 600; color: #1e5ba8;">' +
                        category +
                        '</div><div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">' +
                        count +
                        " terms</div>";
                    btn.onmouseover = function () {
                        this.style.borderColor = "#1e5ba8";
                    };
                    btn.onmouseout = function () {
                        this.style.borderColor = "#e5e7eb";
                    };
                    btn.onclick = function () {
                        showFocusCategory(category);
                    };
                    container.appendChild(btn);
                });
            }

            function showFocusCategory(category) {
                document.getElementById("focus-category-select").style.display = "none";
                document.getElementById("focus-content").style.display = "block";
                document.getElementById("focus-title").textContent = category + " Terms";

                // Update achievement stats for studied category
                updateCategoryStats(category);

                const terms = quizTerms.filter((q) => q.category === category);
                const container = document.getElementById("focus-terms");
                container.innerHTML = "";

                terms.forEach((term) => {
                    const beltInfo = beltLevels.find((b) => b.id === term.belt);
                    const card = document.createElement("div");
                    card.style.cssText =
                        "background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem; cursor: pointer; transition: all 0.2s;";
                    card.innerHTML =
                        '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">' +
                        '<div style="font-size: 1.25rem; font-weight: 600; color: #1e5ba8;">' +
                        term.term +
                        "</div>" +
                        '<div style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: #f3f4f6; border-radius: 0.25rem; color: #6b7280;">' +
                        (beltInfo ? beltInfo.color : term.belt) +
                        "</div>" +
                        "</div>" +
                        '<div class="focus-answer" style="color: #059669; font-weight: 500; display: none;">' +
                        term.answer +
                        "</div>" +
                        '<div class="focus-reveal" style="color: #9ca3af; font-size: 0.875rem;">Click to reveal</div>';

                    card.onclick = function () {
                        const answer = this.querySelector(".focus-answer");
                        const reveal = this.querySelector(".focus-reveal");
                        if (answer.style.display === "none") {
                            answer.style.display = "block";
                            reveal.style.display = "none";
                            this.style.background = "#f0fdf4";
                        } else {
                            answer.style.display = "none";
                            reveal.style.display = "block";
                            this.style.background = "white";
                        }
                    };

                    container.appendChild(card);
                });
            }

            function exitStudyMode() {
                document.querySelector(".study-mode-selector").style.display = "grid";
                document.getElementById("flashcard-container").style.display = "none";
                document.getElementById("focus-container").style.display = "none";
            }

            // Keyboard shortcuts for flashcards
            document.addEventListener("keydown", function (e) {
                const flashcardActive =
                    document.getElementById("flashcard-container").style.display === "block";
                if (!flashcardActive) return;

                if (e.code === "Space") {
                    e.preventDefault();
                    flipFlashcard();
                } else if (e.key === "ArrowRight") {
                    nextFlashcard();
                } else if (e.key === "ArrowLeft") {
                    prevFlashcard();
                } else if (e.key.toLowerCase() === "s") {
                    shuffleFlashcards();
                } else if (e.key === "Escape") {
                    exitStudyMode();
                }
            });

            // ==========================================
            // GRADING CHECKLIST
            // ==========================================

            let gradingChecklist = {};

            function loadGradingChecklist() {
                const saved = localStorage.getItem("hakubaGradingChecklist");
                if (saved) {
                    gradingChecklist = JSON.parse(saved);
                }
            }

            function saveGradingChecklist() {
                localStorage.setItem("hakubaGradingChecklist", JSON.stringify(gradingChecklist));
            }

            function initGradingChecklist() {
                loadGradingChecklist();

                // Populate belt selector
                const select = document.getElementById("grading-current-belt");
                if (!select) return;
                select.innerHTML = "";

                // Add "No Belt / White Belt" option for beginners
                select.innerHTML += '<option value="none">No Belt / White Belt</option>';

                const beltKeys = Object.keys(beltData);
                beltKeys.forEach((key, index) => {
                    if (index < beltKeys.length - 1) {
                        const belt = beltData[key];
                        select.innerHTML +=
                            '<option value="' +
                            key +
                            '">' +
                            belt.name +
                            " - " +
                            belt.color +
                            "</option>";
                    }
                });

                updateGradingChecklist();
            }

            function getNextBelt(currentKey) {
                // Handle "none" (white belt) case - next belt is 9th Kyu (Red)
                if (currentKey === "none") {
                    return "9th";
                }
                const keys = Object.keys(beltData);
                const currentIndex = keys.indexOf(currentKey);
                if (currentIndex < keys.length - 1) {
                    return keys[currentIndex + 1];
                }
                return null;
            }

            function toggleGradingItem(itemId) {
                if (gradingChecklist[itemId]) {
                    delete gradingChecklist[itemId];
                } else {
                    gradingChecklist[itemId] = Date.now();
                }
                saveGradingChecklist();
                updateGradingChecklist();
            }

            // Navigate to search result
            function navigateToSearchResult(belt, type, japanese) {
                // Close mobile menu if open
                const hamburger = document.querySelector(".hamburger");
                const navContainer = document.querySelector(".nav-container");
                const navOverlay = document.querySelector(".nav-overlay");
                if (hamburger) hamburger.classList.remove("active");
                if (navContainer) navContainer.classList.remove("active");
                if (navOverlay) navOverlay.classList.remove("active");
                document.body.style.overflow = "";

                // Switch to belts tab
                document
                    .querySelectorAll(".nav-button")
                    .forEach((b) => b.classList.remove("active"));
                document
                    .querySelectorAll(".tab-content")
                    .forEach((t) => t.classList.remove("active"));

                document.querySelector('[data-tab="belts"]').classList.add("active");
                document.getElementById("belts-tab").classList.add("active");

                // Select the belt
                selectBelt(belt);

                // Scroll to top first, then try to highlight the element after a short delay
                window.scrollTo(0, 0);

                setTimeout(() => {
                    // Try to find and highlight the element
                    const beltContent = document.getElementById("belt-content");
                    if (beltContent) {
                        // Search for the Japanese term in the content
                        const allElements = beltContent.querySelectorAll(
                            ".japanese, .technique-card, h4, li",
                        );
                        for (const el of allElements) {
                            if (el.textContent.includes(japanese)) {
                                // Scroll to element
                                el.scrollIntoView({ behavior: "smooth", block: "center" });

                                // Highlight effect
                                const card = el.closest(".technique-card") || el;
                                card.style.transition = "background-color 0.3s, box-shadow 0.3s";
                                card.style.backgroundColor = "#fef08a";
                                card.style.boxShadow = "0 0 0 3px #fbbf24";
                                setTimeout(() => {
                                    card.style.backgroundColor = "";
                                    card.style.boxShadow = "";
                                }, 2500);
                                break;
                            }
                        }
                    }
                }, 400);
            }

            // Calendar filter functionality
            function filterCalendar(location) {
                const iframe = document.getElementById("dojo-calendar");
                const baseUrl =
                    "https://calendar.google.com/calendar/embed?height=600&wkst=1&ctz=Europe/London&showPrint=0&showTitle=0&showNav=1&showTabs=0&mode=AGENDA&hl=en_GB";

                // Calendar source IDs
                const swindonSrc = "aGFrdWJhLndhZG9yeXUua2FyYXRlQGdtYWlsLmNvbQ"; // Blue
                const mevagisseySrc =
                    "ZDg4MjliN2RjOGMzZmRkNjIyYjFlMWYyZTBlODIyNjNjODI1YWI2ZDNhNmExYzYzODYwNmU2M2I5M2FmNjViYUBncm91cC5jYWxlbmRhci5nb29nbGUuY29t"; // Purple

                let url = baseUrl;

                if (location === "swindon") {
                    url += "&src=" + swindonSrc + "&color=%23039be5";
                } else if (location === "mevagissey") {
                    url += "&src=" + mevagisseySrc + "&color=%239e69af";
                } else {
                    // All locations
                    url +=
                        "&src=" +
                        swindonSrc +
                        "&src=" +
                        mevagisseySrc +
                        "&color=%23039be5&color=%239e69af";
                }

                iframe.src = url;

                // Update button states
                document.querySelectorAll(".cal-filter-btn").forEach((btn) => {
                    btn.style.background = "#e5e7eb";
                    btn.style.color = "#374151";
                });

                const activeBtn = document.getElementById("cal-filter-" + location);
                if (activeBtn) {
                    activeBtn.style.background = "#1e5ba8";
                    activeBtn.style.color = "white";
                }

                // Save preference
                localStorage.setItem("calendarFilter", location);
            }

            // Load saved calendar filter on page load
            document.addEventListener("DOMContentLoaded", function () {
                const savedFilter = localStorage.getItem("calendarFilter");
                if (savedFilter) {
                    filterCalendar(savedFilter);
                }
            });

            // ==========================================
            // NEXT CLASS WIDGET
            // ==========================================
            const CALENDAR_FEEDS = {
                swindon:
                    "https://calendar.google.com/calendar/ical/hakuba.wadoryu.karate%40gmail.com/public/basic.ics",
                mevagissey:
                    "https://calendar.google.com/calendar/ical/d8829b7dc8c3fdd622b1e1f2e0e82263c825ab6d3a6a1c638606e63b93af65ba%40group.calendar.google.com/public/basic.ics",
            };

            function setHomeDojo(dojo) {
                localStorage.setItem("homeDojo", dojo);
                document.getElementById("home-dojo-select").value = dojo;
                // Also update calendar filter to match
                filterCalendar(dojo);
                fetchNextClass(dojo);
            }

            function fetchNextClass(dojo) {
                const display = document.getElementById("next-class-display");
                display.textContent = "Loading...";

                const feedUrl = CALENDAR_FEEDS[dojo];

                // Try multiple CORS proxies with fallback
                const corsProxies = [
                    "https://api.allorigins.win/raw?url=",
                    "https://corsproxy.io/?",
                    "https://api.codetabs.com/v1/proxy?quest=",
                ];

                function tryProxy(index) {
                    if (index >= corsProxies.length) {
                        display.textContent = "Check calendar tab";
                        return;
                    }

                    const proxyUrl = corsProxies[index] + encodeURIComponent(feedUrl);

                    fetch(proxyUrl, { timeout: 8000 })
                        .then((response) => {
                            if (!response.ok) throw new Error("Proxy failed");
                            return response.text();
                        })
                        .then((icsData) => {
                            if (!icsData || icsData.length < 100) {
                                throw new Error("Invalid response");
                            }
                            const nextEvent = parseNextEvent(icsData);
                            if (nextEvent) {
                                display.textContent = nextEvent;
                            } else {
                                display.textContent = "No upcoming classes";
                            }
                        })
                        .catch((err) => {
                            console.warn("Proxy " + index + " failed:", err);
                            tryProxy(index + 1);
                        });
                }

                tryProxy(0);
            }

            function parseNextEvent(icsData) {
                const now = new Date();
                const events = [];
                const lookAheadDays = 14; // Look 2 weeks ahead for recurring events
                const maxDate = new Date(now.getTime() + lookAheadDays * 24 * 60 * 60 * 1000);

                // Split into events
                const eventBlocks = icsData.split("BEGIN:VEVENT");

                for (let i = 1; i < eventBlocks.length; i++) {
                    const block = eventBlocks[i];

                    // Extract DTSTART
                    const dtStartMatch = block.match(/DTSTART[^:]*:(\d{8}T?\d{0,6})/);
                    if (!dtStartMatch) continue;

                    const dtStr = dtStartMatch[1];
                    let eventDate;
                    let eventHour = 0;
                    let eventMinute = 0;

                    if (dtStr.length === 8) {
                        // All-day event: YYYYMMDD
                        eventDate = new Date(
                            parseInt(dtStr.substr(0, 4)),
                            parseInt(dtStr.substr(4, 2)) - 1,
                            parseInt(dtStr.substr(6, 2)),
                        );
                    } else {
                        // DateTime: YYYYMMDDTHHmmss
                        eventHour = parseInt(dtStr.substr(9, 2));
                        eventMinute = parseInt(dtStr.substr(11, 2));
                        eventDate = new Date(
                            parseInt(dtStr.substr(0, 4)),
                            parseInt(dtStr.substr(4, 2)) - 1,
                            parseInt(dtStr.substr(6, 2)),
                            eventHour,
                            eventMinute,
                        );
                    }

                    // Extract summary
                    const summaryMatch = block.match(/SUMMARY:(.+?)(?:\r?\n|$)/);
                    const summary = summaryMatch ? summaryMatch[1].trim() : "Class";

                    // Skip closure/cancelled events
                    const lowerSummary = summary.toLowerCase();
                    if (
                        lowerSummary.includes("closed") ||
                        lowerSummary.includes("cancel") ||
                        lowerSummary.includes("no training") ||
                        lowerSummary.includes("no class")
                    ) {
                        continue;
                    }

                    // Check for recurring events (RRULE)
                    const rruleMatch = block.match(/RRULE:(.+?)(?:\r?\n|$)/);
                    if (rruleMatch) {
                        const rrule = rruleMatch[1];
                        // Handle weekly recurring events
                        if (rrule.includes("FREQ=WEEKLY")) {
                            // Extract BYDAY if present (e.g., BYDAY=SA for Saturday)
                            const bydayMatch = rrule.match(/BYDAY=([A-Z,]+)/);
                            const untilMatch = rrule.match(/UNTIL=(\d{8})/);

                            // Check if event has ended
                            if (untilMatch) {
                                const untilStr = untilMatch[1];
                                const untilDate = new Date(
                                    parseInt(untilStr.substr(0, 4)),
                                    parseInt(untilStr.substr(4, 2)) - 1,
                                    parseInt(untilStr.substr(6, 2)),
                                );
                                if (untilDate < now) continue;
                            }

                            // Generate occurrences for the next 2 weeks
                            const dayMap = { SU: 0, MO: 1, TU: 2, WE: 3, TH: 4, FR: 5, SA: 6 };
                            let targetDays = [];

                            if (bydayMatch) {
                                targetDays = bydayMatch[1].split(",").map((d) => dayMap[d]);
                            } else {
                                // Use the original event's day of week
                                targetDays = [eventDate.getDay()];
                            }

                            // Find next occurrences
                            for (let dayOffset = 0; dayOffset <= lookAheadDays; dayOffset++) {
                                const checkDate = new Date(now);
                                checkDate.setDate(checkDate.getDate() + dayOffset);
                                checkDate.setHours(eventHour, eventMinute, 0, 0);

                                if (targetDays.includes(checkDate.getDay()) && checkDate > now) {
                                    events.push({ date: new Date(checkDate), summary: summary });
                                    break; // Only need the next occurrence
                                }
                            }
                        }
                    } else {
                        // Non-recurring event - add if in future
                        if (eventDate > now) {
                            events.push({ date: eventDate, summary: summary });
                        }
                    }
                }

                // Sort by date and get the earliest
                events.sort((a, b) => a.date - b.date);

                if (events.length === 0) return null;

                const next = events[0];
                const dayName = next.date.toLocaleDateString("en-GB", { weekday: "long" });
                const dateStr = next.date.toLocaleDateString("en-GB", {
                    day: "numeric",
                    month: "short",
                });

                return dayName + " " + dateStr + " - " + next.summary;
            }

            // Initialize home dojo on page load
            document.addEventListener("DOMContentLoaded", function () {
                const savedDojo = localStorage.getItem("homeDojo") || "swindon";
                document.getElementById("home-dojo-select").value = savedDojo;
                fetchNextClass(savedDojo);

                // Auto-refresh next class when page becomes visible or at midnight
                document.addEventListener("visibilitychange", function () {
                    if (!document.hidden) {
                        const dojo = localStorage.getItem("homeDojo") || "swindon";
                        fetchNextClass(dojo);
                    }
                });

                // Check at midnight for date change
                function scheduleNextMidnightRefresh() {
                    const now = new Date();
                    const tomorrow = new Date(now);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(0, 0, 5, 0); // 5 seconds past midnight
                    const msUntilMidnight = tomorrow - now;

                    setTimeout(function () {
                        const dojo = localStorage.getItem("homeDojo") || "swindon";
                        fetchNextClass(dojo);
                        scheduleNextMidnightRefresh(); // Schedule next one
                    }, msUntilMidnight);
                }
                scheduleNextMidnightRefresh();
            });

            // Search functionality
            function performSearch() {
                const query = document.getElementById("search-input").value.toLowerCase().trim();
                const resultsDiv = document.getElementById("search-results");
                const countDiv = document.getElementById("search-results-count");

                if (query.length < 2) {
                    resultsDiv.innerHTML =
                        '<p style="color: #6b7280;">Enter at least 2 characters to search.</p>';
                    countDiv.textContent = "";
                    return;
                }

                let results = [];

                // Search quizTerms (terminology)
                quizTerms.forEach((item) => {
                    if (
                        item.term.toLowerCase().includes(query) ||
                        item.answer.toLowerCase().includes(query) ||
                        item.category.toLowerCase().includes(query)
                    ) {
                        results.push({
                            type: "Terminology",
                            japanese: item.term,
                            english: item.answer,
                            category: item.category,
                            belt: item.belt,
                        });
                    }
                });

                // Search beltData (techniques from syllabus)
                Object.keys(beltData).forEach((beltKey) => {
                    const belt = beltData[beltKey];

                    // Search kihon
                    if (belt.kihon && belt.kihon.list) {
                        belt.kihon.list.forEach((tech) => {
                            if (
                                tech.name.toLowerCase().includes(query) ||
                                tech.translation.toLowerCase().includes(query)
                            ) {
                                results.push({
                                    type: "Kihon",
                                    japanese: tech.name,
                                    english: tech.translation,
                                    category: "Basic Technique",
                                    belt: beltKey,
                                });
                            }
                        });
                    }

                    // Search renraku
                    if (belt.renraku && belt.renraku.list) {
                        belt.renraku.list.forEach((tech) => {
                            if (
                                tech.name.toLowerCase().includes(query) ||
                                tech.translation.toLowerCase().includes(query)
                            ) {
                                results.push({
                                    type: "Renraku",
                                    japanese: tech.name,
                                    english: tech.translation,
                                    category: "Combination",
                                    belt: beltKey,
                                });
                            }
                        });
                    }

                    // Search kata
                    if (belt.kata && belt.kata.name.toLowerCase().includes(query)) {
                        results.push({
                            type: "Kata",
                            japanese: belt.kata.name,
                            english: "Form/Pattern",
                            category: "Kata",
                            belt: beltKey,
                        });
                    }
                });

                // Remove duplicates based on japanese name
                const seen = new Set();
                results = results.filter((item) => {
                    const key = item.japanese.toLowerCase();
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });

                // Sort by relevance (exact match first, then by belt level)
                results.sort((a, b) => {
                    const aExact =
                        a.japanese.toLowerCase() === query || a.english.toLowerCase() === query;
                    const bExact =
                        b.japanese.toLowerCase() === query || b.english.toLowerCase() === query;
                    if (aExact && !bExact) return -1;
                    if (bExact && !aExact) return 1;
                    return 0;
                });

                // Display results
                countDiv.textContent =
                    results.length + " result" + (results.length !== 1 ? "s" : "") + " found";

                if (results.length === 0) {
                    resultsDiv.innerHTML =
                        '<p style="color: #6b7280;">No results found for "' + query + '"</p>';
                    return;
                }

                const beltColors = {
                    "9th": { bg: "#fef2f2", border: "#dc2626", name: "Red Belt" },
                    "8th": { bg: "#fefce8", border: "#fbbf24", name: "Yellow Belt" },
                    "7th": { bg: "#fff7ed", border: "#f97316", name: "Orange Belt" },
                    "6th": { bg: "#f0fdf4", border: "#059669", name: "Green Belt" },
                    "5th": { bg: "#eff6ff", border: "#2563eb", name: "Blue Belt" },
                    "4th": { bg: "#faf5ff", border: "#7c3aed", name: "Purple Belt" },
                    "3rd": { bg: "#fef3c7", border: "#92400e", name: "Brown Belt" },
                    "2nd": { bg: "#fef3c7", border: "#78350f", name: "Brown/White" },
                    "1st": { bg: "#fef3c7", border: "#451a03", name: "Brown/Black" },
                    Shodan: { bg: "#f3f4f6", border: "#1f2937", name: "1st Dan" },
                    Nidan: { bg: "#f3f4f6", border: "#111827", name: "2nd Dan" },
                    Sandan: { bg: "#f3f4f6", border: "#000000", name: "3rd Dan" },
                };

                let html = '<div class="technique-grid">';
                results.forEach((item) => {
                    const beltInfo = beltColors[item.belt] || {
                        bg: "#f9fafb",
                        border: "#6b7280",
                        name: item.belt,
                    };
                    html +=
                        '<div class="technique-card search-result-clickable" style="border-left: 4px solid ' +
                        beltInfo.border +
                        '; cursor: pointer;" onclick="navigateToSearchResult(\'' +
                        item.belt +
                        "', '" +
                        item.type +
                        "', '" +
                        item.japanese.replace(/'/g, "\\'") +
                        "')\">";
                    html += '<div class="japanese">' + item.japanese + "</div>";
                    html += '<div class="english">' + item.english + "</div>";
                    html +=
                        '<div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">';
                    html +=
                        '<span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: ' +
                        beltInfo.bg +
                        '; border-radius: 0.25rem; color: #374151;">' +
                        beltInfo.name +
                        "</span>";
                    html +=
                        '<span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: #f3f4f6; border-radius: 0.25rem; color: #374151;">' +
                        item.type +
                        "</span>";
                    html +=
                        '<span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: #e0e7ff; border-radius: 0.25rem; color: #1e5ba8; margin-left: auto;">Click to view </span>';
                    html += "</div>";
                    html += "</div>";
                });
                html += "</div>";

                resultsDiv.innerHTML = html;
            }

            function updateGradingChecklist() {
                const select = document.getElementById("grading-current-belt");
                if (!select) return;

                const currentBeltKey = select.value;
                const nextBeltKey = getNextBelt(currentBeltKey);

                if (!nextBeltKey) {
                    document.getElementById("grading-target-belt").textContent =
                        "Congratulations! You've reached the highest level.";
                    document.getElementById("grading-checklist-content").innerHTML = "";
                    return;
                }

                const nextBelt = beltData[nextBeltKey];
                document.getElementById("grading-target-belt").textContent =
                    nextBelt.name + " - " + nextBelt.color;

                let totalItems = 0;
                let checkedItems = 0;
                let html = "";

                // Build checklist sections
                const sections = [];

                // General requirements
                const generalItems = [];
                if (nextBelt.dojoKun) {
                    generalItems.push({
                        id: "dojo-kun",
                        text: "Dojo Kun - Recite in Japanese and English",
                    });
                }
                if (nextBelt.beltTying) {
                    generalItems.push({
                        id: "belt-tying",
                        text: "Hon-Musubi - Traditional belt tying technique",
                    });
                }
                if (generalItems.length > 0) {
                    sections.push({ title: "General Requirements", items: generalItems });
                }

                // Kihon techniques
                if (nextBelt.kihon) {
                    const kihonItems = [];
                    if (nextBelt.kihon.blocks) {
                        nextBelt.kihon.blocks.forEach((t) => {
                            kihonItems.push({
                                id: "kihon-" + t.name,
                                text: t.name + " - " + t.translation,
                            });
                        });
                    }
                    if (nextBelt.kihon.strikes) {
                        nextBelt.kihon.strikes.forEach((t) => {
                            kihonItems.push({
                                id: "kihon-" + t.name,
                                text: t.name + " - " + t.translation,
                            });
                        });
                    }
                    if (nextBelt.kihon.kicks) {
                        nextBelt.kihon.kicks.forEach((t) => {
                            kihonItems.push({
                                id: "kihon-" + t.name,
                                text: t.name + " - " + t.translation,
                            });
                        });
                    }
                    if (nextBelt.kihon.list) {
                        nextBelt.kihon.list.forEach((t) => {
                            kihonItems.push({
                                id: "kihon-" + t.name,
                                text: t.name + " - " + t.translation,
                            });
                        });
                    }
                    if (kihonItems.length > 0) {
                        sections.push({
                            title: "Kihon-Waza (Fundamental Techniques)",
                            items: kihonItems,
                        });
                    }
                }

                // Renraku techniques
                if (nextBelt.renraku && nextBelt.renraku.list) {
                    const renrakuItems = nextBelt.renraku.list.map((t) => ({
                        id: "renraku-" + t.name,
                        text: t.name + " - " + t.translation,
                    }));
                    sections.push({ title: nextBelt.renraku.title, items: renrakuItems });
                }

                // Uke techniques
                if (nextBelt.uke && nextBelt.uke.list) {
                    const ukeItems = nextBelt.uke.list.map((t) => ({
                        id: "uke-" + t.name,
                        text: t.name + " - " + t.translation,
                    }));
                    sections.push({ title: nextBelt.uke.title, items: ukeItems });
                }

                // Sanbon-Gumite
                if (nextBelt.sanbon && nextBelt.sanbon.items) {
                    const sanbonItems = nextBelt.sanbon.items.map((t) => ({
                        id: "sanbon-" + t.name,
                        text: t.name + " - " + t.translation,
                    }));
                    sections.push({ title: nextBelt.sanbon.title, items: sanbonItems });
                }

                // Ohyo-Gumite
                if (nextBelt.ohyo && nextBelt.ohyo.items) {
                    const ohyoItems = nextBelt.ohyo.items.map((t) => ({
                        id: "ohyo-" + t.name,
                        text: t.name + " - " + t.translation,
                    }));
                    sections.push({ title: nextBelt.ohyo.title, items: ohyoItems });
                }

                // Kihon-Gumite
                if (nextBelt.kihonGumite && nextBelt.kihonGumite.items) {
                    const kihonGumiteItems = nextBelt.kihonGumite.items.map((t) => ({
                        id: "kihongumite-" + t.name,
                        text: t.name + " - " + t.translation,
                    }));
                    sections.push({ title: nextBelt.kihonGumite.title, items: kihonGumiteItems });
                }

                // Machi-Ohyo
                if (nextBelt.machiOhyo && nextBelt.machiOhyo.items) {
                    const machiItems = nextBelt.machiOhyo.items.map((t) => ({
                        id: "machi-" + t.name,
                        text: t.name + " - " + t.translation,
                    }));
                    sections.push({ title: nextBelt.machiOhyo.title, items: machiItems });
                }

                // Kata
                if (nextBelt.kata) {
                    sections.push({
                        title: "Kata",
                        items: [{ id: "kata-" + nextBelt.kata.name, text: nextBelt.kata.name }],
                    });
                }

                // Additional requirements
                if (nextBelt.additional) {
                    const additionalItems = [];
                    if (nextBelt.additional.jiyuGumite) {
                        additionalItems.push({
                            id: "jiyu-gumite",
                            text: "Jiyu-Gumite - " + nextBelt.additional.jiyuGumite,
                        });
                    }
                    if (nextBelt.additional.hikkiShiken) {
                        additionalItems.push({
                            id: "hikki-shiken",
                            text: "Hikki-Shiken - " + nextBelt.additional.hikkiShiken,
                        });
                    }
                    if (additionalItems.length > 0) {
                        sections.push({ title: "Additional Requirements", items: additionalItems });
                    }
                }

                // Render sections
                sections.forEach((section) => {
                    html += '<div style="margin-bottom: 2rem;">';
                    html +=
                        '<h3 style="font-size: 1.25rem; color: #1e5ba8; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">' +
                        section.title +
                        "</h3>";
                    html += '<div style="display: grid; gap: 0.5rem;">';

                    section.items.forEach((item) => {
                        const itemKey = nextBeltKey + "-" + item.id;
                        const isChecked = !!gradingChecklist[itemKey];
                        totalItems++;
                        if (isChecked) checkedItems++;

                        const checkboxStyle = isChecked
                            ? "width: 24px; height: 24px; border: 2px solid #059669; background: #059669; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;"
                            : "width: 24px; height: 24px; border: 2px solid #d1d5db; background: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;";

                        const textStyle = isChecked
                            ? "color: #6b7280; text-decoration: line-through;"
                            : "color: #374151;";

                        html +=
                            '<div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer;" onclick="toggleGradingItem(\'' +
                            itemKey.replace(/'/g, "\\'") +
                            "')\">";
                        html += '<div style="' + checkboxStyle + '">';
                        if (isChecked) {
                            html +=
                                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                        }
                        html += "</div>";
                        html += '<span style="' + textStyle + '">' + item.text + "</span>";
                        html += "</div>";
                    });

                    html += "</div></div>";
                });

                document.getElementById("grading-checklist-content").innerHTML = html;

                // Update progress
                const percentage =
                    totalItems > 0 ? Math.round((checkedItems / totalItems) * 100) : 0;
                document.getElementById("grading-progress-text").textContent =
                    checkedItems + " / " + totalItems + " (" + percentage + "%)";
                document.getElementById("grading-progress-bar").style.width = percentage + "%";

                if (percentage === 100) {
                    document.getElementById("grading-progress-bar").style.background = "#059669";
                } else {
                    document.getElementById("grading-progress-bar").style.background = "#1e5ba8";
                }
            }

            // Initialize grading checklist when DOM is ready
            document.addEventListener("DOMContentLoaded", function () {
                initGradingChecklist();
            });

            // ==========================================
            // PWA - SERVICE WORKER & OFFLINE SUPPORT
            // ==========================================

            // Register service worker for offline support
            if ("serviceWorker" in navigator) {
                // Create service worker code as a blob
                const swCode = `
                    const CACHE_NAME = 'hakuba-karate-v1';
                    const ASSETS_TO_CACHE = [
                        './',
                        './hakuba-wado-complete-v2.html'
                    ];

                    // Install event - cache assets
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then((cache) => {
                                return cache.addAll(ASSETS_TO_CACHE);
                            })
                        );
                        self.skipWaiting();
                    });

                    // Activate event - clean old caches
                    self.addEventListener('activate', (event) => {
                        event.waitUntil(
                            caches.keys().then((cacheNames) => {
                                return Promise.all(
                                    cacheNames.map((cacheName) => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                        self.clients.claim();
                    });

                    // Fetch event - serve from cache, fallback to network
                    self.addEventListener('fetch', (event) => {
                        // Skip non-GET requests
                        if (event.request.method !== 'GET') return;

                        // Skip external requests (like YouTube, fonts)
                        if (!event.request.url.startsWith(self.location.origin)) {
                            return;
                        }

                        event.respondWith(
                            caches.match(event.request).then((cachedResponse) => {
                                if (cachedResponse) {
                                    // Return cached version and update cache in background
                                    event.waitUntil(
                                        fetch(event.request).then((response) => {
                                            if (response.ok) {
                                                caches.open(CACHE_NAME).then((cache) => {
                                                    cache.put(event.request, response);
                                                });
                                            }
                                        }).catch(() => {})
                                    );
                                    return cachedResponse;
                                }

                                // Not in cache - fetch from network
                                return fetch(event.request).then((response) => {
                                    // Cache successful responses
                                    if (response.ok) {
                                        const responseClone = response.clone();
                                        caches.open(CACHE_NAME).then((cache) => {
                                            cache.put(event.request, responseClone);
                                        });
                                    }
                                    return response;
                                }).catch(() => {
                                    // Offline and not in cache
                                    return new Response('Offline - content not available', {
                                        status: 503,
                                        statusText: 'Service Unavailable'
                                    });
                                });
                            })
                        );
                    });
                `;

                const swBlob = new Blob([swCode], { type: "application/javascript" });
                const swUrl = URL.createObjectURL(swBlob);

                navigator.serviceWorker
                    .register(swUrl, { scope: "./" })
                    .then((registration) => {
                        console.log("Service Worker registered successfully");

                        // Check for updates periodically
                        setInterval(
                            () => {
                                registration.update();
                            },
                            60 * 60 * 1000,
                        ); // Check every hour
                    })
                    .catch((error) => {
                        console.log("Service Worker registration failed:", error);
                    });
            }

            // Show install prompt for PWA
            let deferredPrompt = null;

            window.addEventListener("beforeinstallprompt", (e) => {
                e.preventDefault();
                deferredPrompt = e;

                // Show install button in header
                showInstallButton();
            });

            function showInstallButton() {
                // Check if already installed
                if (window.matchMedia("(display-mode: standalone)").matches) {
                    return;
                }

                const header = document.querySelector("header .container");
                if (header && !document.getElementById("install-btn")) {
                    const installBtn = document.createElement("button");
                    installBtn.id = "install-btn";
                    installBtn.innerHTML = "Install App";
                    installBtn.style.cssText =
                        "position: absolute; right: 2rem; top: 50%; transform: translateY(-50%); background: white; color: #1e5ba8; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; font-size: 0.875rem;";
                    installBtn.onclick = installApp;
                    header.style.position = "relative";
                    header.appendChild(installBtn);
                }
            }

            function installApp() {
                if (!deferredPrompt) return;

                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === "accepted") {
                        console.log("User accepted the install prompt");
                        const installBtn = document.getElementById("install-btn");
                        if (installBtn) installBtn.remove();
                    }
                    deferredPrompt = null;
                });
            }

            // Handle app installed event
            window.addEventListener("appinstalled", () => {
                console.log("App installed successfully");
                const installBtn = document.getElementById("install-btn");
                if (installBtn) installBtn.remove();
                deferredPrompt = null;
            });

            // Detect if running as installed PWA
            if (window.matchMedia("(display-mode: standalone)").matches) {
                console.log("Running as installed PWA");
            }
        </script>
    </body>
</html>
